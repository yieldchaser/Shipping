<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Shipping</title>
<!-- Pirate ship favicon ‚Äî inline SVG as data URI, works in all browsers -->
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='.9em' font-size='90'%3Eüè¥‚Äç‚ò†Ô∏è%3C/text%3E%3C/svg%3E">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  :root {
    --bg: #080c10;
    --card: #0f1318;
    --border: #1e2530;
    --text: #e6edf3;
    --text-muted: #8b949e;
    --accent: #58a6ff;
    --green: #3fb950;
    --red: #f85149;
    --yellow: #e3b341;
    --grid: #151a22;
    --hover: #141920;
  }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
    font-size: 14px;
    line-height: 1.5;
    min-height: 100vh;
  }

  /* HEADER */
  .header {
    background: var(--card);
    border-bottom: 1px solid var(--border);
    padding: 12px 20px;
    display: flex;
    align-items: center;
    gap: 16px;
    flex-wrap: wrap;
    position: sticky;
    top: 0;
    z-index: 100;
  }
  .header h1 {
    font-size: 16px;
    font-weight: 600;
    color: var(--accent);
    white-space: nowrap;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .header h1 span.logo { font-size: 20px; }
  .product-selector {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-left: auto;
  }
  .product-selector label { color: var(--text-muted); font-size: 12px; }
  select {
    background: var(--bg);
    color: var(--text);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 6px 10px;
    font-size: 13px;
    cursor: pointer;
    outline: none;
  }
  select:hover { border-color: var(--accent); }

  /* TABS */
  .tabs-bar {
    background: var(--card);
    border-bottom: 1px solid var(--border);
    padding: 0 20px;
    display: flex;
    overflow-x: auto;
    scrollbar-width: none;
  }
  .tabs-bar::-webkit-scrollbar { display: none; }
  .tab-btn {
    background: none;
    border: none;
    color: var(--text-muted);
    padding: 12px 16px;
    cursor: pointer;
    font-size: 13px;
    font-weight: 500;
    border-bottom: 2px solid transparent;
    white-space: nowrap;
    transition: color 0.15s, border-color 0.15s;
  }
  .tab-btn:hover { color: var(--text); }
  .tab-btn.active { color: var(--accent); border-bottom-color: var(--accent); background: rgba(88, 166, 255, 0.08); border-radius: 4px 4px 0 0; }

  /* MAIN CONTENT */
  .main { padding: 20px; max-width: 1400px; margin: 0 auto; }
  .tab-panel { display: none; }
  .tab-panel.active { display: block; }

  /* LOADING */
  .loading-overlay {
    position: fixed; inset: 0;
    background: rgba(8,12,16,0.95);
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    z-index: 9999;
    gap: 16px;
  }
  .loading-overlay.hidden { display: none; }
  .spinner {
    width: 40px; height: 40px;
    border: 3px solid var(--border);
    border-top-color: var(--accent);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }
  .loading-text { color: var(--text-muted); font-size: 13px; }
  .loading-progress { color: var(--accent); font-size: 12px; }

  /* CARDS */
  .card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 16px;
    transition: border-color 0.15s;
  }
  .card:hover { border-color: #484f58; }
  .card-title {
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: var(--text-muted);
    margin-bottom: 8px;
  }

  /* DASHBOARD TAB */
  .dashboard-hero {
    display: flex;
    align-items: center;
    gap: 24px;
    margin-bottom: 20px;
    flex-wrap: wrap;
  }
  .current-price-block { display: flex; flex-direction: column; gap: 4px; }
  .current-price-label { font-size: 12px; color: var(--text-muted); }
  .current-price-value { font-size: 42px; font-weight: 700; color: var(--text); line-height: 1; }
  .current-price-change { font-size: 14px; font-weight: 500; }
  .change-pos { color: var(--green); }
  .change-neg { color: var(--red); }
  .signal-badge {
    padding: 8px 16px;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 700;
    letter-spacing: 0.3px;
  }
  .signal-sell       { background: rgba(248,81,73,0.25);   color: #f85149; border: 1px solid rgba(248,81,73,0.4); }
  .signal-golden     { background: rgba(255,215,0,0.25);   color: #ffd700; border: 1px solid rgba(255,215,0,0.4); }
  .signal-knife      { background: rgba(255,140,0,0.25);   color: #ff8c00; border: 1px solid rgba(255,140,0,0.4); }
  .signal-trap       { background: rgba(139,148,158,0.25); color: #8b949e; border: 1px solid rgba(139,148,158,0.4); }
  .signal-accumulate { background: rgba(88,166,255,0.25);  color: #58a6ff; border: 1px solid rgba(88,166,255,0.4); }
  .signal-wait       { background: rgba(230,237,243,0.1);  color: #e6edf3; border: 1px solid rgba(230,237,243,0.2); }

  .stats-row {
    display: grid;
    grid-template-columns: repeat(6, 1fr);
    gap: 12px;
    margin-bottom: 20px;
  }
  @media (max-width: 1100px) { .stats-row { grid-template-columns: repeat(3, 1fr); } }
  @media (max-width: 600px)  { .stats-row { grid-template-columns: repeat(2, 1fr); } }

  .stat-card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 14px 16px;
    border-left: 4px solid var(--accent);
  }
  .stat-card.sc-percentile  { border-left-color: #58a6ff; }
  .stat-card.sc-zscore      { border-left-color: #a371f7; }
  .stat-card.sc-drawdown    { border-left-color: #f85149; }
  .stat-card.sc-roc         { border-left-color: #3fb950; }
  .stat-label { font-size: 11px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.4px; margin-bottom: 6px; }
  .stat-value { font-size: 22px; font-weight: 700; }
  .stat-sub { font-size: 11px; color: var(--text-muted); margin-top: 2px; }
  .val-red    { color: var(--red); }
  .val-yellow { color: var(--yellow); }
  .val-green  { color: var(--green); }
  .val-white  { color: var(--text); }
  .val-accent { color: var(--accent); }

  /* CHART CONTAINERS */
  .chart-container {
    position: relative;
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 16px;
  }
  .chart-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
    flex-wrap: wrap;
    gap: 8px;
  }
  .chart-title { font-size: 13px; font-weight: 600; }
  .year-checkboxes { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
  .year-checkbox-item {
    display: flex; align-items: center; gap: 4px;
    font-size: 12px; cursor: pointer; user-select: none;
  }
  .year-checkbox-item input { cursor: pointer; accent-color: var(--accent); }
  .chart-canvas-wrap { height: 320px; position: relative; }

  /* DRAWDOWN CHART */
  .drawdown-chart-wrap { height: 320px; position: relative; }

  /* YEARLY PERFORMANCE TABLE */
  .collapsible-section { margin-top: 20px; }
  .collapsible-toggle {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 10px 16px;
    width: 100%;
    text-align: left;
    color: var(--text);
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: space-between;
    transition: border-color 0.15s;
  }
  .collapsible-toggle:hover { border-color: var(--accent); }
  .collapsible-toggle .toggle-arrow { transition: transform 0.2s; }
  .collapsible-toggle.open .toggle-arrow { transform: rotate(180deg); }
  .collapsible-content { display: none; padding-top: 12px; }
  .collapsible-content.open { display: block; }

  .yearly-table { width: 100%; border-collapse: collapse; font-size: 12px; }
  .yearly-table th {
    background: var(--bg);
    color: var(--text-muted);
    font-weight: 600;
    padding: 7px 10px;
    text-align: right;
    border: 1px solid var(--border);
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 0.3px;
  }
  .yearly-table th:first-child { text-align: left; }
  .yearly-table td {
    padding: 6px 10px;
    text-align: right;
    border: 1px solid var(--grid);
    font-size: 12px;
    font-weight: 500;
    color: var(--text);
  }
  .yearly-table td:first-child { text-align: left; color: var(--text-muted); font-weight: 600; }
  .yearly-table tr:hover td { background: var(--hover); }

  /* CORRELATION MATRIX */
  .corr-section { margin-top: 20px; }
  .corr-title { font-size: 14px; font-weight: 600; margin-bottom: 12px; color: var(--text); }
  .corr-timeframe-btns { display: flex; gap: 8px; margin-bottom: 12px; flex-wrap: wrap; }
  .corr-btn {
    background: var(--bg);
    color: var(--text-muted);
    border: 1px solid var(--border);
    border-radius: 5px;
    padding: 5px 14px;
    font-size: 12px;
    cursor: pointer;
    transition: all 0.15s;
  }
  .corr-btn:hover, .corr-btn.active { border-color: var(--accent); color: var(--accent); background: rgba(88,166,255,0.08); }
  .corr-table { border-collapse: collapse; font-size: 12px; }
  .corr-table th {
    background: var(--bg);
    color: var(--text-muted);
    font-weight: 600;
    padding: 7px 10px;
    text-align: center;
    border: 1px solid var(--border);
    font-size: 11px;
    min-width: 64px;
  }
  .corr-table td {
    padding: 6px 8px;
    text-align: center;
    border: 1px solid var(--border);
    font-size: 12px;
    font-weight: 600;
    min-width: 64px;
    width: 64px;
  }
  .corr-wrap { overflow-x: auto; }

  /* HEATMAPS */
  .heatmap-section { margin-bottom: 28px; }
  .heatmap-title { font-size: 14px; font-weight: 600; margin-bottom: 12px; color: var(--text); }
  .heatmap-wrap { overflow-x: auto; }
  .heatmap-table {
    border-collapse: collapse;
    font-size: 12px;
    min-width: 600px;
  }
  .heatmap-table th {
    background: var(--bg);
    color: var(--text-muted);
    font-weight: 600;
    padding: 7px 10px;
    text-align: center;
    border: 1px solid var(--border);
    white-space: nowrap;
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 0.3px;
  }
  .heatmap-table td {
    padding: 5px 8px;
    text-align: center;
    border: 1px solid var(--grid);
    font-size: 11px;
    font-weight: 500;
    min-width: 72px;
    white-space: nowrap;
    line-height: 1.4;
  }
  .heatmap-table .year-col {
    background: var(--bg);
    color: var(--text-muted);
    font-weight: 600;
    padding: 6px 10px;
    text-align: right;
    font-size: 12px;
  }
  .heatmap-abs-val { font-size: 12px; font-weight: 600; display: block; }
  .heatmap-pct-val { font-size: 10px; display: block; opacity: 0.85; }

  /* HEATMAP VIEW SELECTOR */
  .heatmap-view-row {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 18px;
    flex-wrap: wrap;
  }
  .heatmap-view-row label { color: var(--text-muted); font-size: 12px; font-weight: 600; }

  /* INDICES TAB */
  .indices-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 16px;
  }
  @media (max-width: 900px) { .indices-grid { grid-template-columns: 1fr; } }
  .index-chart-card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 16px;
  }
  .index-chart-header { margin-bottom: 10px; }
  .index-chart-title { font-size: 13px; font-weight: 700; margin-bottom: 2px; }
  .index-chart-subtitle { font-size: 12px; color: var(--text-muted); display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
  .index-chart-canvas-wrap { height: 200px; position: relative; }
  .toggle-btn {
    background: var(--bg);
    color: var(--text-muted);
    border: 1px solid var(--border);
    border-radius: 5px;
    padding: 3px 8px;
    font-size: 11px;
    cursor: pointer;
    transition: all 0.15s;
  }
  .toggle-btn:hover, .toggle-btn.active { border-color: var(--accent); color: var(--accent); }

  /* INDEX STATS STRIP */
  .index-stats-strip {
    display: flex;
    gap: 0;
    margin-top: 10px;
    border: 1px solid var(--border);
    border-radius: 6px;
    overflow: hidden;
  }
  .index-stat-mini {
    flex: 1;
    padding: 7px 10px;
    border-right: 1px solid var(--border);
    background: var(--bg);
    min-width: 0;
  }
  .index-stat-mini:last-child { border-right: none; }
  .index-stat-mini-label { font-size: 9px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.3px; margin-bottom: 3px; white-space: nowrap; }
  .index-stat-mini-val { font-size: 12px; font-weight: 700; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

  /* ETF TAB */
  .etf-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 20px;
  }
  @media (max-width: 900px) { .etf-grid { grid-template-columns: 1fr; } }
  .etf-card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 20px;
    display: flex;
    flex-direction: column;
  }
  .etf-holdings-section {
    flex: none;
  }
  .etf-holdings-section .holdings-table tbody {
    display: block;
    max-height: 320px;
    overflow-y: auto;
  }
  .etf-holdings-section .holdings-table thead,
  .etf-holdings-section .holdings-table tbody tr {
    display: table;
    width: 100%;
    table-layout: fixed;
  }
  .etf-header { margin-bottom: 16px; }
  .etf-ticker { font-size: 24px; font-weight: 800; color: var(--accent); }
  .etf-name { font-size: 12px; color: var(--text-muted); margin-bottom: 8px; }
  .etf-price-row { display: flex; align-items: baseline; gap: 10px; }
  .etf-price { font-size: 28px; font-weight: 700; }
  .etf-change { font-size: 14px; font-weight: 600; }
  .etf-section-title-row {
    display: flex; align-items: center; justify-content: space-between;
    margin: 16px 0 8px;
  }
  .etf-section-title { font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-muted); }
  .holdings-table { width: 100%; border-collapse: collapse; font-size: 12px; }
  .holdings-table th {
    color: var(--text-muted); font-size: 10px; text-transform: uppercase; letter-spacing: 0.3px;
    padding: 6px 8px; text-align: right; border-bottom: 1px solid var(--border);
    font-weight: 600;
  }
  .holdings-table th:first-child { text-align: left; }
  .holdings-table td {
    padding: 6px 8px; border-bottom: 1px solid var(--grid); text-align: right; color: var(--text);
  }
  .holdings-table td:first-child { text-align: left; color: var(--text-muted); }
  .holdings-table tr:last-child td { border-bottom: none; }
  .holdings-table tr:hover td { background: var(--hover); }
  .row-cape { color: #58a6ff !important; }
  .row-pana { color: #3fb950 !important; }
  .row-supra { color: #d29922 !important; }
  .row-td3c { color: #f0883e !important; }
  .row-td20 { color: #a371f7 !important; }
  .row-cash { color: var(--text-muted) !important; }
  .donut-wrap { height: 200px; position: relative; margin-top: 8px; }
  .etf-metrics { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 16px; }
  .etf-metric { background: var(--bg); border-radius: 6px; padding: 10px 12px; border: 1px solid var(--border); }
  .etf-metric-label { font-size: 10px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.3px; margin-bottom: 4px; }
  .etf-metric-value { font-size: 15px; font-weight: 700; color: var(--text); }

  /* ETF Research Links */
  .etf-research-section { margin-top: auto; padding-top: 16px; border-top: 1px solid var(--border); }
  .etf-research-title { font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-muted); margin-bottom: 10px; }
  .research-group { margin-bottom: 12px; }
  .research-group:last-child { margin-bottom: 0; }
  .research-group-label { font-size: 10px; font-weight: 700; color: var(--accent); text-transform: uppercase; letter-spacing: 0.4px; margin-bottom: 5px; }
  .research-link { display: flex; align-items: flex-start; gap: 6px; padding: 5px 0; border-bottom: 1px solid var(--grid); }
  .research-link:last-child { border-bottom: none; }
  .research-link a { color: var(--text); font-size: 12px; text-decoration: none; transition: color 0.15s; word-break: break-word; }
  .research-link a:hover { color: var(--accent); text-decoration: underline; }
  .research-link-icon { font-size: 12px; flex-shrink: 0; margin-top: 1px; }
  /* Fundamentals section */
  .etf-fundamentals-section { margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border); }
  .etf-fund-group { margin-bottom: 14px; }
  .etf-fund-group-label { font-size: 10px; font-weight: 700; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.4px; margin-bottom: 5px; }
  .etf-fund-link { display: flex; align-items: flex-start; gap: 6px; padding: 4px 0; }
  .etf-fund-link a { color: var(--text); font-size: 12px; text-decoration: none; transition: color 0.15s; }
  .etf-fund-link a:hover { color: var(--accent); text-decoration: underline; }
  /* ETF image block: image left, legend right */
  .etf-image-block { display: grid; grid-template-columns: 1fr auto; gap: 12px; align-items: start; margin-top: 16px; }
  .etf-card-image { width: 100%; border-radius: 6px; border: 1px solid var(--border); object-fit: cover; height: 220px; display: block; }
  .etf-map-legend { display: flex; flex-direction: column; gap: 5px; padding: 8px 10px; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; width: 160px; min-width: 160px; max-width: 160px; height: 220px; box-sizing: border-box; justify-content: center; }
  .etf-legend-item { display: flex; align-items: flex-start; gap: 6px; font-size: 10.5px; color: var(--text-muted); white-space: normal; line-height: 1.35; }
  .etf-legend-dot { font-size: 13px; flex-shrink: 0; line-height: 1; }
  .etf-legend-line { display: flex; align-items: center; gap: 7px; font-size: 11px; color: var(--text-muted); }
  .etf-legend-dash { width: 18px; height: 2px; background: var(--text-muted); flex-shrink: 0; border-radius: 1px; }
  .etf-legend-sep { height: 1px; background: var(--border); margin: 2px 0; }
  @media (max-width: 600px) { .etf-image-block { grid-template-columns: 1fr; } .etf-map-legend { max-width: 100%; height: auto; flex-direction: row; flex-wrap: wrap; } }
  /* Routes section */
  .etf-routes-section { margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border); }
  .etf-routes-title { font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-muted); margin-bottom: 10px; }
  .etf-route-item { display: flex; align-items: flex-start; gap: 8px; padding: 7px 0; border-bottom: 1px solid var(--grid); font-size: 12px; }
  .etf-route-item:last-child { border-bottom: none; }
  .etf-route-code { font-weight: 700; color: var(--accent); min-width: 42px; flex-shrink: 0; }
  .etf-route-desc { color: var(--text-muted); }

  /* QUARTERLY TAB */
  .win-rate-row {
    display: flex;
    gap: 12px;
    margin-bottom: 20px;
    flex-wrap: wrap;
  }
  .win-rate-card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 12px 18px;
    flex: 1;
    min-width: 110px;
    border-left: 4px solid var(--accent);
  }
  .win-rate-card.wr-green  { border-left-color: var(--green); }
  .win-rate-card.wr-yellow { border-left-color: var(--yellow); }
  .win-rate-card.wr-red    { border-left-color: var(--red); }
  .win-rate-label { font-size: 11px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.4px; margin-bottom: 4px; }
  .win-rate-value { font-size: 22px; font-weight: 700; }
  .win-rate-bar-wrap { height: 4px; background: var(--border); border-radius: 2px; margin-top: 6px; overflow: hidden; }
  .win-rate-bar { height: 100%; border-radius: 2px; }
  .spaghetti-wrap { height: 280px; position: relative; }

  /* DOWNLOAD BUTTON */
  .dl-btn {
    background: var(--bg);
    color: var(--text-muted);
    border: 1px solid var(--border);
    border-radius: 5px;
    padding: 4px 10px;
    font-size: 11px;
    cursor: pointer;
    transition: all 0.15s;
    white-space: nowrap;
  }
  .dl-btn:hover { border-color: var(--accent); color: var(--accent); }

  /* SECTION ERRORS */
  .error-msg {
    background: rgba(248,81,73,0.1);
    border: 1px solid rgba(248,81,73,0.3);
    border-radius: 6px;
    padding: 12px 16px;
    color: var(--red);
    font-size: 13px;
    margin: 8px 0;
  }

  /* SCROLLBAR */
  ::-webkit-scrollbar { width: 6px; height: 6px; }
  ::-webkit-scrollbar-track { background: var(--bg); }
  ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
  ::-webkit-scrollbar-thumb:hover { background: #484f58; }

  /* UTILITY */
  .mb-12 { margin-bottom: 12px; }
  .mb-20 { margin-bottom: 20px; }
  .flex-row { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
  .text-muted { color: var(--text-muted); }
  .text-accent { color: var(--accent); }
  .updated-at { font-size: 11px; color: var(--text-muted); margin-left: auto; }

  /* SECTION TITLE (unified) */
  .section-title {
    font-size: 1.1rem;
    font-weight: 600;
    color: var(--accent);
    border-bottom: 1px solid var(--border);
    padding-bottom: 6px;
    margin-bottom: 16px;
    margin-top: 0;
    letter-spacing: 0.3px;
  }

  /* CHART SECTION */
  .chart-section {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 24px;
  }
  .chart-header-title {
    font-size: 13px;
    font-weight: 600;
    color: var(--text);
  }

  /* ALERTS BANNER */
  .alerts-container {
    padding: 0 20px;
    margin-top: 10px;
    display: flex;
    flex-direction: column;
    gap: 8px;
  }
  .alert-box {
    padding: 12px 16px;
    border-radius: 6px;
    font-size: 13px;
    font-weight: 600;
    display: none;
  }
  .alert-bullish {
    background: rgba(63, 185, 80, 0.1);
    border: 1px solid rgba(63, 185, 80, 0.4);
    color: var(--green);
  }
  .alert-bearish {
    background: rgba(248, 81, 73, 0.1);
    border: 1px solid rgba(248, 81, 73, 0.4);
    color: var(--red);
  }

  /* LIVE DOT */
  .live-dot {
    color: var(--text-muted);
    font-size: 10px;
    margin-right: 5px;
    animation: none;
  }
  .live-dot.active {
    color: var(--green);
    animation: pulse-dot 2s infinite;
  }
  @keyframes pulse-dot {
    0%, 100% { opacity: 1; }
    50%       { opacity: 0.3; }
  }

  /* CONTEXT STRIP */
  .context-strip {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 12px;
    margin-bottom: 24px;
  }
  .context-card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 14px 16px;
    text-align: center;
  }
  .context-label {
    font-size: 11px;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.4px;
    margin-bottom: 6px;
  }
  .context-value {
    font-size: 20px;
    font-weight: 700;
    color: var(--text);
  }

  /* CARD HEADER BAR */
  .card-header-bar {
    background: rgba(88, 166, 255, 0.07);
    border-bottom: 1px solid var(--border);
    padding: 10px 14px;
    margin: -16px -16px 14px -16px;
    border-radius: 8px 8px 0 0;
    font-size: 13px;
    font-weight: 700;
    color: var(--accent);
  }

  /* INDEX DATE RANGE SLIDER */
  .index-range-wrap {
    margin-top: 10px;
    padding: 4px 0 2px;
  }
  .index-range-label {
    font-size: 11px;
    color: var(--text-muted);
    margin-bottom: 6px;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .index-range-label span { color: var(--accent); font-weight: 600; }
  .dual-range-track {
    position: relative;
    height: 4px;
    background: var(--border);
    border-radius: 2px;
    margin: 8px 0 4px;
  }
  .dual-range-track input[type=range] {
    position: absolute;
    width: 100%;
    height: 4px;
    background: transparent;
    appearance: none;
    -webkit-appearance: none;
    pointer-events: none;
    top: 0; left: 0;
    margin: 0; padding: 0;
    outline: none;
    border: none;
  }
  .dual-range-track input[type=range]::-webkit-slider-thumb {
    appearance: none;
    -webkit-appearance: none;
    width: 14px; height: 14px;
    border-radius: 50%;
    background: var(--accent);
    border: 2px solid var(--bg);
    cursor: pointer;
    pointer-events: all;
    position: relative;
    z-index: 2;
  }
  .dual-range-track input[type=range]::-moz-range-thumb {
    width: 14px; height: 14px;
    border-radius: 50%;
    background: var(--accent);
    border: 2px solid var(--bg);
    cursor: pointer;
    pointer-events: all;
  }
  .dual-range-fill {
    position: absolute;
    height: 4px;
    background: var(--accent);
    border-radius: 2px;
    top: 0;
    pointer-events: none;
  }
</style>
</head>
<body>

<!-- LOADING OVERLAY -->
<div class="loading-overlay" id="loadingOverlay">
  <div class="spinner"></div>
  <div class="loading-text">Loading shipping market data‚Ä¶</div>
  <div class="loading-progress" id="loadingProgress">Fetching CSVs (0/8)</div>
</div>

<!-- HEADER -->
<div class="header">
  <h1><span class="logo">üè¥‚Äç‚ò†Ô∏è</span> Shipping</h1>
  <div class="product-selector">
    <label for="globalProduct">Index:</label>
    <select id="globalProduct">
      <option value="bdiy">Baltic Dry Index (BDI)</option>
      <option value="cape">Capesize</option>
      <option value="panama">Panamax</option>
      <option value="suprama">Supramax</option>
      <option value="cleantanker">Clean Tanker (BCTI)</option>
      <option value="dirtytanker">Dirty Tanker (BDTI)</option>
      <option value="bdry_spot">BDRY Spot Composite</option>
    </select>
  </div>
  <div class="updated-at" id="updatedAt"><span class="live-dot" id="liveDot">‚óè</span><span id="updatedAtText"></span></div>
</div>

<!-- TABS BAR -->
<div class="tabs-bar">
  <button class="tab-btn active" data-tab="dashboard">üìä Dashboard</button>
  <button class="tab-btn" data-tab="yearly-dash">üìÖ Yearly</button>
  <button class="tab-btn" data-tab="monthly-dash">üìÜ Monthly</button>
  <button class="tab-btn" data-tab="quarterly">üìä Quarterly</button>
  <button class="tab-btn" data-tab="heatmaps">üå°Ô∏è Heatmaps</button>
  <button class="tab-btn" data-tab="indices">üìà Indices</button>
  <button class="tab-btn" data-tab="etfs">üè¶ ETFs</button>
  <button class="tab-btn" data-tab="signals">üéØ Signals</button>
</div>

<!-- HENRY AVERY QUOTE BANNER -->
<div style="
  background: linear-gradient(90deg, rgba(240,192,64,0.07) 0%, rgba(240,192,64,0.03) 50%, rgba(240,192,64,0.07) 100%);
  border-bottom: 1px solid rgba(240,192,64,0.18);
  padding: 7px 20px;
  display: flex;
  align-items: center;
  gap: 10px;
  font-size: 12px;
  color: rgba(240,192,64,0.75);
  font-style: italic;
  letter-spacing: 0.2px;
  user-select: none;
">
  <span style="font-size:15px;filter:grayscale(0.2);">üè¥‚Äç‚ò†Ô∏è</span>
  <span>&ldquo;I am a Man of Fortune, and I must seek my Fortune.&rdquo;</span>
  <span style="font-style:normal;font-size:11px;color:rgba(240,192,64,0.45);margin-left:4px;">‚Äî Henry Avery, 1694</span>
</div>

<div class="alerts-container" id="alertsContainer">
  <div id="alertBullish" class="alert-box alert-bullish">
    üöÄ BULLISH SIGNAL: <span id="alertBullishText"></span>
  </div>
  <div id="alertBearish" class="alert-box alert-bearish">
    üö® BEARISH SIGNAL: <span id="alertBearishText"></span>
  </div>
</div>

<!-- MAIN CONTENT -->
<div class="main">

  <!-- ===== TAB: DASHBOARD ===== -->
  <div class="tab-panel active" id="tab-dashboard">
    <div class="dashboard-hero mb-20">
      <div class="current-price-block">
        <div class="current-price-label" id="dashProductLabel">Baltic Dry Index (BDI)</div>
        <div class="current-price-value" id="dashCurrentPrice">‚Äî</div>
        <div class="current-price-change" id="dashPriceChange">‚Äî</div>
      </div>
      <div id="dashSignal" class="signal-badge signal-wait">‚è≥ WAIT</div>
    </div>

    <div class="stats-row mb-20">
      <div class="stat-card sc-percentile">
        <div class="stat-label">All-Time Pctl</div>
        <div class="stat-value" id="statAlltime">‚Äî</div>
        <div class="stat-sub">vs full history</div>
      </div>
      <div class="stat-card sc-percentile">
        <div class="stat-label">10Y Percentile</div>
        <div class="stat-value" id="stat10y">‚Äî</div>
        <div class="stat-sub">last 10 years</div>
      </div>
      <div class="stat-card sc-percentile">
        <div class="stat-label">5Y Percentile</div>
        <div class="stat-value" id="stat5y">‚Äî</div>
        <div class="stat-sub">last 5 years</div>
      </div>
      <div class="stat-card sc-zscore">
        <div class="stat-label">Z-Score</div>
        <div class="stat-value" id="statZscore">‚Äî</div>
        <div class="stat-sub">vs same trading day</div>
      </div>
      <div class="stat-card sc-drawdown">
        <div class="stat-label">52-Week Drawdown</div>
        <div class="stat-value" id="statDrawdown">‚Äî</div>
        <div class="stat-sub">from 52-week high</div>
      </div>
      <div class="stat-card sc-roc">
        <div class="stat-label">Rate of Change (20d)</div>
        <div class="stat-value" id="statRoc20">‚Äî</div>
        <div class="stat-sub">20-day % change</div>
      </div>
    </div>

    <!-- Historical Context Strip -->
    <div class="context-strip" id="contextStrip">
      <div class="context-card">
        <div class="context-label">5Y Average</div>
        <div class="context-value" id="ctx5yAvg">‚Äî</div>
      </div>
      <div class="context-card">
        <div class="context-label">vs 5Y Avg</div>
        <div class="context-value" id="ctx5yDev">‚Äî</div>
      </div>
      <div class="context-card">
        <div class="context-label">vs 10Y Avg</div>
        <div class="context-value" id="ctx10yDev">‚Äî</div>
      </div>
    </div>

    <!-- Overlay Chart -->
    <div class="chart-container mb-20">
      <div class="chart-header">
        <div class="chart-title">Current Year vs Historical Years</div>
        <div class="year-checkboxes" id="yearCheckboxes"></div>
      </div>
      <div class="chart-canvas-wrap">
        <canvas id="overlayChart"></canvas>
      </div>
    </div>

    <!-- Drawdown Chart -->
    <div class="chart-container mb-20">
      <div class="chart-header">
        <div class="chart-title">Drawdown from 52-Week High</div>
      </div>
      <div class="drawdown-chart-wrap">
        <canvas id="drawdownChart"></canvas>
      </div>
    </div>

    <!-- Recent Daily Changes -->
    <div class="chart-section">
      <div class="chart-header">
        <div class="chart-header-title">Recent Daily Changes</div>
        <button class="dl-btn" id="recentDlBtn">‚¨á CSV</button>
      </div>
      <div style="overflow-x:auto">
        <div id="recentChangesTable"></div>
      </div>
    </div>

    <!-- Yearly Performance Table -->
    <div class="collapsible-section mb-20">
      <button class="collapsible-toggle" id="yearlyPerfToggle" onclick="toggleYearlyPerf()">
        <span>Yearly Performance Table</span>
        <span class="toggle-arrow">‚ñº</span>
      </button>
      <div class="collapsible-content" id="yearlyPerfContent">
        <div class="flex-row mb-12" style="padding-top:4px">
          <button class="dl-btn" id="yearlyDlBtn">‚¨á Download CSV</button>
        </div>
        <div style="overflow-x:auto">
          <div id="yearlyPerfTable"></div>
        </div>
      </div>
    </div>

    <!-- Correlation Matrix -->
    <div class="corr-section mb-20">
      <div class="section-title">Index Correlation Matrix</div>
      <div class="corr-timeframe-btns">
        <button class="corr-btn active" data-corr="all" onclick="setCorrTimeframe(this,'all')">All Time</button>
        <button class="corr-btn" data-corr="5y" onclick="setCorrTimeframe(this,'5y')">Last 5Y</button>
        <button class="corr-btn" data-corr="1y" onclick="setCorrTimeframe(this,'1y')">Last 1Y</button>
      </div>
      <div class="corr-wrap">
        <div id="corrMatrix"></div>
      </div>
    </div>

    <!-- Signal Methodology -->
    <div class="collapsible-section">
      <button class="collapsible-toggle" id="methodologyToggle" onclick="toggleMethodology()">
        <span>‚ÑπÔ∏è How Signals &amp; Statistics Are Calculated</span>
        <span class="toggle-arrow">‚ñº</span>
      </button>
      <div class="collapsible-content" id="methodologyContent">
        <div style="padding: 16px 4px; font-size: 13px; line-height: 1.8; color: var(--text-muted);">
          <p style="margin-bottom:12px"><strong style="color:var(--text)">Percentile Ranks (All-Time, 10Y, 5Y):</strong> The current index value is ranked against all historical daily values within the respective lookback window. A percentile of 80 means the index is currently higher than 80% of all daily readings in that period.</p>
          <p style="margin-bottom:12px"><strong style="color:var(--text)">Z-Score:</strong> Computed as <code style="background:var(--bg);padding:2px 5px;border-radius:3px;color:var(--accent)">(current value ‚àí mean of same calendar trading day across all years) / standard deviation</code>. Values above +2 or below ‚àí2 indicate statistically unusual levels relative to seasonal norms.</p>
          <p style="margin-bottom:12px"><strong style="color:var(--text)">Rate of Change (ROC):</strong> The percentage change in the index over a rolling 20-trading-day window, indicating short-term momentum.</p>
          <p style="margin-bottom:12px"><strong style="color:var(--text)">Max Drawdown:</strong> The maximum percentage decline from any peak to subsequent trough within the selected lookback window.</p>
          <p style="margin-bottom:0"><strong style="color:var(--text)">Algorithmic Signal:</strong> The signal badge is derived from a combination of Z-score level, percentile rank, and recent rate of change. <em>GOLDEN DIP</em> and <em>ACCUMULATE</em> indicate statistically low or improving conditions; <em>SELL</em> and <em>CATCHING KNIFE</em> indicate elevated or rapidly deteriorating conditions; <em>WAIT</em> and <em>VALUE TRAP</em> indicate ambiguous or transitioning conditions.</p>
        </div>
      </div>
    </div>
  </div>

  <!-- ===== TAB: HEATMAPS ===== -->
  <div class="tab-panel" id="tab-heatmaps">
    <div class="heatmap-view-row">
      <label for="heatmapViewSelect">Heatmap View:</label>
      <select id="heatmapViewSelect" onchange="onHeatmapViewChange()">
        <option value="absolute">Absolute Values</option>
        <option value="pct">% Change (MoM/QoQ)</option>
      </select>
    </div>

    <div class="heatmap-section mb-20">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;flex-wrap:wrap;gap:8px;">
        <div class="section-title" style="margin-bottom:0">Monthly Heatmap</div>
        <button class="dl-btn" id="monthlyHeatmapDlBtn">‚¨á Download CSV</button>
      </div>
      <div class="heatmap-wrap">
        <div id="monthlyHeatmap"></div>
      </div>
    </div>

    <div class="heatmap-section mb-20">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;flex-wrap:wrap;gap:8px;">
        <div class="section-title" style="margin-bottom:0">Monthly Absolute Values</div>
      </div>
      <div class="heatmap-wrap">
        <div id="monthlyAbsHeatmap"></div>
      </div>
    </div>
  </div>

  <!-- ===== TAB: QUARTERLY ===== -->
  <div class="tab-panel" id="tab-quarterly">
    <!-- Win-Rate KPI Cards -->
    <div class="win-rate-row mb-20" id="winRateRow"></div>

    <!-- Download CSV -->
    <div class="flex-row mb-12">
      <button class="dl-btn" id="quarterlyDlBtn">‚¨á Download CSV</button>
    </div>

    <!-- Quarterly Heatmap -->
    <div class="heatmap-section mb-20">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;flex-wrap:wrap;gap:8px;">
        <div class="section-title" style="margin-bottom:0">Quarterly Heatmap</div>
        <button class="dl-btn" id="quarterlyHeatmapDlBtn">‚¨á Download CSV</button>
      </div>
      <div class="heatmap-wrap">
        <div id="quarterlyHeatmap"></div>
      </div>
    </div>

    <!-- Spaghetti Chart -->
    <div class="chart-container mb-20">
      <div class="chart-header">
        <div class="chart-title">Quarterly Performance by Year (Spaghetti)</div>
      </div>
      <div class="spaghetti-wrap">
        <canvas id="spaghettiChart"></canvas>
      </div>
    </div>

    <!-- Quarterly Area Comparison 1 -->
    <div class="chart-container mb-20">
      <div class="chart-header"><div class="chart-title">Quarterly Area Comparison &mdash; Current vs Prior Year</div></div>
      <div class="chart-canvas-wrap" style="height:300px"><canvas id="quarterlyAreaComp1Chart"></canvas></div>
    </div>

    <!-- Quarterly Trend -->
    <div class="chart-container mb-20">
      <div class="chart-header"><div class="chart-title">Quarterly Trend (Last 5 Years)</div></div>
      <div class="chart-canvas-wrap" style="height:300px"><canvas id="quarterlyTrendChart"></canvas></div>
    </div>

    <!-- Quarterly Bar Chart -->
    <div class="chart-container mb-20">
      <div class="chart-header"><div class="chart-title">Quarterly Bar Chart (Last 4 Quarters, QoQ Color)</div></div>
      <div class="chart-canvas-wrap" style="height:300px"><canvas id="quarterlyBarChart"></canvas></div>
    </div>

    <!-- Quarterly Area Comparison 2 -->
    <div class="chart-container mb-20">
      <div class="chart-header"><div class="chart-title">Quarterly Area Comparison &mdash; Current Year vs 5Y Seasonal Avg</div></div>
      <div class="chart-canvas-wrap" style="height:300px"><canvas id="quarterlyAreaComp2Chart"></canvas></div>
    </div>

    <!-- Quarterly Data Grid -->
    <div class="chart-section">
      <div class="chart-header">
        <div class="chart-header-title">Quarterly Data Grid (Last 8 Years)</div>
        <button class="dl-btn" id="quarterlyDashGridDlBtn">&#x2B07; CSV</button>
      </div>
      <div style="overflow-x:auto"><div id="quarterlyDashDataGrid"></div></div>
    </div>
  </div>

  <!-- ===== TAB: INDICES ===== -->
  <div class="tab-panel" id="tab-indices">
    <div class="indices-grid" id="indicesGrid"></div>
  </div>

  <!-- ===== TAB: ETFs ===== -->
   <div class="tab-panel" id="tab-etfs">
     <div class="etf-grid" id="etfGrid"></div>

     <!-- BDRY Liquidity Tracker -->
     <div class="chart-container mb-20" id="bdryLiqSection" style="margin-top:24px;">
       <div class="chart-header">
         <div class="chart-title">BDRY ‚Äî Liquidity Tracker</div>
         <div class="flex-row" style="gap:6px;align-items:center;">
           <button class="dl-btn" id="bdryLiqDlBtn">‚¨á CSV</button>
         </div>
       </div>

       <!-- Today's stats strip -->
       <div id="bdryLiqKpi" style="display:flex;flex-wrap:wrap;gap:10px;margin:14px 0 18px;"></div>

       <!-- Safe Liquidity chart + dual range slider -->
       <div style="font-size:11px;font-weight:600;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.4px;margin-bottom:6px;">Safe Liquidity ($ per Day)</div>
       <div class="index-range-wrap" style="padding:2px 0 6px;">
         <div class="index-range-label">
           <span>Range:</span>
           <span id="bdryLiqRangeLabel">Loading‚Ä¶</span>
         </div>
         <div class="dual-range-track" id="bdryLiqRangeTrack">
           <div class="dual-range-fill" id="bdryLiqRangeFill"></div>
           <input type="range" id="bdryLiqRangeStart" min="0" max="100" value="0" step="1">
           <input type="range" id="bdryLiqRangeEnd"   min="0" max="100" value="100" step="1">
         </div>
       </div>
       <div class="chart-canvas-wrap" style="height:220px;margin-bottom:20px;"><canvas id="bdryLiqChart"></canvas></div>

       <!-- Volume with tier threshold lines (synced to same range slider) -->
       <div style="font-size:11px;font-weight:600;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.4px;margin-bottom:6px;">Daily Volume &amp; Tier Thresholds</div>
       <div class="chart-canvas-wrap" style="height:200px;margin-bottom:28px;"><canvas id="bdryVolChart"></canvas></div>

       <!-- Avg Volume & $ Value by rolling window ‚Äî always uses full dataset -->
       <div style="font-size:11px;font-weight:600;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.4px;margin-bottom:6px;">Avg Volume &amp; Dollar Value ‚Äî Rolling Windows</div>
       <div class="chart-canvas-wrap" style="height:260px;margin-bottom:20px;"><canvas id="bdryAvgChart"></canvas></div>

       <!-- Data table -->
       <div style="font-size:11px;font-weight:600;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.4px;margin-bottom:8px;">Daily Breakdown</div>
       <div id="bdryLiqLoading" style="color:var(--text-muted);font-size:13px;padding:12px 0;">Loading BDRY market data‚Ä¶</div>
       <div style="overflow-x:auto;max-height:420px;overflow-y:auto;" id="bdryLiqTableWrap">
         <div id="bdryLiqTable"></div>
       </div>
     </div>
   </div>


  <!-- ===== TAB: YEARLY DASHBOARD ===== -->
  <div class="tab-panel" id="tab-yearly-dash">
    <div id="yd-kpi-row" class="dashboard-hero mb-20"></div>
    <div class="chart-container mb-20">
      <div class="chart-header">
        <div class="chart-title">Historical Price</div>
        <div class="flex-row" style="gap:6px;flex-wrap:wrap;align-items:center;">
          <button class="toggle-btn active" id="ydAvgBtn5"  onclick="setYDHistAvg(5)">5Y Avg</button>
          <button class="toggle-btn"        id="ydAvgBtn10" onclick="setYDHistAvg(10)">10Y Avg</button>
          <button class="toggle-btn"        id="ydAvgBtnAll" onclick="setYDHistAvg(0)">All-Time Avg</button>
          <button class="dl-btn" id="ydHistDlBtn">&#x2B07; CSV</button>
        </div>
      </div>
      <div class="index-range-wrap" style="padding: 2px 0 6px;">
        <div class="index-range-label">
          <span>Range:</span>
          <span id="ydHistRangeLabel">Loading‚Ä¶</span>
        </div>
        <div class="dual-range-track" id="ydHistRangeTrack">
          <div class="dual-range-fill" id="ydHistRangeFill"></div>
          <input type="range" id="ydHistRangeStart" min="0" max="100" value="0" step="1">
          <input type="range" id="ydHistRangeEnd"   min="0" max="100" value="100" step="1">
        </div>
      </div>
      <div class="chart-canvas-wrap" style="height:320px"><canvas id="yearlyHistChart"></canvas></div>
    </div>
    <div class="chart-container mb-20">
      <div class="chart-header">
        <div class="chart-title" id="ydZscoreTitle">Z-Score (Rolling 252-Day)</div>
        <div class="flex-row" style="gap:6px;align-items:center;">
          <button class="toggle-btn" id="ydZscoreBtn63"  onclick="setYDZscoreWindow(63)">3M</button>
          <button class="toggle-btn" id="ydZscoreBtn126" onclick="setYDZscoreWindow(126)">6M</button>
          <button class="toggle-btn active" id="ydZscoreBtn252" onclick="setYDZscoreWindow(252)">1Y</button>
          <button class="toggle-btn" id="ydZscoreBtn504" onclick="setYDZscoreWindow(504)">2Y</button>
          <button class="toggle-btn" id="ydZscoreBtn756" onclick="setYDZscoreWindow(756)">3Y</button>
        </div>
      </div>
      <div class="index-range-wrap" style="padding: 2px 0 6px;">
        <div class="index-range-label">
          <span>Range:</span>
          <span id="ydZscoreRangeLabel">Loading‚Ä¶</span>
        </div>
        <div class="dual-range-track" id="ydZscoreRangeTrack">
          <div class="dual-range-fill" id="ydZscoreRangeFill"></div>
          <input type="range" id="ydZscoreRangeStart" min="0" max="100" value="0" step="1">
          <input type="range" id="ydZscoreRangeEnd"   min="0" max="100" value="100" step="1">
        </div>
      </div>
      <div class="chart-canvas-wrap" style="height:300px"><canvas id="yearlyZscoreChart"></canvas></div>
    </div>
    <div class="chart-container mb-20">
      <div class="chart-header"><div class="chart-title">Historical Z-Score (All Time from 2008)</div></div>
      <div class="index-range-wrap" style="padding: 2px 0 6px;">
        <div class="index-range-label">
          <span>Range:</span>
          <span id="ydHistZscoreRangeLabel">Loading‚Ä¶</span>
        </div>
        <div class="dual-range-track" id="ydHistZscoreRangeTrack">
          <div class="dual-range-fill" id="ydHistZscoreRangeFill"></div>
          <input type="range" id="ydHistZscoreRangeStart" min="0" max="100" value="0" step="1">
          <input type="range" id="ydHistZscoreRangeEnd"   min="0" max="100" value="100" step="1">
        </div>
      </div>
      <div class="chart-canvas-wrap" style="height:300px"><canvas id="yearlyHistZscoreChart"></canvas></div>
    </div>
    <div class="chart-container mb-20">
      <div class="chart-header"><div class="chart-title">Multi-Year Rates (Annual Averages by Product)</div></div>
      <div class="chart-canvas-wrap" style="height:300px"><canvas id="yearlyMultiRatesChart"></canvas></div>
    </div>
    <div class="chart-container mb-20">
      <div class="chart-header"><div class="chart-title">Shipping Rates &mdash; Current Year Monthly Bar</div></div>
      <div class="chart-canvas-wrap" style="height:300px"><canvas id="yearlyShippingRatesChart"></canvas></div>
    </div>
    <div class="chart-container mb-20">
      <div class="chart-header"><div class="chart-title">Rates &mdash; All Products Multi-Year Overlay</div></div>
      <div class="chart-canvas-wrap" style="height:320px"><canvas id="yearlyRatesChart"></canvas></div>
    </div>
    <div class="chart-container mb-20">
      <div class="chart-header"><div class="chart-title">Drawdown % (52-Week Rolling, Last 5 Years)</div></div>
      <div class="chart-canvas-wrap" style="height:300px"><canvas id="yearlyDrawdownChart"></canvas></div>
    </div>
  </div>

  <!-- ===== TAB: MONTHLY DASHBOARD ===== -->
  <div class="tab-panel" id="tab-monthly-dash">
    <div class="chart-container mb-20">
      <div class="chart-header"><div class="chart-title">Monthly Bar Chart (Last 12 Months)</div></div>
      <div class="chart-canvas-wrap" style="height:300px"><canvas id="monthlyBarChart"></canvas></div>
    </div>
    <div class="chart-container mb-20">
      <div class="chart-header"><div class="chart-title">Monthly Trend (Last 3 Years)</div></div>
      <div class="chart-canvas-wrap" style="height:300px"><canvas id="monthlyTrendChart"></canvas></div>
    </div>
    <div class="chart-container mb-20">
      <div class="chart-header"><div class="chart-title">Monthly Area Comparison &mdash; Current vs Prior Year</div></div>
      <div class="chart-canvas-wrap" style="height:300px"><canvas id="monthlyAreaCompChart"></canvas></div>
    </div>
    <div class="chart-section">
      <div class="chart-header">
        <div class="chart-header-title">Monthly Data Grid</div>
        <button class="dl-btn" id="monthlyGridDlBtn">&#x2B07; CSV</button>
      </div>
      <div style="overflow-x:auto"><div id="monthlyDataGrid"></div></div>
    </div>
  </div>

  <!-- ===== TAB: SIGNALS ===== -->
  <div class="tab-panel" id="tab-signals">

    <!-- 1. Bollinger Bands -->
    <div class="chart-container mb-20">
      <div class="chart-header">
        <div class="chart-title">Bollinger Bands (20-Day, 2œÉ)</div>
        <div class="flex-row" style="gap:6px;align-items:center;">
          <button class="toggle-btn active" id="bbBtn1y" onclick="setBBWindow('1y')">1Y</button>
          <button class="toggle-btn" id="bbBtn3y" onclick="setBBWindow('3y')">3Y</button>
          <button class="toggle-btn" id="bbBtn5y" onclick="setBBWindow('5y')">5Y</button>
        </div>
      </div>
      <div class="chart-canvas-wrap" style="height:320px"><canvas id="bbChart"></canvas></div>
    </div>

    <!-- 2. Cape/Panamax Spread -->
    <div class="chart-container mb-20">
      <div class="chart-header">
        <div class="chart-title">Cape / Panamax Ratio ‚Äî Iron Ore vs Bulk Grain Proxy</div>
        <div class="flex-row" style="gap:6px;align-items:center;">
          <button class="toggle-btn active" id="spreadBtn3y" onclick="setSpreadWindow('3y')">3Y</button>
          <button class="toggle-btn" id="spreadBtn5y" onclick="setSpreadWindow('5y')">5Y</button>
          <button class="toggle-btn" id="spreadBtnAll" onclick="setSpreadWindow('all')">All</button>
        </div>
      </div>
      <div class="chart-canvas-wrap" style="height:320px"><canvas id="spreadChart"></canvas></div>
    </div>

    <!-- 3. Rate-of-Change Heatmap -->
    <div class="chart-container mb-20">
      <div class="chart-header">
        <div class="chart-title">Rate-of-Change Heatmap ‚Äî All Products √ó Timeframes</div>
      </div>
      <div id="rocHeatmap" style="overflow-x:auto;margin-top:4px;"></div>
    </div>

    <!-- 4. Seasonal Decomposition -->
    <div class="chart-container mb-20">
      <div class="chart-header">
        <div class="chart-title">Seasonal Pattern ‚Äî Avg Intra-Year ¬± 1œÉ (All Years)</div>
      </div>
      <div class="chart-canvas-wrap" style="height:320px"><canvas id="seasonalChart"></canvas></div>
    </div>

    <!-- 5. Term Structure Slope -->
    <div class="chart-container mb-20">
      <div class="chart-header">
        <div class="chart-title">FFA Term Structure ‚Äî BDRY &amp; BWET Curve Shape</div>
      </div>
      <div id="termStructurePanel" style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:4px;">
        <div>
          <div style="font-size:11px;font-weight:600;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.4px;margin-bottom:8px;">BDRY ‚Äî Dry Bulk FFA Curve</div>
          <div class="chart-canvas-wrap" style="height:240px"><canvas id="termBdryChart"></canvas></div>
          <div id="termBdrySlope" style="margin-top:8px;font-size:12px;"></div>
        </div>
        <div>
          <div style="font-size:11px;font-weight:600;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.4px;margin-bottom:8px;">BWET ‚Äî Tanker FFA Curve</div>
          <div class="chart-canvas-wrap" style="height:240px"><canvas id="termBwetChart"></canvas></div>
          <div id="termBwetSlope" style="margin-top:8px;font-size:12px;"></div>
        </div>
      </div>
    </div>

  </div>

</div><!-- /main -->

<script>
// =====================================================================
// GLOBAL DATA STORE
// =====================================================================
const DATA = {
  raw: {},
  master: [],
  masterByDate: {},
  loaded: false,
};

// Per-product filtered row cache (populated after load)
const _rowCache = {};
function getRows(productKey) {
  if (!_rowCache[productKey]) {
    _rowCache[productKey] = DATA.master.filter(r => r[productKey] != null);
  }
  return _rowCache[productKey];
}
function invalidateRowCache() { for (const k in _rowCache) delete _rowCache[k]; }

// computeStats memoized per product (reset on product switch)
const _statsCache = {};
function getStats(productKey) {
  if (!_statsCache[productKey]) _statsCache[productKey] = computeStats(productKey);
  return _statsCache[productKey];
}
function invalidateStatsCache() { for (const k in _statsCache) delete _statsCache[k]; }

// Correlation cache { key: value } keyed by "A:B:tf"
const _corrCache = {};
function getCorrCached(keyA, keyB, tf) {
  const cacheKey = keyA + ':' + keyB + ':' + tf;
  if (cacheKey in _corrCache) return _corrCache[cacheKey];
  const now = new Date();
  let cutoff = null;
  if (tf === '5y') { cutoff = new Date(now); cutoff.setFullYear(now.getFullYear() - 5); }
  if (tf === '1y') { cutoff = new Date(now); cutoff.setDate(now.getDate() - 365); }
  const r = pearsonCorr(keyA, keyB, cutoff);
  _corrCache[cacheKey] = r;
  return r;
}

// qAvg cache keyed by "productKey:year:quarter"
const _qAvgCache = {};
function getQAvgCached(productKey, year, quarter) {
  const k = productKey + ':' + year + ':' + quarter;
  if (k in _qAvgCache) return _qAvgCache[k];
  const vals = DATA.master.filter(r => r.year === year && r.quarter === quarter && r[productKey] != null).map(r => r[productKey]);
  const v = vals.length ? mean(vals) : null;
  _qAvgCache[k] = v;
  return v;
}

// Product config
const PRODUCTS = {
  bdiy:        { label: 'Baltic Dry Index (BDI)',  file: 'bdiy_historical.csv',       color: '#58a6ff' },
  cape:        { label: 'Capesize',                file: 'cape_historical.csv',        color: '#3fb950' },
  panama:      { label: 'Panamax',                 file: 'panama_historical.csv',      color: '#d29922' },
  suprama:     { label: 'Supramax',                file: 'suprama_historical.csv',     color: '#f0883e' },
  cleantanker: { label: 'Clean Tanker (BCTI)',     file: 'cleantanker_historical.csv', color: '#a371f7' },
  dirtytanker: { label: 'Dirty Tanker (BDTI)',     file: 'dirtytanker_historical.csv', color: '#e3b341' },
  bdry_spot:   { label: 'BDRY Spot Composite',     file: null,                         color: '#f0c040', computed: true },
};

// BDRY Spot weights (Solactive index methodology)
const BDRY_WEIGHTS = { cape: 0.50, panama: 0.40, suprama: 0.10 };

const PRODUCT_KEYS = Object.keys(PRODUCTS);

const YEAR_COLORS = [
  '#58a6ff', '#3fb950', '#d29922', '#f0883e', '#a371f7',
  '#e3b341', '#79c0ff', '#56d364', '#ffa657', '#bc8cff',
  '#ff7b72', '#39d353', '#b392f0', '#f78166', '#7ee787',
  '#ffa198', '#6cb6ff', '#dbb68f', '#c9d1d9', '#8b949e',
];

// =====================================================================
// CHANGE 10 ‚Äî Global CSV download utility
// =====================================================================
function downloadCSV(filename, headers, rows) {
  const escape = v => {
    const s = String(v == null ? '' : v);
    if (s.includes(',') || s.includes('"') || s.includes('\n')) {
      return '"' + s.replace(/"/g, '""') + '"';
    }
    return s;
  };
  const lines = [headers.map(escape).join(',')];
  for (const row of rows) {
    lines.push(row.map(escape).join(','));
  }
  const blob = new Blob([lines.join('\n')], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  setTimeout(() => URL.revokeObjectURL(url), 5000);
}

// =====================================================================
// UTILITY FUNCTIONS
// =====================================================================
function parseDate(str) {
  if (!str) return null;
  const [d, m, y] = str.split('-');
  if (!d || !m || !y) return null;
  return new Date(parseInt(y), parseInt(m) - 1, parseInt(d));
}

function parseVal(str) {
  if (!str || str === '' || str === 'N/A') return null;
  return parseFloat(String(str).replace(/,/g, '').replace(/%/, ''));
}

function fmt(n, decimals = 0) {
  if (n == null || isNaN(n)) return '‚Äî';
  return n.toLocaleString('en-US', { minimumFractionDigits: decimals, maximumFractionDigits: decimals });
}

function fmtPct(n) {
  if (n == null || isNaN(n)) return '‚Äî';
  const s = (n >= 0 ? '+' : '') + (n * 100).toFixed(1) + '%';
  return s;
}

function fmtPctRaw(n) {
  if (n == null || isNaN(n)) return '‚Äî';
  const s = (n >= 0 ? '+' : '') + n.toFixed(2) + '%';
  return s;
}

function fmtPctDirect(n) {
  // n is already a percentage value (not fractional)
  if (n == null || isNaN(n)) return '‚Äî';
  return (n >= 0 ? '+' : '') + n.toFixed(1) + '%';
}

function getQuarter(month) {
  if (month <= 2) return 'Q1';
  if (month <= 5) return 'Q2';
  if (month <= 8) return 'Q3';
  return 'Q4';
}

const MONTH_NAMES = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];

function percentileRank(arr, value) {
  const sorted = [...arr].filter(x => x != null).sort((a, b) => a - b);
  if (sorted.length === 0) return 0;
  let count = 0;
  for (const v of sorted) { if (v <= value) count++; }
  return count / sorted.length;
}

function mean(arr) {
  const vals = arr.filter(x => x != null);
  if (!vals.length) return null;
  return vals.reduce((s, v) => s + v, 0) / vals.length;
}

function stddev(arr) {
  const vals = arr.filter(x => x != null);
  if (vals.length < 2) return null;
  const m = mean(vals);
  const variance = vals.reduce((s, v) => s + (v - m) ** 2, 0) / vals.length;
  return Math.sqrt(variance);
}

// =====================================================================
// CHANGE 3 ‚Äî Pearson correlation
// =====================================================================
function pearsonCorr(keyA, keyB, cutoffDate) {
  const pairsA = [], pairsB = [];
  for (const row of DATA.master) {
    if (cutoffDate && row.date < cutoffDate) continue;
    if (row[keyA] != null && row[keyB] != null) {
      pairsA.push(row[keyA]);
      pairsB.push(row[keyB]);
    }
  }
  const n = pairsA.length;
  if (n < 5) return null;
  const mA = pairsA.reduce((s, v) => s + v, 0) / n;
  const mB = pairsB.reduce((s, v) => s + v, 0) / n;
  let num = 0, dA = 0, dB = 0;
  for (let i = 0; i < n; i++) {
    const da = pairsA[i] - mA;
    const db = pairsB[i] - mB;
    num += da * db;
    dA  += da * da;
    dB  += db * db;
  }
  const denom = Math.sqrt(dA * dB);
  return denom === 0 ? 0 : num / denom;
}

// =====================================================================
// CHART DEFAULTS (CHANGE 9)
// =====================================================================
Chart.defaults.color = '#8b949e';
Chart.defaults.borderColor = '#151a22';
Chart.defaults.plugins.legend.labels.boxWidth = 12;
Chart.defaults.plugins.legend.labels.padding = 10;
Chart.defaults.plugins.tooltip.backgroundColor = '#0f1318';
Chart.defaults.plugins.tooltip.borderColor = '#1e2530';
Chart.defaults.plugins.tooltip.borderWidth = 1;
Chart.defaults.plugins.tooltip.titleColor = '#e6edf3';
Chart.defaults.plugins.tooltip.bodyColor = '#8b949e';
Chart.defaults.plugins.tooltip.padding = 10;

const chartRegistry = {};
function destroyChart(id) {
  if (chartRegistry[id]) {
    chartRegistry[id].destroy();
    delete chartRegistry[id];
  }
}

// =====================================================================
// DATA LOADING
// =====================================================================
async function fetchCSV(path) {
  const resp = await fetch(path);
  if (!resp.ok) throw new Error(`HTTP ${resp.status} for ${path}`);
  const text = await resp.text();
  return new Promise((resolve, reject) => {
    Papa.parse(text, {
      header: true,
      skipEmptyLines: true,
      complete: r => resolve(r.data),
      error: e => reject(e),
    });
  });
}

async function loadAllData() {
  const overlay = document.getElementById('loadingOverlay');
  const progress = document.getElementById('loadingProgress');
  let loaded = 0;
  const total = PRODUCT_KEYS.length + 2;

  function tick(label) {
    loaded++;
    progress.textContent = `${label} (${loaded}/${total})`;
  }

  const indexPromises = PRODUCT_KEYS.map(async key => {
    if (PRODUCTS[key].computed) {
      // Computed product ‚Äî no CSV to fetch; raw data built in buildMaster()
      DATA.raw[key] = [];
      tick(PRODUCTS[key].label);
      return key;
    }
    const rows = await fetchCSV(PRODUCTS[key].file);
    const parsed = [];
    for (const row of rows) {
      const d = parseDate(row['Date']);
      const v = parseVal(row['Index']);
      const c = parseVal(row['% Change']);
      if (d && v != null) {
        parsed.push({ date: d, dateStr: row['Date'], value: v, change: c });
      }
    }
    parsed.sort((a, b) => a.date - b.date);
    DATA.raw[key] = parsed;
    tick(PRODUCTS[key].label);
    return key;
  });

  const bdryPromise = fetchCSV('bdry_holdings.csv').then(r => { DATA.bdryHoldings = r; tick('BDRY Holdings'); });
  const bwetPromise = fetchCSV('bwet_holdings.csv').then(r => { DATA.bwetHoldings = r; tick('BWET Holdings'); });

  await Promise.all([...indexPromises, bdryPromise, bwetPromise]);

  buildMaster();

  DATA.loaded = true;
  DATA.years = [...new Set(DATA.master.map(r => r.year))].sort((a, b) => a - b);
  overlay.classList.add('hidden');

  const now = new Date();
  document.getElementById('updatedAtText').textContent =
    `Data as of ${now.toLocaleDateString('en-US', { month:'short', day:'numeric', year:'numeric' })}`;
  document.getElementById('liveDot').classList.add('active');
}

function buildMaster() {
  const allDatesSet = new Set();
  for (const key of PRODUCT_KEYS) {
    if (PRODUCTS[key].computed) continue;
    for (const row of DATA.raw[key]) allDatesSet.add(row.date.getTime());
  }
  const allDates = Array.from(allDatesSet).sort((a, b) => a - b);

  const maps = {};
  for (const key of PRODUCT_KEYS) {
    if (PRODUCTS[key].computed) continue;
    maps[key] = {};
    for (const row of DATA.raw[key]) {
      maps[key][row.date.getTime()] = row;
    }
  }

  DATA.master = allDates.map(ts => {
    const d = new Date(ts);
    const month = d.getMonth();
    const quarter = getQuarter(month);
    const year = d.getFullYear();
    const row = { date: d, ts, year, month, quarter };
    for (const key of PRODUCT_KEYS) {
      if (PRODUCTS[key].computed) continue; // skip ‚Äî derived below
      const r = maps[key][ts];
      row[key] = r ? r.value : null;
      row[`${key}_change`] = r ? r.change : null;
    }
    // Compute BDRY Spot: 50% Cape + 40% Panamax + 10% Supramax
    if (row.cape != null && row.panama != null && row.suprama != null) {
      row.bdry_spot = BDRY_WEIGHTS.cape * row.cape + BDRY_WEIGHTS.panama * row.panama + BDRY_WEIGHTS.suprama * row.suprama;
      // Daily change: derived from component changes weighted the same way
      const cc = row.cape_change, pc = row.panama_change, sc = row.suprama_change;
      row.bdry_spot_change = (cc != null && pc != null && sc != null)
        ? BDRY_WEIGHTS.cape * cc + BDRY_WEIGHTS.panama * pc + BDRY_WEIGHTS.suprama * sc
        : null;
    } else {
      row.bdry_spot = null;
      row.bdry_spot_change = null;
    }
    return row;
  });

  const byYear = {};
  for (const row of DATA.master) {
    if (!byYear[row.year]) byYear[row.year] = [];
    byYear[row.year].push(row);
  }
  for (const year in byYear) {
    byYear[year].forEach((row, i) => { row.tradingDay = i + 1; });
  }
  DATA.byYear = byYear;

  for (const row of DATA.master) {
    DATA.masterByDate[row.ts] = row;
  }
  invalidateRowCache();
  invalidateStatsCache();
}

// =====================================================================
// ANALYTICS
// =====================================================================
function computeStats(productKey) {
  const rows = getRows(productKey);
  if (!rows.length) return null;

  const latest = rows[rows.length - 1];
  const currentPrice = latest[productKey];
  const prevRow = rows[rows.length - 2];
  const prevPrice = prevRow ? prevRow[productKey] : null;
  const pctChange = prevPrice ? ((currentPrice - prevPrice) / prevPrice) * 100 : null;

  const now = latest.date;
  const cutoff10y = new Date(now); cutoff10y.setFullYear(now.getFullYear() - 10);
  const cutoff5y  = new Date(now); cutoff5y.setFullYear(now.getFullYear() - 5);
  const cutoff1y  = new Date(now); cutoff1y.setDate(now.getDate() - 365);
  const cutoff20d = new Date(now); cutoff20d.setDate(now.getDate() - 20);

  const allVals   = rows.map(r => r[productKey]);
  const vals10y   = rows.filter(r => r.date >= cutoff10y).map(r => r[productKey]);
  const vals5y    = rows.filter(r => r.date >= cutoff5y).map(r => r[productKey]);
  const vals1y    = rows.filter(r => r.date >= cutoff1y).map(r => r[productKey]);

  const alltimePctl = percentileRank(allVals, currentPrice);
  const pctl10y     = percentileRank(vals10y, currentPrice);
  const pctl5y      = percentileRank(vals5y, currentPrice);

  const currentTradingDay = latest.tradingDay;
  const sameDayVals = DATA.master
    .filter(r => r.tradingDay === currentTradingDay && r.year < now.getFullYear() && r[productKey] != null)
    .map(r => r[productKey]);
  const allMean   = mean(sameDayVals.length >= 3 ? sameDayVals : allVals);
  const allStdDev = stddev(sameDayVals.length >= 3 ? sameDayVals : allVals);
  const zScore    = allStdDev ? (currentPrice - allMean) / allStdDev : 0;

  const max1y = vals1y.length ? vals1y.reduce((a, b) => a > b ? a : b, -Infinity) : currentPrice;
  const drawdown = (currentPrice - max1y) / max1y;

  const row20d = rows.filter(r => r.date <= cutoff20d);
  const price20d = row20d.length ? row20d[row20d.length - 1][productKey] : null;
  const roc20 = price20d ? ((currentPrice - price20d) / price20d) * 100 : null;

  return {
    currentPrice, pctChange, alltimePctl, pctl10y, pctl5y, zScore, drawdown, roc20,
  };
}

function tradingSignal(stats) {
  if (!stats) return { text: '‚è≥ WAIT', cls: 'signal-wait' };
  const { pctl5y, zScore, alltimePctl } = stats;
  if (pctl5y > 0.8)                                              return { text: '‚õî SELL (Overheated)',  cls: 'signal-sell' };
  if (pctl5y < 0.2 && zScore < -0.5 && alltimePctl > 0.4)       return { text: 'üíé GOLDEN DIP',         cls: 'signal-golden' };
  if (pctl5y < 0.1 && zScore < -0.6)                            return { text: 'üî• CATCHING KNIFE',     cls: 'signal-knife' };
  if (pctl5y < 0.3 && alltimePctl < 0.3)                        return { text: '‚ö†Ô∏è VALUE TRAP',         cls: 'signal-trap' };
  if (pctl5y < 0.4)                                              return { text: 'üîπ ACCUMULATE',         cls: 'signal-accumulate' };
  return { text: '‚è≥ WAIT', cls: 'signal-wait' };
}

function pctColor(pct) {
  if (pct < 0.3) return 'val-red';
  if (pct < 0.7) return 'val-yellow';
  return 'val-green';
}

// =====================================================================
// DASHBOARD TAB
// =====================================================================
let currentCorrTimeframe = 'all';

function renderDashboard(productKey) {
  const prod = PRODUCTS[productKey];
  document.getElementById('dashProductLabel').textContent = prod.label;

  const stats = getStats(productKey);
  if (!stats) return;

  const rows   = getRows(productKey);
  const latest = rows[rows.length - 1];

  document.getElementById('dashCurrentPrice').textContent = fmt(stats.currentPrice);

  const changeEl = document.getElementById('dashPriceChange');
  if (stats.pctChange != null) {
    const sign = stats.pctChange >= 0 ? '+' : '';
    changeEl.textContent = `${sign}${stats.pctChange.toFixed(2)}% vs prior day`;
    changeEl.className = 'current-price-change ' + (stats.pctChange >= 0 ? 'change-pos' : 'change-neg');
  } else {
    changeEl.textContent = '‚Äî';
    changeEl.className = 'current-price-change';
  }

  const sig = tradingSignal(stats);
  const sigEl = document.getElementById('dashSignal');
  sigEl.textContent = sig.text;
  sigEl.className = 'signal-badge ' + sig.cls;

  // Alerts banner
  const bullishEl  = document.getElementById('alertBullish');
  const bearishEl  = document.getElementById('alertBearish');
  const bullishTxt = document.getElementById('alertBullishText');
  const bearishTxt = document.getElementById('alertBearishText');
  if (sig.text.includes('ACCUMULATE') || sig.text.includes('GOLDEN')) {
    bullishTxt.textContent = sig.text;
    bullishEl.style.display  = 'block';
    bearishEl.style.display  = 'none';
  } else if (sig.text.includes('SELL') || sig.text.includes('KNIFE')) {
    bearishTxt.textContent = sig.text;
    bearishEl.style.display  = 'block';
    bullishEl.style.display  = 'none';
  } else {
    bullishEl.style.display = 'none';
    bearishEl.style.display = 'none';
  }

  // Stats cards
  const atEl = document.getElementById('statAlltime');
  atEl.textContent = (stats.alltimePctl * 100).toFixed(1) + '%';
  atEl.className = 'stat-value ' + pctColor(stats.alltimePctl);

  const t10El = document.getElementById('stat10y');
  t10El.textContent = (stats.pctl10y * 100).toFixed(1) + '%';
  t10El.className = 'stat-value ' + pctColor(stats.pctl10y);

  const t5El = document.getElementById('stat5y');
  t5El.textContent = (stats.pctl5y * 100).toFixed(1) + '%';
  t5El.className = 'stat-value ' + pctColor(stats.pctl5y);

  const zsEl = document.getElementById('statZscore');
  zsEl.textContent = stats.zScore.toFixed(2);
  zsEl.className = 'stat-value ' + (stats.zScore < -1 ? 'val-red' : stats.zScore > 1 ? 'val-green' : 'val-yellow');

  const ddEl = document.getElementById('statDrawdown');
  ddEl.textContent = (stats.drawdown * 100).toFixed(1) + '%';
  ddEl.className = 'stat-value ' + (stats.drawdown < -0.3 ? 'val-red' : stats.drawdown < -0.1 ? 'val-yellow' : 'val-green');

  // CHANGE 11 ‚Äî ROC20 stat card
  const rocEl = document.getElementById('statRoc20');
  if (stats.roc20 != null) {
    rocEl.textContent = (stats.roc20 >= 0 ? '+' : '') + stats.roc20.toFixed(1) + '%';
    rocEl.className = 'stat-value ' + (stats.roc20 >= 0 ? 'val-green' : 'val-red');
  } else {
    rocEl.textContent = '‚Äî';
    rocEl.className = 'stat-value val-white';
  }

  // Historical Context Strip
  const cut5y2  = new Date(latest.date); cut5y2.setFullYear(latest.date.getFullYear() - 5);
  const cut10y2 = new Date(latest.date); cut10y2.setFullYear(latest.date.getFullYear() - 10);
  const avg5y  = mean(rows.filter(r => r.date >= cut5y2).map(r => r[productKey]));
  const avg10y = mean(rows.filter(r => r.date >= cut10y2).map(r => r[productKey]));
  // rows already from getRows() cache above
  const ctx5yAvgEl  = document.getElementById('ctx5yAvg');
  const ctx5yDevEl  = document.getElementById('ctx5yDev');
  const ctx10yDevEl = document.getElementById('ctx10yDev');
  if (ctx5yAvgEl) {
    ctx5yAvgEl.textContent = avg5y != null ? fmt(avg5y, 0) : '‚Äî';
    if (avg5y != null) {
      const dev5y  = ((stats.currentPrice - avg5y)  / avg5y  * 100);
      const dev10y = avg10y != null ? ((stats.currentPrice - avg10y) / avg10y * 100) : null;
      ctx5yDevEl.textContent  = (dev5y  >= 0 ? '+' : '') + dev5y.toFixed(1)  + '%';
      ctx5yDevEl.className    = 'context-value ' + (dev5y  >= 0 ? 'val-green' : 'val-red');
      if (dev10y != null) {
        ctx10yDevEl.textContent = (dev10y >= 0 ? '+' : '') + dev10y.toFixed(1) + '%';
        ctx10yDevEl.className   = 'context-value ' + (dev10y >= 0 ? 'val-green' : 'val-red');
      } else {
        ctx10yDevEl.textContent = '‚Äî';
        ctx10yDevEl.className   = 'context-value';
      }
    }
  }

  renderOverlayChart(productKey);
  renderDrawdownChart(productKey);
  renderYearlyPerfTable(productKey);
  renderCorrMatrix(currentCorrTimeframe);
  renderRecentChanges(productKey);
}

// =====================================================================
// OVERLAY CHART
// =====================================================================
function renderOverlayChart(productKey) {
  const years = Object.keys(DATA.byYear).map(Number).sort((a, b) => a - b);
  const currentYear = new Date().getFullYear();

  const defaultCompare = years
    .filter(y => y < currentYear)
    .slice(-3)
    .reverse()
    .slice(0, 3);

  const checkboxContainer = document.getElementById('yearCheckboxes');
  checkboxContainer.innerHTML = '';

  const priorYears = years.filter(y => y < currentYear);

  for (const y of priorYears) {
    const checked = defaultCompare.includes(y) ? 'checked' : '';
    const color = YEAR_COLORS[priorYears.indexOf(y) % YEAR_COLORS.length];
    const item = document.createElement('label');
    item.className = 'year-checkbox-item';
    item.innerHTML = `<input type="checkbox" value="${y}" ${checked} style="accent-color:${color}"> <span style="color:${color}">${y}</span>`;
    item.querySelector('input').addEventListener('change', () => buildOverlayChart(productKey));
    checkboxContainer.appendChild(item);
  }

  buildOverlayChart(productKey);
}

function buildOverlayChart(productKey) {
  const currentYear = new Date().getFullYear();
  const years = Object.keys(DATA.byYear).map(Number).sort((a, b) => a - b);

  const checkboxes = document.querySelectorAll('#yearCheckboxes input[type=checkbox]:checked');
  const selectedYears = Array.from(checkboxes).map(cb => parseInt(cb.value));

  const datasets = [];
  const prod = PRODUCTS[productKey];

  let maxDays = 0;
  for (const y of [...selectedYears, currentYear]) {
    const yr = DATA.byYear[y];
    if (yr) maxDays = Math.max(maxDays, yr.length);
  }
  const labels = Array.from({ length: maxDays }, (_, i) => i + 1);

  const curYearRows = DATA.byYear[currentYear] || [];
  datasets.push({
    label: String(currentYear),
    data: curYearRows.map(r => r[productKey] ?? null),
    borderColor: prod.color,
    backgroundColor: 'transparent',
    borderWidth: 3,
    pointRadius: 0,
    tension: 0.2,
    order: 0,
  });

  const checkboxEls = document.querySelectorAll('#yearCheckboxes input[type=checkbox]');

  selectedYears.sort((a, b) => b - a).forEach((y, idx) => {
    const rows = DATA.byYear[y] || [];
    const checkEl = Array.from(checkboxEls).find(cb => parseInt(cb.value) === y);
    const colorIdx = checkEl ? Array.from(checkboxEls).indexOf(checkEl) : idx;
    const color = YEAR_COLORS[colorIdx % YEAR_COLORS.length];
    datasets.push({
      label: String(y),
      data: rows.map(r => r[productKey] ?? null),
      borderColor: color,
      backgroundColor: 'transparent',
      borderWidth: 1.5,
      pointRadius: 0,
      tension: 0.2,
      borderDash: [],
      order: idx + 1,
    });
  });

  destroyChart('overlayChart');
  const ctx = document.getElementById('overlayChart').getContext('2d');
  chartRegistry['overlayChart'] = new Chart(ctx, {
    type: 'line',
    data: { labels, datasets },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: { mode: 'index', intersect: false },
      plugins: {
        legend: { position: 'top', labels: { usePointStyle: true } },
        tooltip: {
          callbacks: {
            title: ctx => `Trading Day ${ctx[0].label}`,
            label: ctx => ` ${ctx.dataset.label}: ${fmt(ctx.parsed.y)}`,
          },
        },
      },
      scales: {
        x: {
          grid: { color: '#151a22' },
          ticks: { maxTicksLimit: 13, font: { size: 11 } },
          title: { display: true, text: 'Trading Day of Year', color: '#8b949e', font: { size: 11 } },
        },
        y: {
          grid: { color: '#151a22' },
          ticks: { font: { size: 11 }, callback: v => fmt(v) },
          title: { display: true, text: PRODUCTS[productKey].label, color: '#8b949e', font: { size: 11 } },
        },
      },
    },
  });
}

// =====================================================================
// CHANGE 1 ‚Äî Drawdown Chart
// =====================================================================
function renderDrawdownChart(productKey) {
  const rows = getRows(productKey);
  if (!rows.length) return;

  // Last 3 years
  const cutoff3y = new Date();
  cutoff3y.setFullYear(cutoff3y.getFullYear() - 3);
  const filtered = rows.filter(r => r.date >= cutoff3y);

  // Rolling 365-day max for each point
  const ddData = [];
  const labels = [];

  for (let i = 0; i < filtered.length; i++) {
    const current = filtered[i];
    const cutoff365 = new Date(current.date);
    cutoff365.setDate(cutoff365.getDate() - 365);
    // find max in last 365 days from the full rows array
    let maxVal = current[productKey];
    for (let j = rows.length - 1; j >= 0; j--) {
      if (rows[j].date > current.date) continue;
      if (rows[j].date < cutoff365) break;
      if (rows[j][productKey] > maxVal) maxVal = rows[j][productKey];
    }
    const dd = maxVal > 0 ? ((current[productKey] - maxVal) / maxVal) * 100 : 0;
    ddData.push(dd);
    labels.push(current.date.toISOString().split('T')[0]);
  }

  destroyChart('drawdownChart');
  const ctx = document.getElementById('drawdownChart').getContext('2d');

  chartRegistry['drawdownChart'] = new Chart(ctx, {
    type: 'line',
    data: {
      labels,
      datasets: [{
        label: 'Drawdown %',
        data: ddData,
        borderColor: '#f85149',
        backgroundColor: 'rgba(248,81,73,0.3)',
        borderWidth: 1.5,
        pointRadius: 0,
        fill: true,
        tension: 0.1,
      }],
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: { mode: 'index', intersect: false },
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            title: ctx => ctx[0].label,
            label: ctx => ` Drawdown: ${ctx.parsed.y.toFixed(2)}%`,
          },
        },
      },
      scales: {
        x: {
          grid: { color: '#151a22' },
          ticks: {
            maxTicksLimit: 8,
            font: { size: 11 },
            callback: function(val, idx) {
              return labels[idx] ? labels[idx].slice(0, 7) : '';
            },
          },
        },
        y: {
          grid: { color: '#151a22' },
          min: undefined,
          max: 0,
          ticks: {
            font: { size: 11 },
            callback: v => v.toFixed(1) + '%',
          },
          title: { display: true, text: 'Drawdown %', color: '#8b949e', font: { size: 11 } },
        },
      },
    },
  });
}

// =====================================================================
// CHANGE 2 ‚Äî Yearly Performance Table
// =====================================================================
let _yearlyPerfProductKey = null;
let _yearlyPerfData = null;

function renderYearlyPerfTable(productKey) {
  _yearlyPerfProductKey = productKey;
  const years = [...DATA.years].reverse();

  // Compute yearly averages
  const yearlyAvgs = {};
  const yearlyMins = {};
  const yearlyMaxs = {};
  for (const y of years) {
    const vals = getRows(productKey).filter(r => r.year === y).map(r => r[productKey]);
    yearlyAvgs[y] = vals.length ? mean(vals) : null;
    yearlyMins[y] = vals.length ? Math.min(...vals) : null;
    yearlyMaxs[y] = vals.length ? Math.max(...vals) : null;
  }

  _yearlyPerfData = { years, yearlyAvgs, yearlyMins, yearlyMaxs };

  let html = `<table class="yearly-table">
    <thead><tr>
      <th>Year</th>
      <th>Avg Value</th>
      <th>YoY %</th>
      <th>Min</th>
      <th>Max</th>
      <th>Range %</th>
    </tr></thead><tbody>`;

  for (let i = 0; i < years.length; i++) {
    const y = years[i];
    const avg = yearlyAvgs[y];
    const mn  = yearlyMins[y];
    const mx  = yearlyMaxs[y];
    if (avg == null) continue;

    // Prior year avg (years are descending, so prior = years[i+1])
    const priorYear = years[i + 1];
    const priorAvg  = priorYear != null ? yearlyAvgs[priorYear] : null;
    let yoyPct = null;
    let yoyCls = '';
    let yoyStr = '‚Äî';
    if (priorAvg != null && priorAvg !== 0) {
      yoyPct = ((avg - priorAvg) / priorAvg) * 100;
      yoyStr = (yoyPct >= 0 ? '+' : '') + yoyPct.toFixed(1) + '%';
      yoyCls = yoyPct >= 0 ? 'val-green' : 'val-red';
    }

    const rangePct = mn != null && avg != null && avg !== 0 ? ((mx - mn) / avg * 100).toFixed(1) + '%' : '‚Äî';

    html += `<tr>
      <td>${y}</td>
      <td>${fmt(avg, 0)}</td>
      <td class="${yoyCls}">${yoyStr}</td>
      <td>${fmt(mn, 0)}</td>
      <td>${fmt(mx, 0)}</td>
      <td>${rangePct}</td>
    </tr>`;
  }

  html += '</tbody></table>';
  document.getElementById('yearlyPerfTable').innerHTML = html;

  // Wire download button
  document.getElementById('yearlyDlBtn').onclick = () => downloadYearlyPerf(productKey);
}

function downloadYearlyPerf(productKey) {
  if (!_yearlyPerfData) return;
  const { years, yearlyAvgs, yearlyMins, yearlyMaxs } = _yearlyPerfData;
  const headers = ['Year','Avg Value','YoY %','Min','Max','Range %'];
  const rows = [];
  for (let i = 0; i < years.length; i++) {
    const y = years[i];
    const avg = yearlyAvgs[y];
    const mn  = yearlyMins[y];
    const mx  = yearlyMaxs[y];
    if (avg == null) continue;
    const priorYear = years[i + 1];
    const priorAvg  = priorYear != null ? yearlyAvgs[priorYear] : null;
    let yoyStr = '';
    if (priorAvg != null && priorAvg !== 0) {
      const yoy = ((avg - priorAvg) / priorAvg) * 100;
      yoyStr = yoy.toFixed(2) + '%';
    }
    const rangePct = mn != null && avg != null && avg !== 0 ? ((mx - mn) / avg * 100).toFixed(2) + '%' : '';
    rows.push([y, avg != null ? avg.toFixed(2) : '', yoyStr, mn != null ? mn.toFixed(2) : '', mx != null ? mx.toFixed(2) : '', rangePct]);
  }
  downloadCSV(`yearly_perf_${productKey}.csv`, headers, rows);
}

function toggleYearlyPerf() {
  const btn = document.getElementById('yearlyPerfToggle');
  const content = document.getElementById('yearlyPerfContent');
  btn.classList.toggle('open');
  content.classList.toggle('open');
}

// =====================================================================
// CHANGE 3 ‚Äî Correlation Matrix
// =====================================================================
const CORR_LABELS = ['BDI','Cape','Panama','Supra','CleanT','DirtyT','BDRY Spot'];

function setCorrTimeframe(el, tf) {
  currentCorrTimeframe = tf;
  document.querySelectorAll('.corr-btn').forEach(b => b.classList.remove('active'));
  el.classList.add('active');
  renderCorrMatrix(tf);
}

function corrColor(r) {
  // -1 = deep red, 0 = dark gray #21262d, +1 = bright green
  if (r == null) return '#21262d';
  const clamped = Math.max(-1, Math.min(1, r));
  if (clamped < 0) {
    // 0 ‚Üí #21262d, -1 ‚Üí #8b0000
    const t = -clamped; // 0..1
    const r_ = Math.round(0x21 + t * (0x8b - 0x21));
    const g_ = Math.round(0x26 + t * (0x00 - 0x26));
    const b_ = Math.round(0x2d + t * (0x00 - 0x2d));
    return `rgb(${r_},${g_},${b_})`;
  } else {
    // 0 ‚Üí #21262d, +1 ‚Üí #00c853
    const t = clamped;
    const r_ = Math.round(0x21 + t * (0x00 - 0x21));
    const g_ = Math.round(0x26 + t * (0xc8 - 0x26));
    const b_ = Math.round(0x2d + t * (0x53 - 0x2d));
    return `rgb(${r_},${g_},${b_})`;
  }
}

function renderCorrMatrix(tf) {
  const container = document.getElementById('corrMatrix');
  let html = `<table class="corr-table"><thead><tr><th></th>`;
  for (const lbl of CORR_LABELS) html += `<th>${lbl}</th>`;
  html += '</tr></thead><tbody>';

  for (let i = 0; i < PRODUCT_KEYS.length; i++) {
    html += `<tr><th style="text-align:left;background:var(--bg);color:var(--text-muted);font-size:11px">${CORR_LABELS[i]}</th>`;
    for (let j = 0; j < PRODUCT_KEYS.length; j++) {
      if (i === j) {
        html += `<td style="background:#1c3150;color:#58a6ff;font-weight:700">1.00</td>`;
      } else {
        const r = getCorrCached(PRODUCT_KEYS[i], PRODUCT_KEYS[j], tf);
        const bg = corrColor(r);
        const textCol = r != null && Math.abs(r) > 0.4 ? '#fff' : '#e6edf3';
        html += `<td style="background:${bg};color:${textCol}">${r != null ? r.toFixed(2) : '‚Äî'}</td>`;
      }
    }
    html += '</tr>';
  }
  html += '</tbody></table>';
  container.innerHTML = html;
}

// =====================================================================
// HEATMAPS TAB
// =====================================================================
let currentHeatmapView = 'absolute';

function onHeatmapViewChange() {
  currentHeatmapView = document.getElementById('heatmapViewSelect').value;
  renderHeatmaps(currentProduct);
}

function renderHeatmaps(productKey) {
  if (currentHeatmapView === 'pct') {
    renderMonthlyHeatmapPct(productKey);
  } else {
    renderMonthlyHeatmap(productKey);
  }
  renderMonthlyAbsHeatmap(productKey);

  // Wire download buttons
  document.getElementById('monthlyHeatmapDlBtn').onclick = () => downloadMonthlyHeatmap(productKey);
}

// ---- Original absolute-value heatmap color (for Monthly Abs section) ----
function heatmapColorAbs(ratio) {
  // dark low: #5c1a1a, dark high: #1a2e1a, mid: #21262d
  if (ratio <= 0.5) {
    const t = ratio * 2;
    const r = Math.round(0x5c + t * (0x21 - 0x5c));
    const g = Math.round(0x1a + t * (0x26 - 0x1a));
    const b = Math.round(0x1a + t * (0x2d - 0x1a));
    return `rgb(${r},${g},${b})`;
  } else {
    const t = (ratio - 0.5) * 2;
    const r = Math.round(0x21 + t * (0x1a - 0x21));
    const g = Math.round(0x26 + t * (0x2e - 0x26));
    const b = Math.round(0x2d + t * (0x1a - 0x2d));
    return `rgb(${r},${g},${b})`;
  }
}

// ---- % Change divergent color ----
function heatmapColorPct(pctVal) {
  // ‚â§ -15% ‚Üí #8b0000, 0% ‚Üí #1a1a2e, ‚â• +15% ‚Üí #00c853
  const clamped = Math.max(-15, Math.min(15, pctVal));
  if (clamped < 0) {
    const t = -clamped / 15; // 0..1
    const r = Math.round(0x1a + t * (0x8b - 0x1a));
    const g = Math.round(0x1a + t * (0x00 - 0x1a));
    const b = Math.round(0x2e + t * (0x00 - 0x2e));
    return `rgb(${r},${g},${b})`;
  } else {
    const t = clamped / 15;
    const r = Math.round(0x1a + t * (0x00 - 0x1a));
    const g = Math.round(0x1a + t * (0xc8 - 0x1a));
    const b = Math.round(0x2e + t * (0x53 - 0x2e));
    return `rgb(${r},${g},${b})`;
  }
}

function renderMonthlyHeatmap(productKey) {
  const container = document.getElementById('monthlyHeatmap');
  const years = DATA.years;

  const matrix = {};
  for (const y of years) {
    matrix[y] = {};
    for (let m = 0; m < 12; m++) {
      const vals = DATA.master.filter(r => r.year === y && r.month === m && r[productKey] != null).map(r => r[productKey]);
      matrix[y][m] = vals.length ? mean(vals) : null;
    }
  }

  const colStats = {};
  for (let m = 0; m < 12; m++) {
    const vals = years.map(y => matrix[y][m]).filter(v => v != null);
    colStats[m] = { min: Math.min(...vals), max: Math.max(...vals) };
  }

  let html = `<table class="heatmap-table"><thead><tr>
    <th>Year</th>${MONTH_NAMES.map(mn => `<th>${mn}</th>`).join('')}
  </tr></thead><tbody>`;

  for (const y of [...years].reverse()) {
    html += `<tr><td class="year-col">${y}</td>`;
    for (let m = 0; m < 12; m++) {
      const v = matrix[y][m];
      if (v == null) {
        html += `<td style="color:#484f58">‚Äî</td>`;
      } else {
        const { min, max } = colStats[m];
        const ratio = max > min ? (v - min) / (max - min) : 0.5;
        const bg = heatmapColorAbs(ratio);
        html += `<td style="background:${bg};color:#e6edf3">${fmt(v, 0)}</td>`;
      }
    }
    html += '</tr>';
  }
  html += '</tbody></table>';
  container.innerHTML = html;
}

function renderMonthlyHeatmapPct(productKey) {
  const container = document.getElementById('monthlyHeatmap');
  const years = DATA.years;

  // Build avg matrix
  const matrix = {};
  for (const y of years) {
    matrix[y] = {};
    for (let m = 0; m < 12; m++) {
      const vals = DATA.master.filter(r => r.year === y && r.month === m && r[productKey] != null).map(r => r[productKey]);
      matrix[y][m] = vals.length ? mean(vals) : null;
    }
  }

  let html = `<table class="heatmap-table"><thead><tr>
    <th>Year</th>${MONTH_NAMES.map(mn => `<th>${mn}</th>`).join('')}
  </tr></thead><tbody>`;

  for (const y of [...years].reverse()) {
    html += `<tr><td class="year-col">${y}</td>`;
    for (let m = 0; m < 12; m++) {
      const v = matrix[y][m];
      if (v == null) {
        html += `<td style="color:#484f58">‚Äî</td>`;
      } else {
        // MoM %: compare to previous month (could be prior year month 11)
        let prevV = null;
        if (m > 0) {
          prevV = matrix[y][m - 1];
        } else {
          // January: compare to prior year December
          const priorYear = y - 1;
          if (matrix[priorYear]) prevV = matrix[priorYear][11];
        }
        let pctStr = '';
        let bg = heatmapColorPct(0);
        if (prevV != null && prevV !== 0) {
          const pct = ((v - prevV) / prevV) * 100;
          pctStr = (pct >= 0 ? '+' : '') + pct.toFixed(1) + '%';
          bg = heatmapColorPct(pct);
        } else {
          pctStr = '‚Äî';
        }
        html += `<td style="background:${bg};color:#e6edf3">
          <span class="heatmap-abs-val">${fmt(v, 0)}</span>
          <span class="heatmap-pct-val">${pctStr}</span>
        </td>`;
      }
    }
    html += '</tr>';
  }
  html += '</tbody></table>';
  container.innerHTML = html;
}

function renderMonthlyAbsHeatmap(productKey) {
  const container = document.getElementById('monthlyAbsHeatmap');
  const years = DATA.years;

  const matrix = {};
  for (const y of years) {
    matrix[y] = {};
    for (let m = 0; m < 12; m++) {
      const vals = DATA.master.filter(r => r.year === y && r.month === m && r[productKey] != null).map(r => r[productKey]);
      matrix[y][m] = vals.length ? mean(vals) : null;
    }
  }

  const colStats = {};
  for (let m = 0; m < 12; m++) {
    const vals = years.map(y => matrix[y][m]).filter(v => v != null);
    colStats[m] = { min: Math.min(...vals), max: Math.max(...vals) };
  }

  let html = `<table class="heatmap-table"><thead><tr>
    <th>Year</th>${MONTH_NAMES.map(mn => `<th>${mn}</th>`).join('')}
  </tr></thead><tbody>`;

  for (const y of [...years].reverse()) {
    html += `<tr><td class="year-col">${y}</td>`;
    for (let m = 0; m < 12; m++) {
      const v = matrix[y][m];
      if (v == null) {
        html += `<td style="color:#484f58">‚Äî</td>`;
      } else {
        const { min, max } = colStats[m];
        const ratio = max > min ? (v - min) / (max - min) : 0.5;
        const bg = heatmapColorAbs(ratio);
        html += `<td style="background:${bg};color:#e6edf3">${fmt(v, 0)}</td>`;
      }
    }
    html += '</tr>';
  }
  html += '</tbody></table>';
  container.innerHTML = html;
}

function downloadMonthlyHeatmap(productKey) {
  const years = [...DATA.years].reverse();
  const matrix = {};
  for (const y of years) {
    matrix[y] = {};
    for (let m = 0; m < 12; m++) {
      const vals = DATA.master.filter(r => r.year === y && r.month === m && r[productKey] != null).map(r => r[productKey]);
      matrix[y][m] = vals.length ? mean(vals) : null;
    }
  }
  const headers = ['Year', ...MONTH_NAMES];
  const rows = years.map(y => [y, ...Array.from({length:12},(_,m) => matrix[y][m] != null ? matrix[y][m].toFixed(2) : '')]);
  downloadCSV(`monthly_heatmap_${productKey}.csv`, headers, rows);
}

// =====================================================================
// QUARTERLY TAB
// =====================================================================
function renderQuarterlyTab(productKey) {
  renderWinRateCards(productKey);
  renderQuarterlyHeatmap(productKey);
  renderSpaghettiChart(productKey);
  renderQDAreaComp1(productKey);
  renderQDTrend(productKey);
  renderQDBarChart(productKey);
  renderQDAreaComp2(productKey);
  renderQDDataGrid(productKey);

  document.getElementById('quarterlyDlBtn').onclick = () => downloadQuarterlyHeatmapCSV(productKey);
  document.getElementById('quarterlyHeatmapDlBtn').onclick = () => downloadQuarterlyHeatmapCSV(productKey);
}

// ---- CHANGE 6: Win-Rate KPI Cards ----
function renderWinRateCards(productKey) {
  const quarters = ['Q1','Q2','Q3','Q4'];
  const years = DATA.years;

  // Build quarter avgs per year ‚Äî use cache
  const qAvg = {};
  for (const y of years) {
    qAvg[y] = {};
    for (const q of quarters) {
      qAvg[y][q] = getQAvgCached(productKey, y, q);
    }
  }

  const winRates = {};
  for (const q of quarters) {
    let wins = 0, total = 0;
    for (let i = 0; i < years.length; i++) {
      const y = years[i];
      const thisQAvg = qAvg[y][q];
      if (thisQAvg == null) continue;
      let prevAvg = null;
      if (q === 'Q1') {
        // Compare Q1 to prior year Q4
        const priorYear = y - 1;
        prevAvg = qAvg[priorYear] ? qAvg[priorYear]['Q4'] : null;
      } else {
        const prevQ = q === 'Q2' ? 'Q1' : q === 'Q3' ? 'Q2' : 'Q3';
        prevAvg = qAvg[y][prevQ];
      }
      if (prevAvg == null) continue;
      total++;
      if (thisQAvg > prevAvg) wins++;
    }
    winRates[q] = total > 0 ? (wins / total) * 100 : null;
  }

  const row = document.getElementById('winRateRow');
  row.innerHTML = '';
  for (const q of quarters) {
    const wr = winRates[q];
    let cls = 'wr-yellow', valColor = 'var(--yellow)';
    if (wr != null) {
      if (wr > 60)  { cls = 'wr-green';  valColor = 'var(--green)'; }
      else if (wr < 50) { cls = 'wr-red'; valColor = 'var(--red)'; }
    }
    const pct = wr != null ? wr.toFixed(0) + '%' : '‚Äî';
    const barW = wr != null ? wr : 0;
    const card = document.createElement('div');
    card.className = `win-rate-card ${cls}`;
    card.innerHTML = `
      <div class="win-rate-label">${q} Win Rate</div>
      <div class="win-rate-value" style="color:${valColor}">${pct}</div>
      <div class="win-rate-bar-wrap"><div class="win-rate-bar" style="width:${barW}%;background:${valColor}"></div></div>
    `;
    row.appendChild(card);
  }
}

// ---- Quarterly Heatmap with QoQ % divergent color ----
function renderQuarterlyHeatmap(productKey) {
  const container = document.getElementById('quarterlyHeatmap');
  const quarters = ['Q1','Q2','Q3','Q4'];
  const years = DATA.years;

  const matrix = {};
  for (const y of years) {
    matrix[y] = {};
    for (const q of quarters) {
      const vals = DATA.master.filter(r => r.year === y && r.quarter === q && r[productKey] != null).map(r => r[productKey]);
      matrix[y][q] = vals.length ? mean(vals) : null;
    }
  }

  const colStats = {};
  for (const q of quarters) {
    const vals = years.map(y => matrix[y][q]).filter(v => v != null);
    colStats[q] = { min: Math.min(...vals), max: Math.max(...vals) };
  }

  let html = `<table class="heatmap-table"><thead><tr>
    <th>Year</th>${quarters.map(q => `<th>${q}</th>`).join('')}
  </tr></thead><tbody>`;

  for (const y of [...years].reverse()) {
    html += `<tr><td class="year-col">${y}</td>`;
    for (const q of quarters) {
      const v = matrix[y][q];
      if (v == null) {
        html += `<td style="color:#484f58">‚Äî</td>`;
      } else {
        // QoQ %: compare to prior quarter
        let prevV = null;
        if (q === 'Q1') {
          prevV = matrix[y - 1] ? matrix[y - 1]['Q4'] : null;
        } else {
          const prevQ = q === 'Q2' ? 'Q1' : q === 'Q3' ? 'Q2' : 'Q3';
          prevV = matrix[y][prevQ];
        }
        let pctStr = '';
        let bg;
        if (currentHeatmapView === 'pct' && prevV != null && prevV !== 0) {
          const pct = ((v - prevV) / prevV) * 100;
          pctStr = (pct >= 0 ? '+' : '') + pct.toFixed(1) + '%';
          bg = heatmapColorPct(pct);
        } else {
          const { min, max } = colStats[q];
          const ratio = max > min ? (v - min) / (max - min) : 0.5;
          bg = heatmapColorAbs(ratio);
        }
        const cellContent = (currentHeatmapView === 'pct' && pctStr)
          ? `<span class="heatmap-abs-val">${fmt(v, 0)}</span><span class="heatmap-pct-val">${pctStr}</span>`
          : fmt(v, 0);
        html += `<td style="background:${bg};color:#e6edf3">${cellContent}</td>`;
      }
    }
    html += '</tr>';
  }
  html += '</tbody></table>';
  container.innerHTML = html;
}

function downloadQuarterlyHeatmapCSV(productKey) {
  const quarters = ['Q1','Q2','Q3','Q4'];
  const years = [...DATA.years].reverse();
  const matrix = {};
  for (const y of years) {
    matrix[y] = {};
    for (const q of quarters) {
      const vals = DATA.master.filter(r => r.year === y && r.quarter === q && r[productKey] != null).map(r => r[productKey]);
      matrix[y][q] = vals.length ? mean(vals) : null;
    }
  }
  const headers = ['Year', ...quarters];
  const rows = years.map(y => [y, ...quarters.map(q => matrix[y][q] != null ? matrix[y][q].toFixed(2) : '')]);
  downloadCSV(`quarterly_heatmap_${productKey}.csv`, headers, rows);
}

// ---- CHANGE 6: Spaghetti Chart ----
function renderSpaghettiChart(productKey) {
  const quarters = ['Q1','Q2','Q3','Q4'];
  const qColors  = { Q1: '#58a6ff', Q2: '#3fb950', Q3: '#f0883e', Q4: '#a371f7' };
  const years = DATA.years;

  // Build qAvg per year per quarter
  const qData = { Q1: [], Q2: [], Q3: [], Q4: [] };
  const xLabels = years.map(String);

  for (const q of quarters) {
    for (const y of years) {
      qData[q].push(getQAvgCached(productKey, y, q));
    }
  }

  const datasets = quarters.map(q => ({
    label: q,
    data: qData[q],
    borderColor: qColors[q],
    backgroundColor: 'transparent',
    borderWidth: 2,
    pointRadius: 3,
    tension: 0.2,
    spanGaps: true,
  }));

  destroyChart('spaghettiChart');
  const canvas = document.getElementById('spaghettiChart');
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  chartRegistry['spaghettiChart'] = new Chart(ctx, {
    type: 'line',
    data: { labels: xLabels, datasets },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: { mode: 'index', intersect: false },
      plugins: {
        legend: { position: 'top', labels: { usePointStyle: true } },
        tooltip: {
          callbacks: {
            title: ctx => `Year ${ctx[0].label}`,
            label: ctx => ` ${ctx.dataset.label}: ${fmt(ctx.parsed.y)}`,
          },
        },
      },
      scales: {
        x: {
          grid: { color: '#151a22' },
          ticks: { font: { size: 11 }, maxTicksLimit: 16 },
          title: { display: true, text: 'Year', color: '#8b949e', font: { size: 11 } },
        },
        y: {
          grid: { color: '#151a22' },
          ticks: { font: { size: 11 }, callback: v => fmt(v) },
          title: { display: true, text: PRODUCTS[productKey].label, color: '#8b949e', font: { size: 11 } },
        },
      },
    },
  });
}

// =====================================================================
// INDICES TAB (CHANGE 7)
// =====================================================================
function renderIndicesTab() {
  const grid = document.getElementById('indicesGrid');
  grid.innerHTML = '';

  PRODUCT_KEYS.forEach(key => {
    const prod = PRODUCTS[key];
    if (PRODUCTS[key].computed) return; // composite ‚Äî no raw rows, skip card
    const rows = DATA.raw[key];
    if (!rows || !rows.length) return;

    const latest = rows[rows.length - 1];
    const prev   = rows[rows.length - 2];
    const chg    = prev ? ((latest.value - prev.value) / prev.value * 100) : null;
    const chgStr = chg != null ? `${chg >= 0 ? '+' : ''}${chg.toFixed(2)}%` : '‚Äî';
    const chgCls = chg == null ? '' : (chg >= 0 ? 'change-pos' : 'change-neg');

    // Stats strip values
    const allVals = rows.map(r => r.value);
    const ath = Math.max(...allVals);
    const atl = Math.min(...allVals);
    const vsAth = ((latest.value - ath) / ath * 100).toFixed(1) + '%';

    // YTD %: compare to last value of prior year
    const currentYear = latest.date.getFullYear();
    const jan1 = new Date(currentYear, 0, 1);
    const priorYearRows = rows.filter(r => r.date < jan1);
    const ytdBase = priorYearRows.length ? priorYearRows[priorYearRows.length - 1].value : null;
    let ytdStr = '‚Äî', ytdCls = '';
    if (ytdBase) {
      const ytd = ((latest.value - ytdBase) / ytdBase * 100);
      ytdStr = (ytd >= 0 ? '+' : '') + ytd.toFixed(1) + '%';
      ytdCls = ytd >= 0 ? 'val-green' : 'val-red';
    }
    const vsCls = parseFloat(vsAth) >= 0 ? 'val-green' : (parseFloat(vsAth) < -30 ? 'val-red' : 'val-yellow');

    const cardId  = `idxCard_${key}`;
    const canvasId = `idxChart_${key}`;

    const card = document.createElement('div');
    card.className = 'index-chart-card';
    card.id = cardId;

    // Compute total rows and default 5Y range
    const totalRows = DATA.raw[key].length;
    const cutoff5y = new Date(); cutoff5y.setFullYear(cutoff5y.getFullYear() - 5);
    const defaultStartIdx = DATA.raw[key].findIndex(r => r.date >= cutoff5y);
    const startIdx5y = defaultStartIdx < 0 ? 0 : defaultStartIdx;

    card.innerHTML = `
      <div class="card-header-bar">${prod.label}</div>
      <div class="index-chart-header">
        <div class="index-chart-subtitle">
          <span>${fmt(latest.value)}</span>
          <span class="${chgCls}">${chgStr}</span>
        </div>
      </div>
      <div class="index-chart-canvas-wrap">
        <canvas id="${canvasId}"></canvas>
      </div>
      <div class="index-range-wrap">
        <div class="index-range-label">
          <span>Range:</span>
          <span id="rangeLabel_${key}">Loading‚Ä¶</span>
        </div>
        <div class="dual-range-track" id="rangeTrack_${key}">
          <div class="dual-range-fill" id="rangeFill_${key}"></div>
          <input type="range" id="rangeStart_${key}" min="0" max="${totalRows - 1}" value="${startIdx5y}" step="1">
          <input type="range" id="rangeEnd_${key}"   min="0" max="${totalRows - 1}" value="${totalRows - 1}" step="1">
        </div>
      </div>
      <div class="index-stats-strip">
        <div class="index-stat-mini">
          <div class="index-stat-mini-label">All-Time High</div>
          <div class="index-stat-mini-val val-white">${fmt(ath)}</div>
        </div>
        <div class="index-stat-mini">
          <div class="index-stat-mini-label">All-Time Low</div>
          <div class="index-stat-mini-val val-white">${fmt(atl)}</div>
        </div>
        <div class="index-stat-mini">
          <div class="index-stat-mini-label">Current vs ATH</div>
          <div class="index-stat-mini-val ${vsCls}">${vsAth}</div>
        </div>
        <div class="index-stat-mini">
          <div class="index-stat-mini-label">YTD %</div>
          <div class="index-stat-mini-val ${ytdCls}">${ytdStr}</div>
        </div>
      </div>`;
    grid.appendChild(card);

    // Wire up dual range slider
    initIndexRangeSlider(key, totalRows);
    buildIndexChartByRange(key, startIdx5y, totalRows - 1);
  });
}

function initIndexRangeSlider(key, totalRows) {
  const startEl = document.getElementById('rangeStart_' + key);
  const endEl   = document.getElementById('rangeEnd_'   + key);
  const fillEl  = document.getElementById('rangeFill_'  + key);
  const labelEl = document.getElementById('rangeLabel_' + key);
  if (!startEl || !endEl) return;

  function updateSlider() {
    let s = parseInt(startEl.value);
    let e = parseInt(endEl.value);
    if (s > e) {
      // Swap if crossed
      if (this === startEl) { startEl.value = e; s = e; }
      else { endEl.value = s; e = s; }
    }
    // Update fill bar
    const pctStart = (s / (totalRows - 1)) * 100;
    const pctEnd   = (e / (totalRows - 1)) * 100;
    fillEl.style.left  = pctStart + '%';
    fillEl.style.width = (pctEnd - pctStart) + '%';
    // Update label
    const rows = DATA.raw[key];
    const startDate = rows[s] ? rows[s].date.toISOString().split('T')[0].slice(0,7) : '';
    const endDate   = rows[e] ? rows[e].date.toISOString().split('T')[0].slice(0,7) : '';
    labelEl.textContent = startDate + ' ‚Üí ' + endDate;
    // Rebuild chart
    buildIndexChartByRange(key, s, e);
  }

  startEl.addEventListener('input', updateSlider);
  endEl.addEventListener('input', updateSlider);
  // Trigger initial render
  updateSlider.call(startEl);
}

function buildIndexChartByRange(key, startIdx, endIdx) {
  const prod = PRODUCTS[key];
  const allRows = DATA.raw[key];
  if (!allRows || !allRows.length) return;

  const rows = allRows.slice(startIdx, endIdx + 1);
  const labels = rows.map(r => r.date.toISOString().split('T')[0]);
  const values = rows.map(r => r.value);

  destroyChart('idxChart_' + key);
  const canvas = document.getElementById('idxChart_' + key);
  if (!canvas) return;
  const ctx = canvas.getContext('2d');

  chartRegistry['idxChart_' + key] = new Chart(ctx, {
    type: 'line',
    data: {
      labels,
      datasets: [{
        label: prod.label,
        data: values,
        borderColor: prod.color,
        backgroundColor: prod.color + '18',
        borderWidth: 1.5,
        pointRadius: 0,
        fill: true,
        tension: 0.1,
      }],
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            label: ctx => ` ${fmt(ctx.parsed.y)}`,
            title: ctx => ctx[0].label,
          },
        },
      },
      scales: {
        x: {
          grid: { color: '#151a22' },
          ticks: {
            maxTicksLimit: 8,
            font: { size: 10 },
            callback: function(val, idx) {
              return labels[idx] ? labels[idx].slice(0, 7) : '';
            },
          },
        },
        y: {
          grid: { color: '#151a22' },
          ticks: { font: { size: 10 }, callback: v => fmt(v) },
        },
      },
    },
  });
}

// =====================================================================
// ETF TAB (CHANGE 8)
// =====================================================================
async function renderETFTab() {
  const grid = document.getElementById('etfGrid');
  if (grid.dataset.rendered) return;
  grid.dataset.rendered = '1';
  grid.innerHTML = '';

  await Promise.all([
    renderETFCard('BDRY', 'Breakwave Dry Bulk Shipping ETF', DATA.bdryHoldings, 'bdry', grid),
    renderETFCard('BWET', 'Breakwave Tanker Shipping ETF',   DATA.bwetHoldings, 'bwet', grid),
  ]);

  // Load BDRY liquidity tracker (async, non-blocking)
  renderBdryLiquidityTracker();
}

function classifyHolding(name, ticker, etf) {
  const n = (name || '').toLowerCase();
  const t = (ticker || '').toLowerCase();
  if (etf === 'bdry') {
    if (n.includes('capesize') || t.includes('c5tcm')) return 'cape';
    if (n.includes('panamax')  || t.includes('p5tcm')) return 'pana';
    if (n.includes('supramax') || t.includes('s58fm')) return 'supra';
    return 'cash';
  } else {
    if (n.includes('td3c') || t.includes('dd3cm')) return 'td3c';
    if (n.includes('td20') || t.includes('dd20m')) return 'td20';
    return 'cash';
  }
}

function shortenName(name) {
  return name
    .replace(/Capesize 5TC FFA 180kt Timecharter Average /i, 'Cape 5TC ')
    .replace(/Panamax 5TC FFA 82kt Timecharter Average /i, 'Panamax 5TC ')
    .replace(/Supramax 58 TC FFA 58kt Timecharter Average /i, 'Supra 58 ')
    .replace(/TD20 FFA 130kt West Africa to Continent USD\/MT /i, 'TD20 ')
    .replace(/TD3C FFA 270kt Middle East Gulf to China USD\/MT /i, 'TD3C ')
    .replace(/Invesco Government & Agency Portfolio .*/i, 'Invesco Govt Portfolio')
    .replace(/M (Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec) (\d+)/, '$1 $2');
}

async function renderETFCard(ticker, name, holdings, etfKey, grid) {
  const card = document.createElement('div');
  card.className = 'etf-card';
  card.id = `etfCard_${etfKey}`;
  grid.appendChild(card);

  let priceHTML = '<span style="color:var(--text-muted)">Fetching‚Ä¶</span>';
  card.innerHTML = buildETFCardHTML(ticker, name, holdings, etfKey, priceHTML);
  buildETFDonut(etfKey, holdings);

  // Wire CSV download buttons (CHANGE 8)
  const dlBtn = card.querySelector(`.etf-dl-btn`);
  if (dlBtn) {
    dlBtn.addEventListener('click', () => downloadETFHoldings(ticker, etfKey, holdings));
  }

  try {
    const yahooUrl = `https://query1.finance.yahoo.com/v8/finance/chart/${ticker}?interval=1d&range=1d`;
    // Try multiple CORS proxies in sequence for reliability
    const proxyFns = [
      u => `https://corsproxy.io/?${encodeURIComponent(u)}`,
      u => `https://api.allorigins.win/get?url=${encodeURIComponent(u)}`,
      u => `https://thingproxy.freeboard.io/fetch/${u}`,
    ];
    let meta = null;
    for (const makeProxy of proxyFns) {
      try {
        const proxyUrl = makeProxy(yahooUrl);
        const resp = await fetch(proxyUrl, { signal: AbortSignal.timeout(8000) });
        if (!resp.ok) continue;
        const text = await resp.text();
        // allorigins wraps in {contents:...}; others return raw JSON
        let parsed;
        try {
          const wrapper = JSON.parse(text);
          parsed = (wrapper.contents) ? JSON.parse(wrapper.contents) : wrapper;
        } catch { continue; }
        const r = parsed?.chart?.result?.[0]?.meta;
        if (r && r.regularMarketPrice != null) { meta = r; break; }
      } catch { continue; }
    }
    if (meta) {
      const price = meta.regularMarketPrice;
      const chgPct = meta.regularMarketChangePercent;
      const sign = chgPct >= 0 ? '+' : '';
      const chgCls = chgPct >= 0 ? 'change-pos' : 'change-neg';
      priceHTML = `
        <span class="etf-price">${price != null ? '$' + price.toFixed(2) : '‚Äî'}</span>
        <span class="etf-change ${chgCls}">${chgPct != null ? sign + chgPct.toFixed(2) + '%' : ''}</span>`;
    } else {
      priceHTML = '<span style="color:var(--text-muted);font-size:13px">Price unavailable</span>';
    }
    if (meta) {
      const navEl = card.querySelector(`#etfNav_${etfKey}`);
      if (navEl) {
        const nav = meta.navPrice ?? meta.regularMarketPrice;
        navEl.textContent = nav != null ? '$' + nav.toFixed(2) : '‚Äî';
      }
    }
  } catch (e) {
    priceHTML = '<span style="color:var(--text-muted);font-size:13px">Price unavailable</span>';
  }

  const priceEl = card.querySelector('.etf-price-row');
  if (priceEl) priceEl.innerHTML = priceHTML;
}

function downloadETFHoldings(ticker, etfKey, holdings) {
  const sorted = sortHoldings([...holdings], etfKey);
  const headers = ['Name','Ticker','Lots','Price','Market Value','Weighting'];
  const rows = sorted.map(h => [
    h.Name || '',
    h.Ticker || '',
    h.Lots || '',
    h.Price || '',
    h.Market_Value || '',
    h.Weightings || '',
  ]);
  const filename = ticker === 'BDRY' ? 'bdry_holdings_export.csv' : 'bwet_holdings_export.csv';
  downloadCSV(filename, headers, rows);
}

function buildETFCardHTML(ticker, name, holdings, etfKey, priceHTML) {
  const sorted = sortHoldings([...holdings], etfKey);

  let tableRows = '';
  for (const h of sorted) {
    const cls = classifyHolding(h.Name, h.Ticker, etfKey);
    const rowCls = `row-${cls}`;
    const shortName = shortenName(h.Name || '');
    const lots = parseFloat(h.Lots) || 0;
    const price = parseFloat(h.Price) || 0;
    const mv = parseFloat(h.Market_Value) || 0;
    const wt = h.Weightings || '‚Äî';
    tableRows += `<tr>
      <td class="${rowCls}">${shortName}</td>
      <td>${lots % 1 === 0 ? fmt(lots) : lots.toLocaleString()}</td>
      <td>${price < 200 ? price.toFixed(3) : fmt(price)}</td>
      <td>$${(mv / 1e6).toFixed(2)}M</td>
      <td>${wt}</td>
    </tr>`;
  }

  const futuresRows = holdings.filter(h => classifyHolding(h.Name, h.Ticker, etfKey) !== 'cash');
  const cashRows    = holdings.filter(h => classifyHolding(h.Name, h.Ticker, etfKey) === 'cash');
  const totalFutures = futuresRows.reduce((s, h) => s + (parseFloat(h.Market_Value) || 0), 0);
  const totalCash    = cashRows.reduce((s, h) => s + (parseFloat(h.Market_Value) || 0), 0);
  const totalAUM     = totalFutures + totalCash;

  const leverageVal = totalCash > 0 ? ((totalAUM / totalCash) - 1) : null;
  const leverageStr = leverageVal !== null ? (leverageVal * 100).toFixed(1) + '%' : '‚Äî';

  return `
    <div class="etf-header">
      <div class="etf-ticker">${ticker}</div>
      <div class="etf-name">${name}</div>
      <div class="etf-price-row">${priceHTML}</div>
    </div>

    <div class="etf-holdings-section">
    <div class="etf-section-title-row">
      <div class="etf-section-title">Holdings</div>
      <button class="dl-btn etf-dl-btn">‚¨á CSV</button>
    </div>
    <table class="holdings-table">
      <thead><tr>
        <th>Name</th>
        <th>Lots</th>
        <th>Price</th>
        <th>Mkt Value</th>
        <th>Weight</th>
      </tr></thead>
      <tbody>${tableRows}</tbody>
    </table>
    </div>

    <div class="etf-section-title" style="margin:16px 0 8px">Futures Allocation (excl. collateral cash)</div>
    <div class="donut-wrap">
      <canvas id="donut_${etfKey}"></canvas>
    </div>

    <div class="etf-metrics" style="grid-template-columns: repeat(3,1fr); margin-bottom:8px;">
      <div class="etf-metric">
        <div class="etf-metric-label">Total Futures</div>
        <div class="etf-metric-value">$${(totalFutures / 1e6).toFixed(1)}M</div>
      </div>
      <div class="etf-metric">
        <div class="etf-metric-label">Collateral Cash</div>
        <div class="etf-metric-value" style="color:var(--text-muted)">$${(totalCash / 1e6).toFixed(1)}M</div>
      </div>
      <div class="etf-metric">
        <div class="etf-metric-label">Futures / AUM</div>
        <div class="etf-metric-value" style="color:var(--green)">${(totalFutures / totalAUM * 100).toFixed(1)}%</div>
      </div>
    </div>
    <div class="etf-metrics" style="grid-template-columns: repeat(3,1fr);">
      <div class="etf-metric">
        <div class="etf-metric-label">NAV</div>
        <div class="etf-metric-value etf-nav-val" id="etfNav_${etfKey}">‚Äî</div>
      </div>
      <div class="etf-metric">
        <div class="etf-metric-label">Expense Ratio</div>
        <div class="etf-metric-value" style="color:var(--text-muted)">3.50%</div>
      </div>
      <div class="etf-metric">
        <div class="etf-metric-label">Leverage</div>
        <div class="etf-metric-value" style="color:var(--yellow)">${leverageStr}</div>
      </div>
    </div>
    ${etfKey === 'bdry' ? `
    <div class="etf-image-block">
      <img src="BDRY_Export-Map-1024x548.webp" alt="BDRY Export Map" class="etf-card-image" />
      <div class="etf-map-legend">
        <div class="etf-legend-item"><span class="etf-legend-dot">‚ö´</span>Major Dry Bulk Exporting Nations</div>
        <div class="etf-legend-sep"></div>
        <div class="etf-legend-item"><span class="etf-legend-dot">üîµ</span>Major Dry Bulk Importing Nations</div>
        <div class="etf-legend-sep"></div>
        <div class="etf-legend-line"><span class="etf-legend-dash"></span>Dry Bulk Routes</div>
      </div>
    </div>
    <div class="etf-fundamentals-section">
      <div class="etf-research-title">üö¢ Dry Bulk Fundamentals ‚Äî Data Sources</div>
      <div class="etf-fund-group">
        <div class="etf-fund-group-label">China Steel &amp; Bulk Demand</div>
        <div class="etf-fund-link"><span class="research-link-icon">üìä</span><a href="https://en.macromicro.me/collections/20/mm-steel/221/china-crude-steel-production" target="_blank" rel="noopener">China Steel Production</a></div>
        <div class="etf-fund-link"><span class="research-link-icon">üì¶</span><a href="https://en.macromicro.me/collections/20/mm-steel/7688/china-total-inventories-of-major-steel-products" target="_blank" rel="noopener">China Steel Inventories</a></div>
        <div class="etf-fund-link"><span class="research-link-icon">‚õèÔ∏è</span><a href="https://en.macromicro.me/collections/20/mm-steel/208/cn-china-iron-ore-inventory" target="_blank" rel="noopener">China Iron Ore Inventories</a></div>
        <div class="etf-fund-link"><span class="research-link-icon">üö¢</span><a href="https://en.macromicro.me/series/1323/cn-import-volume-of-iron-ore-and-concentrate" target="_blank" rel="noopener">China Iron Ore Imports</a></div>
        <div class="etf-fund-link"><span class="research-link-icon">üî•</span><a href="https://en.macromicro.me/series/1327/cn-import-volume-of-coal-and-lignite" target="_blank" rel="noopener">China Coal Imports</a></div>
        <div class="etf-fund-link"><span class="research-link-icon">üå±</span><a href="https://en.macromicro.me/series/7453/china-soybean-import" target="_blank" rel="noopener">China Soybean Imports</a></div>
      </div>
      <div class="etf-fund-group">
        <div class="etf-fund-group-label">Export Flow Indicators</div>
        <div class="etf-fund-link"><span class="research-link-icon">üáßüá∑</span><a href="https://en.macromicro.me/charts/43101/brazil-export" target="_blank" rel="noopener">Brazil Iron Ore Exports</a></div>
        <div class="etf-fund-link"><span class="research-link-icon">üá¶üá∫</span><a href="https://en.macromicro.me/series/4676/australia-iron-ore-export-value" target="_blank" rel="noopener">Australia Iron Ore Export Value</a></div>
      </div>
    </div>` : `
    <div class="etf-image-block">
      <img src="BWET_Tanker-Map-1-1024x585.webp" alt="BWET Tanker Map" class="etf-card-image" />
      <div class="etf-map-legend">
        <div class="etf-legend-item"><span class="etf-legend-dot">‚ö´</span>Major Crude Exporting Nations</div>
        <div class="etf-legend-sep"></div>
        <div class="etf-legend-item"><span class="etf-legend-dot">üîµ</span>Major Crude Importing Nations</div>
        <div class="etf-legend-sep"></div>
        <div class="etf-legend-line"><span class="etf-legend-dash"></span>Major Crude Tanker Routes</div>
        <div class="etf-legend-sep"></div>
        <div class="etf-legend-item"><span class="etf-legend-dot">üü™</span>BWET Focused Routes</div>
      </div>
    </div>
    <div class="etf-fundamentals-section">
      <div class="etf-research-title">üõ¢ Tanker Fundamentals ‚Äî Data Sources</div>
      <div class="etf-fund-group">
        <div class="etf-fund-group-label">Crude &amp; Product Demand</div>
        <div class="etf-fund-link"><span class="research-link-icon">üõ¢</span><a href="https://tradingeconomics.com/commodity/crude-oil" target="_blank" rel="noopener">WTI Crude Oil Price</a></div>
        <div class="etf-fund-link"><span class="research-link-icon">üì¶</span><a href="https://www.eia.gov/petroleum/supply/weekly/" target="_blank" rel="noopener">US Crude Oil Inventories</a></div>
        <div class="etf-fund-link"><span class="research-link-icon">üá®üá≥</span><a href="https://tradingeconomics.com/china/crude-oil-imports" target="_blank" rel="noopener">China Crude Oil Imports</a></div>
        <div class="etf-fund-link"><span class="research-link-icon">üè≠</span><a href="https://tradingeconomics.com/china/refinery-throughput" target="_blank" rel="noopener">China Refinery Throughput</a></div>
        <div class="etf-fund-link"><span class="research-link-icon">üìä</span><a href="https://www.eia.gov/petroleum/weekly/crude.php" target="_blank" rel="noopener">US Crude Oil Production</a></div>
        <div class="etf-fund-link"><span class="research-link-icon">üõë</span><a href="https://tradingeconomics.com/opec/crude-oil-production" target="_blank" rel="noopener">OPEC Crude Oil Production</a></div>
      </div>
      <div class="etf-fund-group">
        <div class="etf-fund-group-label">Key Trade Routes</div>
        <div class="etf-fund-link"><span class="research-link-icon">üü™</span><a href="https://in.tradingview.com/symbols/NYMEX-TL1!/" target="_blank" rel="noopener">TD3C ‚Äî Ras Tanura (MEG) ‚Üí Ningbo (Far East)</a></div>
        <div class="etf-fund-link"><span class="research-link-icon">üü™</span><a href="https://in.tradingview.com/symbols/NYMEX-T2D1!/" target="_blank" rel="noopener">TD20 ‚Äî Nigeria (WAF) ‚Üí Rotterdam</a></div>
      </div>
    </div>`}
    <div class="etf-research-section">
      <div class="etf-research-title">üì∞ Market Outlook &amp; Research Sources</div>
      <div class="research-group">
        <div class="research-group-label">Monthly &amp; Weekly Market Outlooks</div>
        <div class="research-link"><span class="research-link-icon">üèõÔ∏è</span><a href="https://www.atheniansa.com/reports" target="_blank" rel="noopener">Athenia S.A. ‚Äî Reports &amp; Market Outlooks</a></div>
        <div class="research-link"><span class="research-link-icon">üìã</span><a href="https://www.breakwaveadvisors.com/publications" target="_blank" rel="noopener">Breakwave Advisors ‚Äî Research (New report every 2nd &amp; 4th Tuesday)</a></div>
        <div class="research-link"><span class="research-link-icon">üîó</span><a href="https://www.bimco.org/news-and-trends/market-analysis" target="_blank" rel="noopener">BIMCO ‚Äî Market Analysis</a></div>
      </div>
      <div class="research-group">
        <div class="research-group-label">ETF Data</div>
        <div class="research-link"><span class="research-link-icon">üìà</span><a href="${etfKey === 'bdry' ? 'https://amplifyetfs.com/bdry/' : 'https://amplifyetfs.com/bwet/'}" target="_blank" rel="noopener">Amplify ETFs ‚Äî ${ticker} Official Page</a></div>
        <div class="research-link"><span class="research-link-icon">üìê</span><a href="${etfKey === 'bdry' ? 'https://www.solactive.com/index/DE000SLA4BY3/' : 'https://www.solactive.com/index/DE000SL0HLG3/'}" target="_blank" rel="noopener">Solactive ‚Äî ${etfKey === 'bdry' ? 'Breakwave Dry Freight Futures Index' : 'Breakwave Wet Freight Futures Index'}</a></div>
      </div>
    </div>
`;
}

function sortHoldings(holdings, etfKey) {
  const order = etfKey === 'bdry'
    ? ['cape', 'pana', 'supra', 'cash']
    : ['td3c', 'td20', 'cash'];
  holdings.sort((a, b) => {
    const ca = classifyHolding(a.Name, a.Ticker, etfKey);
    const cb = classifyHolding(b.Name, b.Ticker, etfKey);
    const ia = order.indexOf(ca); const ib = order.indexOf(cb);
    if (ia !== ib) return ia - ib;
    // Sort within class by contract month (earliest first), cash/non-dated last
    const pa = parseContractMonth(a.Name, a.Ticker);
    const pb = parseContractMonth(b.Name, b.Ticker);
    const ka = pa ? pa.sortKey : 999999;
    const kb = pb ? pb.sortKey : 999999;
    return ka - kb;
  });
  return holdings;
}

function buildETFDonut(etfKey, holdings) {
  const groups = {};
  for (const h of holdings) {
    const cls = classifyHolding(h.Name, h.Ticker, etfKey);
    groups[cls] = (groups[cls] || 0) + (parseFloat(h.Market_Value) || 0);
  }

  // Cash is structural margin collateral (pledged for futures per SEC filings) ‚Äî excluded.
  // Chart shows only futures notional, normalised to 100%.
  let labels, values, colors;
  if (etfKey === 'bdry') {
    labels = ['Capesize', 'Panamax', 'Supramax'];
    values = [groups.cape||0, groups.pana||0, groups.supra||0];
    colors = ['#58a6ff', '#3fb950', '#d29922'];
  } else {
    labels = ['MEG-China (TD3C)', 'WAF-Continent (TD20)'];
    values = [groups.td3c||0, groups.td20||0];
    colors = ['#f0883e', '#a371f7'];
  }

  // Normalise to 100% of futures notional
  const totalFuturesNotional = values.reduce((s, v) => s + v, 0);
  values = totalFuturesNotional > 0 ? values.map(v => (v / totalFuturesNotional) * 100) : values;

  setTimeout(() => {
    const canvas = document.getElementById(`donut_${etfKey}`);
    if (!canvas) return;
    destroyChart(`donut_${etfKey}`);
    const ctx = canvas.getContext('2d');
    chartRegistry[`donut_${etfKey}`] = new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels,
        datasets: [{
          data: values,
          backgroundColor: colors,
          borderColor: '#0f1318',
          borderWidth: 2,
        }],
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: 'right',
            labels: { font: { size: 11 }, padding: 8, usePointStyle: true },
          },
          tooltip: {
            callbacks: {
              label: ctx => ` ${ctx.label}: ${ctx.parsed.toFixed(1)}% of futures`,
            },
          },
        },
      },
    });
  }, 50);
}

// =====================================================================
// FEATURE B ‚Äî Recent Daily Changes Table
// =====================================================================
let _recentChangesKey = null;
let _recentChangesRows = null;

function renderRecentChanges(productKey) {
  _recentChangesKey = productKey;
  const allRows = DATA.master.filter(r => r[productKey] != null);
  const totalLen = allRows.length;
  const startIdx = Math.max(0, totalLen - 10);
  const displayRows = allRows.slice(startIdx);
  _recentChangesRows = displayRows;

  let html = `<table class="yearly-table">
    <thead><tr>
      <th style="text-align:left">Date</th>
      <th>Index Value</th>
      <th>Day Œî</th>
      <th>Day Œî%</th>
      <th>5D Chg%</th>
    </tr></thead><tbody>`;

  for (let i = 0; i < displayRows.length; i++) {
    const row = displayRows[i];
    const allIdx = startIdx + i;
    const prevRow = allIdx > 0 ? allRows[allIdx - 1] : null;
    const dayDelta   = prevRow ? (row[productKey] - prevRow[productKey]) : null;
    const dayDeltaPct = prevRow && prevRow[productKey] ? ((row[productKey] - prevRow[productKey]) / prevRow[productKey] * 100) : null;

    const row5back = allIdx >= 5 ? allRows[allIdx - 5] : null;
    const chg5d = row5back && row5back[productKey] ? ((row[productKey] - row5back[productKey]) / row5back[productKey] * 100) : null;

    const dateStr = row.date.toISOString().split('T')[0];

    const ddStr   = dayDelta    != null ? (dayDelta    >= 0 ? '+' : '') + dayDelta.toFixed(0)      : '‚Äî';
    const ddPStr  = dayDeltaPct != null ? (dayDeltaPct >= 0 ? '+' : '') + dayDeltaPct.toFixed(2) + '%' : '‚Äî';
    const c5dStr  = chg5d       != null ? (chg5d       >= 0 ? '+' : '') + chg5d.toFixed(2)       + '%' : '‚Äî';

    const ddCls   = dayDelta    == null ? '' : (dayDelta    >= 0 ? 'val-green' : 'val-red');
    const ddPCls  = dayDeltaPct == null ? '' : (dayDeltaPct >= 0 ? 'val-green' : 'val-red');
    const c5dCls  = chg5d       == null ? '' : (chg5d       >= 0 ? 'val-green' : 'val-red');

    html += `<tr>
      <td style="text-align:left;color:var(--text-muted);font-weight:600">${dateStr}</td>
      <td>${fmt(row[productKey], 0)}</td>
      <td class="${ddCls}">${ddStr}</td>
      <td class="${ddPCls}">${ddPStr}</td>
      <td class="${c5dCls}">${c5dStr}</td>
    </tr>`;
  }

  html += '</tbody></table>';
  const container = document.getElementById('recentChangesTable');
  if (container) container.innerHTML = html;

  // Wire download button
  const dlBtn = document.getElementById('recentDlBtn');
  if (dlBtn) dlBtn.onclick = () => downloadRecentChanges(productKey);
}

function downloadRecentChanges(productKey) {
  if (!_recentChangesRows) return;
  const allRows = getRows(productKey);
  const totalLen = allRows.length;
  const startIdx = Math.max(0, totalLen - 10);
  const headers = ['Date','Value','Day Change','Day Change %','5D Change %'];
  const rows = _recentChangesRows.map((row, i) => {
    const allIdx = startIdx + i;
    const prevRow = allIdx > 0 ? allRows[allIdx - 1] : null;
    const row5back = allIdx >= 5 ? allRows[allIdx - 5] : null;
    const dayDelta    = prevRow ? (row[productKey] - prevRow[productKey]) : null;
    const dayDeltaPct = prevRow && prevRow[productKey] ? ((row[productKey] - prevRow[productKey]) / prevRow[productKey] * 100) : null;
    const chg5d       = row5back && row5back[productKey] ? ((row[productKey] - row5back[productKey]) / row5back[productKey] * 100) : null;
    return [
      row.date.toISOString().split('T')[0],
      row[productKey] != null ? row[productKey].toFixed(2) : '',
      dayDelta    != null ? dayDelta.toFixed(2) : '',
      dayDeltaPct != null ? dayDeltaPct.toFixed(2) + '%' : '',
      chg5d       != null ? chg5d.toFixed(2) + '%' : '',
    ];
  });
  downloadCSV(`recent_changes_${productKey}.csv`, headers, rows);
}

function toggleMethodology() {
  const btn     = document.getElementById('methodologyToggle');
  const content = document.getElementById('methodologyContent');
  btn.classList.toggle('open');
  content.classList.toggle('open');
}

// =====================================================================
// TAB NAVIGATION
// =====================================================================
let currentTab = 'dashboard';
let currentProduct = 'bdiy';
let indicesRendered = false;

function switchTab(tabId) {
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.toggle('active', b.dataset.tab === tabId));
  document.querySelectorAll('.tab-panel').forEach(p => p.classList.toggle('active', p.id === `tab-${tabId}`));
  currentTab = tabId;

  if (!DATA.loaded) return;

  if (tabId === 'dashboard') renderDashboard(currentProduct);
  if (tabId === 'heatmaps')  renderHeatmaps(currentProduct);
  if (tabId === 'quarterly') renderQuarterlyTab(currentProduct);
  if (tabId === 'indices' && !indicesRendered) { renderIndicesTab(); indicesRendered = true; }
  if (tabId === 'etfs')     renderETFTab();
  if (tabId === 'yearly-dash')    renderYearlyDash(currentProduct);
  if (tabId === 'monthly-dash')   renderMonthlyDash(currentProduct);
  if (tabId === 'signals') renderSignalsTab(currentProduct);
}

document.querySelectorAll('.tab-btn').forEach(btn => {
  btn.addEventListener('click', () => switchTab(btn.dataset.tab));
});

document.getElementById('globalProduct').addEventListener('change', function() {
  currentProduct = this.value;
  if (!DATA.loaded) return;
  if (currentTab === 'dashboard') renderDashboard(currentProduct);
  if (currentTab === 'heatmaps')  renderHeatmaps(currentProduct);
  if (currentTab === 'quarterly') renderQuarterlyTab(currentProduct);
  if (currentTab === 'yearly-dash')    renderYearlyDash(currentProduct);
  if (currentTab === 'monthly-dash')   renderMonthlyDash(currentProduct);
  if (currentTab === 'signals') renderSignalsTab(currentProduct);
});

// =====================================================================
// BOOTSTRAP
// =====================================================================
(async function init() {
  try {
    await loadAllData();
    renderDashboard(currentProduct);
  } catch (err) {
    document.getElementById('loadingOverlay').classList.add('hidden');
    document.getElementById('tab-dashboard').innerHTML =
      `<div class="error-msg">‚ùå Failed to load data: ${err.message}. Make sure CSV files are accessible.</div>`;
    console.error(err);
  }
})();

// =====================================================================
// YEARLY DASHBOARD TAB
// =====================================================================
var _ydHistAvgWindow = 5; // tracks currently active avg window (5, 10, or 0=all-time)
var _ydHistProductKey = null;

function renderYearlyDash(productKey) {
  _ydHistProductKey = productKey;
  var fns = [
    function(){ renderYDKpi(productKey); },
    function(){ initYDHistChart(productKey); },
    function(){ renderYDZscore(productKey, false, 'yearlyZscoreChart'); },
    function(){ renderYDZscore(productKey, true,  'yearlyHistZscoreChart'); },
    function(){ renderYDMultiRates('yearlyMultiRatesChart'); },
    function(){ renderYDShippingRates(productKey, 'yearlyShippingRatesChart'); },
    function(){ renderYDRatesOverlay('yearlyRatesChart'); },
    function(){ renderYDDrawdown(productKey, 'yearlyDrawdownChart'); },
  ];
  fns.forEach(function(fn){
    try { fn(); } catch(e) { console.error('[YearlyDash]', e); }
  });
}

function setYDHistAvg(w) {
  _ydHistAvgWindow = w;
  // Update button active states
  ['5','10','All'].forEach(function(x){
    var id = 'ydAvgBtn' + x;
    var el = document.getElementById(id);
    if (el) el.classList.remove('active');
  });
  var activeId = w === 5 ? 'ydAvgBtn5' : w === 10 ? 'ydAvgBtn10' : 'ydAvgBtnAll';
  var activeEl = document.getElementById(activeId);
  if (activeEl) activeEl.classList.add('active');
  // Re-render chart with current slider positions
  if (_ydHistProductKey) rebuildYDHistChart(_ydHistProductKey);
}

function initYDHistChart(productKey) {
  var allRows = getRows(productKey);
  var total = allRows.length;
  if (!total) return;

  // Set slider max to total-1
  var startEl = document.getElementById('ydHistRangeStart');
  var endEl   = document.getElementById('ydHistRangeEnd');
  if (!startEl || !endEl) return;
  startEl.max = total - 1;
  endEl.max   = total - 1;
  startEl.value = 0;
  endEl.value   = total - 1;

  function onSlide() {
    var s = parseInt(startEl.value);
    var e = parseInt(endEl.value);
    if (s > e) {
      if (this === startEl) { startEl.value = e; s = e; }
      else { endEl.value = s; e = s; }
    }
    // Update fill
    var fillEl = document.getElementById('ydHistRangeFill');
    var labelEl = document.getElementById('ydHistRangeLabel');
    if (fillEl) {
      var pctS = (s / (total - 1)) * 100;
      var pctE = (e / (total - 1)) * 100;
      fillEl.style.left  = pctS + '%';
      fillEl.style.width = (pctE - pctS) + '%';
    }
    if (labelEl) {
      var sd = allRows[s] ? allRows[s].date.toISOString().split('T')[0].slice(0,7) : '';
      var ed = allRows[e] ? allRows[e].date.toISOString().split('T')[0].slice(0,7) : '';
      labelEl.textContent = sd + ' \u2192 ' + ed;
    }
    rebuildYDHistChart(productKey);
  }

  // Remove old listeners by cloning
  var newStart = startEl.cloneNode(true);
  var newEnd   = endEl.cloneNode(true);
  startEl.parentNode.replaceChild(newStart, startEl);
  endEl.parentNode.replaceChild(newEnd, endEl);
  newStart.addEventListener('input', onSlide);
  newEnd.addEventListener('input', onSlide);

  // Initial render
  onSlide.call(newStart);
}

function rebuildYDHistChart(productKey) {
  var allRows = getRows(productKey);
  var startEl = document.getElementById('ydHistRangeStart');
  var endEl   = document.getElementById('ydHistRangeEnd');
  if (!startEl || !endEl) return;
  var s = parseInt(startEl.value);
  var e = parseInt(endEl.value);
  var rows = allRows.slice(s, e + 1);
  if (!rows.length) return;

  var labels = rows.map(function(r){ return r.date.toISOString().split('T')[0]; });
  var values = rows.map(function(r){ return r[productKey]; });

  // Rolling avg ‚Äî window size based on _ydHistAvgWindow
  var winDays = _ydHistAvgWindow > 0 ? _ydHistAvgWindow * 252 : values.length;
  var rollingAvg = values.map(function(_, i) {
    var st = Math.max(0, i - winDays + 1);
    var sl = values.slice(st, i + 1).filter(function(v){ return v != null; });
    return sl.length ? sl.reduce(function(a,b){ return a+b; }, 0) / sl.length : null;
  });

  var avgLabel = _ydHistAvgWindow > 0 ? (_ydHistAvgWindow + 'Y Rolling Avg') : 'All-Time Avg';
  var prod = PRODUCTS[productKey];

  // Preserve hidden state from previous chart instance
  var histHiddenByLabel = {};
  var prevHistChart = chartRegistry['yearlyHistChart'];
  if (prevHistChart && prevHistChart.data && prevHistChart.data.datasets) {
    prevHistChart.data.datasets.forEach(function(ds, i) {
      histHiddenByLabel[ds.label] = !prevHistChart.isDatasetVisible(i);
    });
  }

  destroyChart('yearlyHistChart');
  var canvas = document.getElementById('yearlyHistChart');
  if (!canvas) return;
  chartRegistry['yearlyHistChart'] = new Chart(canvas.getContext('2d'), {
    type: 'line',
    data: { labels: labels, datasets: [
      { label: prod.label,  data: values,     borderColor: prod.color,  backgroundColor: prod.color + '33', borderWidth: 1.5, pointRadius: 0, fill: true,  tension: 0.1, hidden: histHiddenByLabel[prod.label] || false },
      { label: avgLabel,    data: rollingAvg, borderColor: '#e3b341',   backgroundColor: 'transparent',     borderWidth: 1.5, borderDash: [5,3], pointRadius: 0, fill: false, tension: 0.1, hidden: histHiddenByLabel[avgLabel] || false },
    ]},
    options: {
      responsive: true, maintainAspectRatio: false,
      interaction: { mode: 'index', intersect: false },
      plugins: {
        legend: { position: 'top', labels: { usePointStyle: true } },
        tooltip: { callbacks: { label: function(c){ return ' ' + c.dataset.label + ': ' + fmt(c.parsed.y); } } }
      },
      scales: {
        x: { grid: { color: '#151a22' }, ticks: { maxTicksLimit: 10, font: { size: 11 }, callback: function(_, i){ return labels[i] ? labels[i].slice(0,7) : ''; } } },
        y: { grid: { color: '#151a22' }, ticks: { font: { size: 11 }, callback: function(v){ return fmt(v); } } },
      },
    },
  });

  // Wire download button
  var btn = document.getElementById('ydHistDlBtn');
  if (btn) btn.onclick = function() {
    downloadCSV('hist_' + productKey + '.csv', ['Date', prod.label, avgLabel],
      rows.map(function(r, i){ return [labels[i], values[i]!=null?values[i].toFixed(2):'', rollingAvg[i]!=null?rollingAvg[i].toFixed(2):'']; }));
  };
}

function renderYDKpi(productKey) {
  var stats = getStats(productKey);
  var sig   = tradingSignal(stats);
  var prod  = PRODUCTS[productKey];
  var el    = document.getElementById('yd-kpi-row');
  if (!el) return;
  el.innerHTML =
    '<div class="current-price-block">' +
      '<div class="current-price-label">' + prod.label + '</div>' +
      '<div class="current-price-value" style="font-size:36px">' + (stats ? fmt(stats.currentPrice) : '&mdash;') + '</div>' +
      (stats && stats.pctChange != null
        ? '<div class="current-price-change ' + (stats.pctChange >= 0 ? 'change-pos' : 'change-neg') + '">' +
          (stats.pctChange >= 0 ? '+' : '') + stats.pctChange.toFixed(2) + '% vs prior day</div>'
        : '') +
    '</div>' +
    '<div class="signal-badge ' + sig.cls + '">' + sig.text + '</div>' +
    (stats ? (
      '<div class="stat-card sc-percentile" style="min-width:110px">' +
        '<div class="stat-label">5Y Pctl</div>' +
        '<div class="stat-value ' + pctColor(stats.pctl5y) + '">' + (stats.pctl5y * 100).toFixed(1) + '%</div>' +
      '</div>' +
      '<div class="stat-card sc-zscore" style="min-width:110px">' +
        '<div class="stat-label">Z-Score</div>' +
        '<div class="stat-value ' + (stats.zScore < -1 ? 'val-red' : stats.zScore > 1 ? 'val-green' : 'val-yellow') + '">' + stats.zScore.toFixed(2) + '</div>' +
      '</div>' +
      '<div class="stat-card sc-drawdown" style="min-width:110px">' +
        '<div class="stat-label">Drawdown</div>' +
        '<div class="stat-value ' + (stats.drawdown < -0.3 ? 'val-red' : stats.drawdown < -0.1 ? 'val-yellow' : 'val-green') + '">' + (stats.drawdown * 100).toFixed(1) + '%</div>' +
      '</div>'
    ) : '');
}

function computeRollingZscoreArr(values, windowSize) {
  return values.map(function(v, i) {
    if (v == null) return null;
    var start = Math.max(0, i - windowSize + 1);
    var slice = values.slice(start, i+1).filter(function(x) { return x != null; });
    if (slice.length < 20) return null;
    var m = slice.reduce(function(a,b){return a+b;},0) / slice.length;
    var sd = Math.sqrt(slice.reduce(function(a,b){return a+(b-m)*(b-m);},0) / slice.length);
    return sd > 0 ? (v - m) / sd : 0;
  });
}

// ‚îÄ‚îÄ Rolling Z-Score window state ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
var _ydZscoreWindow = 252;      // active rolling window (trading days)
var _ydZscoreProductKey = null; // cached so setYDZscoreWindow can re-render

var _ydZscoreWindowLabels = {
  63:  '3M (63-Day)',
  126: '6M (126-Day)',
  252: '1Y (252-Day)',
  504: '2Y (504-Day)',
  756: '3Y (756-Day)',
};

function setYDZscoreWindow(w) {
  _ydZscoreWindow = w;
  [63, 126, 252, 504, 756].forEach(function(x) {
    var el = document.getElementById('ydZscoreBtn' + x);
    if (el) el.classList.toggle('active', x === w);
  });
  var titleEl = document.getElementById('ydZscoreTitle');
  if (titleEl) titleEl.textContent = 'Z-Score (Rolling ' + _ydZscoreWindowLabels[w] + ')';
  if (_ydZscoreProductKey) renderYDZscore(_ydZscoreProductKey, false, 'yearlyZscoreChart');
}

function renderYDZscore(productKey, allTime, canvasId) {
  var cutoff2008 = new Date('2008-01-01');

  // Rolling chart uses selected window; historical all-time always 252
  var windowSize = allTime ? 252 : _ydZscoreWindow;
  if (!allTime) _ydZscoreProductKey = productKey;

  // Pre-compute z-scores for all products with the chosen window
  var allZData = {};
  PRODUCT_KEYS.forEach(function(key) {
    var allRows = DATA.master.filter(function(r){ return r[key] != null && r.date >= cutoff2008; });
    var zAll = computeRollingZscoreArr(allRows.map(function(r){ return r[key]; }), windowSize);
    allZData[key] = allRows.map(function(r, i){ return { dateStr: r.date.toISOString().split('T')[0], z: zAll[i] }; });
  });

  var masterLabels = allZData[productKey].map(function(d){ return d.dateStr; });
  var total = masterLabels.length;
  if (!total) return;

  var prefix = canvasId === 'yearlyZscoreChart' ? 'ydZscore' : 'ydHistZscore';
  var startEl = document.getElementById(prefix + 'RangeStart');
  var endEl   = document.getElementById(prefix + 'RangeEnd');
  var fillEl  = document.getElementById(prefix + 'RangeFill');
  var labelEl = document.getElementById(prefix + 'RangeLabel');

  if (!startEl || !endEl) {
    _buildZscoreChart(productKey, canvasId, allZData, masterLabels, 0, total - 1);
    return;
  }

  // First render: max is still HTML default 100 ‚Äî set it and apply default range
  // Subsequent calls (window change): max already equals total-1, preserve positions
  var firstRender = (parseInt(startEl.max) !== total - 1);
  startEl.max = total - 1;
  endEl.max   = total - 1;

  if (firstRender) {
    if (!allTime) {
      // Rolling default: last 3 years
      var cutoff3y = new Date(); cutoff3y.setFullYear(cutoff3y.getFullYear() - 3);
      var def3yIdx = 0;
      for (var ii = 0; ii < total; ii++) {
        if (new Date(masterLabels[ii]) >= cutoff3y) { def3yIdx = ii; break; }
      }
      startEl.value = def3yIdx;
      endEl.value   = total - 1;
    } else {
      startEl.value = 0;
      endEl.value   = total - 1;
    }
  }

  function updateFillAndLabel(s, e) {
    if (fillEl) {
      var pctS = (s / (total - 1)) * 100;
      var pctE = (e / (total - 1)) * 100;
      fillEl.style.left  = pctS + '%';
      fillEl.style.width = (pctE - pctS) + '%';
    }
    if (labelEl) labelEl.textContent = masterLabels[s].slice(0,7) + ' \u2192 ' + masterLabels[e].slice(0,7);
  }

  // Clone first, then define closure over ns/ne (live nodes) ‚Äî fixes detached-ref bug
  var ns = startEl.cloneNode(true); startEl.parentNode.replaceChild(ns, startEl);
  var ne = endEl.cloneNode(true);   endEl.parentNode.replaceChild(ne, endEl);

  function onSlide() {
    var s = parseInt(ns.value);
    var e = parseInt(ne.value);
    if (s > e) {
      if (document.activeElement === ns) { ns.value = e; s = e; }
      else { ne.value = s; e = s; }
    }
    updateFillAndLabel(s, e);
    _buildZscoreChart(productKey, canvasId, allZData, masterLabels, s, e);
  }

  ns.addEventListener('input', onSlide);
  ne.addEventListener('input', onSlide);

  var initS = parseInt(ns.value);
  var initE = parseInt(ne.value);
  updateFillAndLabel(initS, initE);
  _buildZscoreChart(productKey, canvasId, allZData, masterLabels, initS, initE);
}

function _buildZscoreChart(productKey, canvasId, allZData, masterLabels, s, e) {
  var slicedLabels = masterLabels.slice(s, e + 1);
  var slicedSet = {};
  slicedLabels.forEach(function(l){ slicedSet[l] = true; });

  // Preserve hidden state from previous chart instance (legend clicks)
  var hiddenByLabel = {};
  var prevChart = chartRegistry[canvasId];
  if (prevChart && prevChart.data && prevChart.data.datasets) {
    prevChart.data.datasets.forEach(function(ds, i) {
      hiddenByLabel[ds.label] = !prevChart.isDatasetVisible(i);
    });
  }

  var datasets = PRODUCT_KEYS.map(function(key) {
    var zByDate = {};
    allZData[key].forEach(function(d){ zByDate[d.dateStr] = d.z; });
    var aligned = slicedLabels.map(function(lbl){ var v = zByDate[lbl]; return (v != null) ? v : null; });
    var lbl = PRODUCTS[key].label;
    return {
      label: lbl,
      data: aligned,
      borderColor: PRODUCTS[key].color, backgroundColor: 'transparent',
      borderWidth: key === productKey ? 2.5 : 1, pointRadius: 0, tension: 0.1, spanGaps: true,
      hidden: hiddenByLabel[lbl] || false
    };
  });

  destroyChart(canvasId);
  var canvas = document.getElementById(canvasId); if (!canvas) return;
  chartRegistry[canvasId] = new Chart(canvas.getContext('2d'), {
    type: 'line',
    data: { labels: slicedLabels, datasets: datasets },
    options: {
      responsive: true, maintainAspectRatio: false,
      interaction: { mode: 'index', intersect: false },
      plugins: {
        legend: { position: 'top', labels: { usePointStyle: true, font: { size: 10 } } },
        tooltip: { callbacks: {
          title: function(c){ return c[0].label; },
          label: function(c){ return ' ' + c.dataset.label + ': ' + (c.parsed.y != null ? c.parsed.y.toFixed(2) : '‚Äî'); }
        }}
      },
      scales: {
        x: {
          type: 'category',
          grid: { color: '#151a22' },
          ticks: { font: { size: 11 }, maxTicksLimit: 12, callback: function(val, idx){ return slicedLabels[idx] ? slicedLabels[idx].slice(0,7) : ''; } }
        },
        y: {
          grid: { color: '#151a22' },
          ticks: { font: { size: 11 }, callback: function(v){ return v.toFixed(1); } },
          title: { display: true, text: 'Z-Score', color: '#8b949e', font: { size: 11 } }
        },
      },
    },
  });
}

function renderYDMultiRates(canvasId) {
  var seen={}, years=[];
  DATA.master.forEach(function(r){if(!seen[r.year]){seen[r.year]=1;years.push(r.year);}});
  years.sort(function(a,b){return a-b;});
  var datasets = PRODUCT_KEYS.map(function(key) {
    return { label:PRODUCTS[key].label,
      data: years.map(function(y){var v=DATA.master.filter(function(r){return r.year===y&&r[key]!=null;}).map(function(r){return r[key];});return v.length?mean(v):null;}),
      borderColor:PRODUCTS[key].color, backgroundColor:'transparent', borderWidth:2, pointRadius:3, tension:0.2, spanGaps:true };
  });
  destroyChart(canvasId);
  var canvas=document.getElementById(canvasId); if(!canvas)return;
  chartRegistry[canvasId]=new Chart(canvas.getContext('2d'),{
    type:'line', data:{labels:years.map(String),datasets:datasets},
    options:{responsive:true,maintainAspectRatio:false,interaction:{mode:'index',intersect:false},
      plugins:{legend:{position:'top',labels:{usePointStyle:true,font:{size:10}}},tooltip:{callbacks:{label:function(c){return ' '+c.dataset.label+': '+fmt(c.parsed.y);}}}},
      scales:{x:{grid:{color:'#151a22'},ticks:{font:{size:11}},title:{display:true,text:'Year',color:'#8b949e',font:{size:11}}},
        y:{grid:{color:'#151a22'},ticks:{font:{size:11},callback:function(v){return fmt(v);}}}},
    },
  });
}

function renderYDShippingRates(productKey, canvasId) {
  var cy=new Date().getFullYear(), avgs=[], colors=[];
  for(var m=0;m<12;m++){var v=DATA.master.filter(function(r){return r.year===cy&&r.month===m&&r[productKey]!=null;}).map(function(r){return r[productKey];});avgs.push(v.length?mean(v):null);}
  for(var m=0;m<12;m++){var prev=m===0?null:avgs[m-1],curr=avgs[m];if(curr==null)colors.push('#484f58');else if(prev==null)colors.push(PRODUCTS[productKey].color);else colors.push(curr>=prev?'#3fb950':'#f85149');}
  destroyChart(canvasId);
  var canvas=document.getElementById(canvasId); if(!canvas)return;
  chartRegistry[canvasId]=new Chart(canvas.getContext('2d'),{
    type:'bar', data:{labels:MONTH_NAMES,datasets:[{label:PRODUCTS[productKey].label+' '+cy,data:avgs,backgroundColor:colors,borderRadius:4}]},
    options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false},tooltip:{callbacks:{label:function(c){return ' '+fmt(c.parsed.y);}}}},
      scales:{x:{grid:{color:'#151a22'},ticks:{font:{size:11}}},y:{grid:{color:'#151a22'},ticks:{font:{size:11},callback:function(v){return fmt(v);}}}}},
  });
}

function renderYDRatesOverlay(canvasId) {
  var cy=new Date().getFullYear(), yrs=4, ops=['ff','bb','77','44'], datasets=[], maxDays=0;
  PRODUCT_KEYS.forEach(function(key){
    for(var yo=0;yo<yrs;yo++){
      var y=cy-yo, rows=DATA.byYear[y]||[];
      if(rows.length>maxDays)maxDays=rows.length;
      datasets.push({label:PRODUCTS[key].label.split(' ')[0]+' '+y,
        data:rows.map(function(r){return r[key]!=null?r[key]:null;}),
        borderColor:PRODUCTS[key].color+ops[yo],backgroundColor:'transparent',
        borderWidth:yo===0?2:1,pointRadius:0,tension:0.1,spanGaps:true});
    }
  });
  var labels=[]; for(var i=1;i<=maxDays;i++)labels.push(i);
  destroyChart(canvasId);
  var canvas=document.getElementById(canvasId); if(!canvas)return;
  chartRegistry[canvasId]=new Chart(canvas.getContext('2d'),{
    type:'line', data:{labels:labels,datasets:datasets},
    options:{responsive:true,maintainAspectRatio:false,interaction:{mode:'index',intersect:false},
      plugins:{legend:{position:'top',labels:{usePointStyle:true,font:{size:9},boxWidth:10,padding:6}},
        tooltip:{callbacks:{title:function(c){return 'Day '+c[0].label;},label:function(c){return ' '+c.dataset.label+': '+fmt(c.parsed.y);}}}},
      scales:{x:{grid:{color:'#151a22'},ticks:{maxTicksLimit:13,font:{size:10}},title:{display:true,text:'Trading Day',color:'#8b949e',font:{size:11}}},
        y:{grid:{color:'#151a22'},ticks:{font:{size:10},callback:function(v){return fmt(v);}}}},
    },
  });
}

function renderYDDrawdown(productKey, canvasId) {
  var rows=getRows(productKey);
  if(!rows.length)return;
  var cut5=new Date(); cut5.setFullYear(cut5.getFullYear()-5);
  var filtered=rows.filter(function(r){return r.date>=cut5;}), labels=[], ddData=[];
  for(var i=0;i<filtered.length;i++){
    var cur=filtered[i], c365=new Date(cur.date); c365.setDate(c365.getDate()-365);
    var maxVal=cur[productKey];
    for(var j=rows.length-1;j>=0;j--){if(rows[j].date>cur.date)continue;if(rows[j].date<c365)break;if(rows[j][productKey]>maxVal)maxVal=rows[j][productKey];}
    ddData.push(maxVal>0?((cur[productKey]-maxVal)/maxVal)*100:0);
    labels.push(cur.date.toISOString().split('T')[0]);
  }
  destroyChart(canvasId);
  var canvas=document.getElementById(canvasId); if(!canvas)return;
  chartRegistry[canvasId]=new Chart(canvas.getContext('2d'),{
    type:'line',
    data:{labels:labels,datasets:[{label:'Drawdown %',data:ddData,borderColor:'#f85149',backgroundColor:'rgba(248,81,73,0.3)',borderWidth:1.5,pointRadius:0,fill:true,tension:0.1}]},
    options:{responsive:true,maintainAspectRatio:false,interaction:{mode:'index',intersect:false},
      plugins:{legend:{display:false},tooltip:{callbacks:{label:function(c){return ' Drawdown: '+c.parsed.y.toFixed(2)+'%';}}}},
      scales:{x:{grid:{color:'#151a22'},ticks:{maxTicksLimit:8,font:{size:11},callback:function(_,i){return labels[i]?labels[i].slice(0,7):'';}  }},
        y:{grid:{color:'#151a22'},max:0,ticks:{font:{size:11},callback:function(v){return v.toFixed(1)+'%';}},title:{display:true,text:'Drawdown %',color:'#8b949e',font:{size:11}}}},
    },
  });
}

// =====================================================================
// MONTHLY DASHBOARD TAB
// =====================================================================
function renderMonthlyDash(productKey) {
  renderMDBarChart(productKey);
  renderMDTrendChart(productKey);
  renderMDAreaComp(productKey);
  renderMDDataGrid(productKey);
}

function renderMDBarChart(productKey) {
  var now=new Date(), labels=[], data=[], colors=[], prevAvg=null;
  for(var i=11;i>=0;i--){
    var d=new Date(now.getFullYear(),now.getMonth()-i,1), y=d.getFullYear(), m=d.getMonth();
    var vals=DATA.master.filter(function(r){return r.year===y&&r.month===m&&r[productKey]!=null;}).map(function(r){return r[productKey];});
    var avg=vals.length?mean(vals):null;
    labels.push(MONTH_NAMES[m]+' '+y); data.push(avg);
    if(avg==null)colors.push('#484f58'); else if(prevAvg==null)colors.push(PRODUCTS[productKey].color); else colors.push(avg>=prevAvg?'#3fb950':'#f85149');
    if(avg!=null)prevAvg=avg;
  }
  destroyChart('monthlyBarChart');
  var canvas=document.getElementById('monthlyBarChart'); if(!canvas)return;
  chartRegistry['monthlyBarChart']=new Chart(canvas.getContext('2d'),{
    type:'bar', data:{labels:labels,datasets:[{label:PRODUCTS[productKey].label,data:data,backgroundColor:colors,borderRadius:4}]},
    options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false},tooltip:{callbacks:{label:function(c){return ' '+fmt(c.parsed.y);}}}},
      scales:{x:{grid:{color:'#151a22'},ticks:{font:{size:10},maxRotation:45}},y:{grid:{color:'#151a22'},ticks:{font:{size:11},callback:function(v){return fmt(v);}}}}},
  });
}

function renderMDTrendChart(productKey) {
  var cut3=new Date(); cut3.setFullYear(cut3.getFullYear()-3);
  var seen={}, syears=[];
  DATA.master.forEach(function(r){if(r.date>=cut3&&r[productKey]!=null&&!seen[r.year]){seen[r.year]=1;syears.push(r.year);}});
  syears.sort(function(a,b){return a-b;});
  var labels=[], data=[];
  syears.forEach(function(y){for(var m=0;m<12;m++){var vals=DATA.master.filter(function(r){return r.year===y&&r.month===m&&r[productKey]!=null&&r.date>=cut3;}).map(function(r){return r[productKey];});if(vals.length){labels.push(MONTH_NAMES[m]+' '+y);data.push(mean(vals));}}});
  var prod=PRODUCTS[productKey];
  destroyChart('monthlyTrendChart');
  var canvas=document.getElementById('monthlyTrendChart'); if(!canvas)return;
  chartRegistry['monthlyTrendChart']=new Chart(canvas.getContext('2d'),{
    type:'line', data:{labels:labels,datasets:[{label:prod.label,data:data,borderColor:prod.color,backgroundColor:prod.color+'33',borderWidth:2,pointRadius:2,fill:true,tension:0.2,spanGaps:true}]},
    options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false},tooltip:{callbacks:{label:function(c){return ' '+fmt(c.parsed.y);}}}},
      scales:{x:{grid:{color:'#151a22'},ticks:{font:{size:10},maxRotation:45,maxTicksLimit:18}},y:{grid:{color:'#151a22'},ticks:{font:{size:11},callback:function(v){return fmt(v);}}}}},
  });
}

function renderMDAreaComp(productKey) {
  var cy=new Date().getFullYear(), py=cy-1, prod=PRODUCTS[productKey];
  var curData=MONTH_NAMES.map(function(_,m){var v=DATA.master.filter(function(r){return r.year===cy&&r.month===m&&r[productKey]!=null;}).map(function(r){return r[productKey];});return v.length?mean(v):null;});
  var prevData=MONTH_NAMES.map(function(_,m){var v=DATA.master.filter(function(r){return r.year===py&&r.month===m&&r[productKey]!=null;}).map(function(r){return r[productKey];});return v.length?mean(v):null;});
  destroyChart('monthlyAreaCompChart');
  var canvas=document.getElementById('monthlyAreaCompChart'); if(!canvas)return;
  chartRegistry['monthlyAreaCompChart']=new Chart(canvas.getContext('2d'),{
    type:'line', data:{labels:MONTH_NAMES,datasets:[
      {label:String(cy), data:curData, borderColor:prod.color,backgroundColor:prod.color+'33',borderWidth:2.5,pointRadius:3,fill:true,tension:0.2,spanGaps:true},
      {label:String(py), data:prevData,borderColor:'#8b949e',backgroundColor:'rgba(139,148,158,0.15)',borderWidth:1.5,pointRadius:2,fill:true,tension:0.2,spanGaps:true},
    ]},
    options:{responsive:true,maintainAspectRatio:false,interaction:{mode:'index',intersect:false},
      plugins:{legend:{position:'top',labels:{usePointStyle:true}},tooltip:{callbacks:{label:function(c){return ' '+c.dataset.label+': '+fmt(c.parsed.y);}}}},
      scales:{x:{grid:{color:'#151a22'},ticks:{font:{size:11}}},y:{grid:{color:'#151a22'},ticks:{font:{size:11},callback:function(v){return fmt(v);}}}}},
  });
}

function renderMDDataGrid(productKey) {
  var cy=new Date().getFullYear(), years5=[cy,cy-1,cy-2,cy-3,cy-4];
  var seen={}, allYears=[];
  DATA.master.forEach(function(r){if(!seen[r.year]){seen[r.year]=1;allYears.push(r.year);}});
  allYears.sort(function(a,b){return a-b;});
  var matrix={};
  allYears.forEach(function(y){matrix[y]={};for(var m=0;m<12;m++){var v=DATA.master.filter(function(r){return r.year===y&&r.month===m&&r[productKey]!=null;}).map(function(r){return r[productKey];});matrix[y][m]=v.length?mean(v):null;}});
  var colStats={};
  for(var m=0;m<12;m++){var v=allYears.map(function(y){return matrix[y][m];}).filter(function(v){return v!=null;});colStats[m]={min:Math.min.apply(null,v),max:Math.max.apply(null,v)};}
  var avg5y={};
  for(var m=0;m<12;m++){var v=years5.map(function(y){return matrix[y]?matrix[y][m]:null;}).filter(function(v){return v!=null;});avg5y[m]=v.length?mean(v):null;}
  var ly=years5[0];
  var html='<table class="heatmap-table"><thead><tr><th>Year</th>'+MONTH_NAMES.map(function(mn){return '<th>'+mn+'</th>';}).join('')+'<th>YTD Avg</th></tr></thead><tbody>';
  years5.forEach(function(y){
    var rv=[]; for(var m=0;m<12;m++)rv.push(matrix[y]?matrix[y][m]:null);
    var nn=rv.filter(function(v){return v!=null;}), ytd=nn.length?mean(nn):null;
    html+='<tr><td class="year-col">'+y+'</td>';
    for(var m=0;m<12;m++){var v=rv[m];if(v==null){html+='<td style="color:#484f58">&mdash;</td>';continue;}var cs=colStats[m],r2=cs.max>cs.min?(v-cs.min)/(cs.max-cs.min):0.5;html+='<td style="background:'+heatmapColorAbs(r2)+';color:#e6edf3">'+fmt(v,0)+'</td>';}
    html+='<td style="color:var(--text-muted)">'+(ytd!=null?fmt(ytd,0):'&mdash;')+'</td></tr>';
  });
  // 5Y avg row
  html+='<tr><td class="year-col" style="color:var(--accent);font-weight:700">5Y Avg</td>';
  var a5all=[];
  for(var m=0;m<12;m++){var v=avg5y[m];a5all.push(v);if(v==null){html+='<td style="color:#484f58">&mdash;</td>';continue;}var cs=colStats[m],r2=cs.max>cs.min?(v-cs.min)/(cs.max-cs.min):0.5;html+='<td style="background:'+heatmapColorAbs(r2)+';color:#e6edf3;font-weight:600">'+fmt(v,0)+'</td>';}
  var a5avg=mean(a5all.filter(function(v){return v!=null;}));
  html+='<td style="color:var(--accent);font-weight:600">'+(a5avg!=null?fmt(a5avg,0):'&mdash;')+'</td></tr>';
  // MoM % row
  html+='<tr><td class="year-col" style="color:var(--text-muted)">MoM %</td>';
  for(var m=0;m<12;m++){
    var curr=matrix[ly]?matrix[ly][m]:null, prev=m>0?(matrix[ly]?matrix[ly][m-1]:null):(matrix[ly-1]?matrix[ly-1][11]:null);
    if(curr==null||prev==null){html+='<td style="color:#484f58">&mdash;</td>';continue;}
    var pct=((curr-prev)/prev)*100;
    html+='<td style="background:'+heatmapColorPct(pct)+';color:#e6edf3;font-size:11px">'+(pct>=0?'+':'')+pct.toFixed(1)+'%</td>';
  }
  html+='<td>&mdash;</td></tr></tbody></table>';
  document.getElementById('monthlyDataGrid').innerHTML=html;
  document.getElementById('monthlyGridDlBtn').onclick=function(){
    var headers=['Year'].concat(MONTH_NAMES).concat(['YTD Avg']);
    var rows=years5.map(function(y){var rv=[];for(var m=0;m<12;m++)rv.push(matrix[y]?matrix[y][m]:null);var nn=rv.filter(function(v){return v!=null;});var ytd=nn.length?mean(nn):null;return [y].concat(rv.map(function(v){return v!=null?v.toFixed(2):''})).concat([ytd!=null?ytd.toFixed(2):'']);});
    downloadCSV('monthly_grid_'+productKey+'.csv',headers,rows);
  };
}

// =====================================================================
// QUARTERLY DASHBOARD TAB
// =====================================================================
function renderQuarterlyDash(productKey) {
  renderQDAreaComp1(productKey);
  renderQDTrend(productKey);
  renderQDBarChart(productKey);
  renderQDAreaComp2(productKey);
  renderQDDataGrid(productKey);
}

function getQAvgPD(productKey, year, quarter) {
  return getQAvgCached(productKey, year, quarter);
}

function renderQDAreaComp1(productKey) {
  var cy=new Date().getFullYear(), py=cy-1, prod=PRODUCTS[productKey], qs=['Q1','Q2','Q3','Q4'];
  var curData=qs.map(function(q){return getQAvgPD(productKey,cy,q);}), prevData=qs.map(function(q){return getQAvgPD(productKey,py,q);});
  destroyChart('quarterlyAreaComp1Chart');
  var canvas=document.getElementById('quarterlyAreaComp1Chart'); if(!canvas)return;
  chartRegistry['quarterlyAreaComp1Chart']=new Chart(canvas.getContext('2d'),{
    type:'line', data:{labels:qs,datasets:[
      {label:String(cy), data:curData, borderColor:prod.color,backgroundColor:prod.color+'33',borderWidth:2.5,pointRadius:5,fill:true,tension:0.2,spanGaps:true},
      {label:String(py), data:prevData,borderColor:'#8b949e',backgroundColor:'rgba(139,148,158,0.15)',borderWidth:1.5,pointRadius:4,fill:true,tension:0.2,spanGaps:true},
    ]},
    options:{responsive:true,maintainAspectRatio:false,interaction:{mode:'index',intersect:false},
      plugins:{legend:{position:'top',labels:{usePointStyle:true}},tooltip:{callbacks:{label:function(c){return ' '+c.dataset.label+': '+fmt(c.parsed.y);}}}},
      scales:{x:{grid:{color:'#151a22'},ticks:{font:{size:12}}},y:{grid:{color:'#151a22'},ticks:{font:{size:11},callback:function(v){return fmt(v);}}}}},
  });
}

function renderQDTrend(productKey) {
  var cy=new Date().getFullYear(), years5=[cy-4,cy-3,cy-2,cy-1,cy], qs=['Q1','Q2','Q3','Q4'], labels=[], data=[];
  years5.forEach(function(y){qs.forEach(function(q){labels.push(q+' '+y);data.push(getQAvgPD(productKey,y,q));});});
  var prod=PRODUCTS[productKey];
  destroyChart('quarterlyTrendChart');
  var canvas=document.getElementById('quarterlyTrendChart'); if(!canvas)return;
  chartRegistry['quarterlyTrendChart']=new Chart(canvas.getContext('2d'),{
    type:'line', data:{labels:labels,datasets:[{label:prod.label,data:data,borderColor:prod.color,backgroundColor:prod.color+'33',borderWidth:2,pointRadius:3,fill:true,tension:0.2,spanGaps:true}]},
    options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false},tooltip:{callbacks:{label:function(c){return ' '+fmt(c.parsed.y);}}}},
      scales:{x:{grid:{color:'#151a22'},ticks:{font:{size:10},maxRotation:45}},y:{grid:{color:'#151a22'},ticks:{font:{size:11},callback:function(v){return fmt(v);}}}}},
  });
}

function renderQDBarChart(productKey) {
  var now=new Date(), qs=['Q1','Q2','Q3','Q4'], qIdx=qs.indexOf(getQuarter(now.getMonth())), y=now.getFullYear(), quarters=[];
  for(var i=0;i<4;i++){qIdx--;if(qIdx<0){qIdx=3;y--;}quarters.unshift({year:y,q:qs[qIdx]});}
  var labels=quarters.map(function(x){return x.q+' '+x.year;}), data=quarters.map(function(x){return getQAvgPD(productKey,x.year,x.q);});
  var colors=data.map(function(v,i){if(v==null||i===0)return PRODUCTS[productKey].color;var p=data[i-1];return p==null?PRODUCTS[productKey].color:(v>=p?'#3fb950':'#f85149');});
  destroyChart('quarterlyBarChart');
  var canvas=document.getElementById('quarterlyBarChart'); if(!canvas)return;
  chartRegistry['quarterlyBarChart']=new Chart(canvas.getContext('2d'),{
    type:'bar', data:{labels:labels,datasets:[{label:PRODUCTS[productKey].label,data:data,backgroundColor:colors,borderRadius:4}]},
    options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false},tooltip:{callbacks:{label:function(c){return ' '+fmt(c.parsed.y);}}}},
      scales:{x:{grid:{color:'#151a22'},ticks:{font:{size:12}}},y:{grid:{color:'#151a22'},ticks:{font:{size:11},callback:function(v){return fmt(v);}}}}},
  });
}

function renderQDAreaComp2(productKey) {
  var cy=new Date().getFullYear(), qs=['Q1','Q2','Q3','Q4'], years5=[cy,cy-1,cy-2,cy-3,cy-4], prod=PRODUCTS[productKey];
  var seasonal=qs.map(function(q){var v=years5.map(function(y){return getQAvgPD(productKey,y,q);}).filter(function(v){return v!=null;});return v.length?mean(v):null;});
  var curData=qs.map(function(q){return getQAvgPD(productKey,cy,q);});
  destroyChart('quarterlyAreaComp2Chart');
  var canvas=document.getElementById('quarterlyAreaComp2Chart'); if(!canvas)return;
  chartRegistry['quarterlyAreaComp2Chart']=new Chart(canvas.getContext('2d'),{
    type:'line', data:{labels:qs,datasets:[
      {label:String(cy),          data:curData, borderColor:prod.color,backgroundColor:prod.color+'33',borderWidth:2.5,pointRadius:5,fill:true,tension:0.2,spanGaps:true},
      {label:'5Y Seasonal Avg',   data:seasonal,borderColor:'#e3b341',backgroundColor:'rgba(227,179,65,0.15)',borderWidth:1.5,borderDash:[5,3],pointRadius:4,fill:true,tension:0.2,spanGaps:true},
    ]},
    options:{responsive:true,maintainAspectRatio:false,interaction:{mode:'index',intersect:false},
      plugins:{legend:{position:'top',labels:{usePointStyle:true}},tooltip:{callbacks:{label:function(c){return ' '+c.dataset.label+': '+fmt(c.parsed.y);}}}},
      scales:{x:{grid:{color:'#151a22'},ticks:{font:{size:12}}},y:{grid:{color:'#151a22'},ticks:{font:{size:11},callback:function(v){return fmt(v);}}}}},
  });
}

function renderQDDataGrid(productKey) {
  var cy=new Date().getFullYear(), years8=[cy,cy-1,cy-2,cy-3,cy-4,cy-5,cy-6,cy-7], qs=['Q1','Q2','Q3','Q4'];
  var seen={}, allYears=[];
  DATA.master.forEach(function(r){if(!seen[r.year]){seen[r.year]=1;allYears.push(r.year);}});
  allYears.sort(function(a,b){return a-b;});
  var matrix={};
  allYears.forEach(function(y){matrix[y]={};qs.forEach(function(q){matrix[y][q]=getQAvgPD(productKey,y,q);});});
  var colStats={};
  qs.forEach(function(q){var v=allYears.map(function(y){return matrix[y][q];}).filter(function(v){return v!=null;});colStats[q]={min:Math.min.apply(null,v),max:Math.max.apply(null,v)};});
  var html='<table class="heatmap-table"><thead><tr><th>Year</th>'+qs.map(function(q){return '<th>'+q+'</th>';}).join('')+'<th>Full Year Avg</th><th>YoY %</th></tr></thead><tbody>';
  years8.forEach(function(y,i){
    var qv=qs.map(function(q){return matrix[y]?matrix[y][q]:null;}), nn=qv.filter(function(v){return v!=null;}), fy=nn.length?mean(nn):null;
    var py2=years8[i+1], pv=py2!=null?qs.map(function(q){return matrix[py2]?matrix[py2][q]:null;}).filter(function(v){return v!=null;}):[], pfy=pv.length?mean(pv):null;
    var yoy=fy!=null&&pfy!=null&&pfy!==0?((fy-pfy)/pfy)*100:null;
    html+='<tr><td class="year-col">'+y+'</td>';
    qs.forEach(function(q){var v=matrix[y]?matrix[y][q]:null;if(v==null){html+='<td style="color:#484f58">&mdash;</td>';return;}var cs=colStats[q],r2=cs.max>cs.min?(v-cs.min)/(cs.max-cs.min):0.5;html+='<td style="background:'+heatmapColorAbs(r2)+';color:#e6edf3">'+fmt(v,0)+'</td>';});
    html+='<td style="color:var(--text-muted)">'+(fy!=null?fmt(fy,0):'&mdash;')+'</td>';
    html+='<td class="'+(yoy==null?'':yoy>=0?'val-green':'val-red')+'" style="font-weight:600">'+(yoy!=null?(yoy>=0?'+':'')+yoy.toFixed(1)+'%':'&mdash;')+'</td></tr>';
  });
  html+='</tbody></table>';
  document.getElementById('quarterlyDashDataGrid').innerHTML=html;
  document.getElementById('quarterlyDashGridDlBtn').onclick=function(){
    var headers=['Year'].concat(qs).concat(['Full Year Avg','YoY %']);
    var rows=years8.map(function(y,i){
      var qv=qs.map(function(q){return matrix[y]?matrix[y][q]:null;}), nn=qv.filter(function(v){return v!=null;}), fy=nn.length?mean(nn):null;
      var py2=years8[i+1], pv=py2!=null?qs.map(function(q){return matrix[py2]?matrix[py2][q]:null;}).filter(function(v){return v!=null;}):[], pfy=pv.length?mean(pv):null;
      var yoy=fy!=null&&pfy!=null&&pfy!==0?((fy-pfy)/pfy*100).toFixed(1)+'%':'';
      return [y].concat(qv.map(function(v){return v!=null?v.toFixed(2):''})).concat([fy!=null?fy.toFixed(2):'',yoy]);
    });
    downloadCSV('quarterly_dash_'+productKey+'.csv',headers,rows);
  };
}

// =====================================================================
// SIGNALS TAB
// =====================================================================

var _bbWindow = '1y';
var _spreadWindow = '3y';

function renderSignalsTab(productKey) {
  var fns = [
    function(){ renderBollingerBands(productKey); },
    function(){ renderCapeSpread(); },
    function(){ renderROCHeatmap(); },
    function(){ renderSeasonalChart(productKey); },
    function(){ renderTermStructure(); },
  ];
  fns.forEach(function(fn){
    try { fn(); } catch(e) { console.error('[SignalsTab]', e); }
  });
}

// -------------------------------------------------------
// 1. BOLLINGER BANDS
// -------------------------------------------------------
function setBBWindow(w) {
  _bbWindow = w;
  ['1y','3y','5y'].forEach(function(x){
    var el = document.getElementById('bbBtn' + x);
    if (el) el.classList.remove('active');
  });
  var activeEl = document.getElementById('bbBtn' + w);
  if (activeEl) activeEl.classList.add('active');
  renderBollingerBands(typeof _currentBBProduct !== 'undefined' ? _currentBBProduct : 'bdiy');
}

var _currentBBProduct = 'bdiy';

function renderBollingerBands(productKey) {
  _currentBBProduct = productKey;
  var allRows = getRows(productKey);
  if (!allRows.length) return;

  // Filter by window
  var cutoff = new Date();
  if (_bbWindow === '1y') cutoff.setFullYear(cutoff.getFullYear() - 1);
  else if (_bbWindow === '3y') cutoff.setFullYear(cutoff.getFullYear() - 3);
  else cutoff.setFullYear(cutoff.getFullYear() - 5);
  var rows = allRows.filter(function(r){ return r.date >= cutoff; });
  if (!rows.length) return;

  var period = 20;
  var labels = [], prices = [], upper = [], lower = [], mid = [];

  // Build index map once to avoid O(n¬≤) indexOf inside the loop
  var allRowsIndexMap = new Map();
  allRows.forEach(function(r, i) { allRowsIndexMap.set(r, i); });

  rows.forEach(function(r, i) {
    labels.push(r.date.toISOString().split('T')[0]);
    var val = r[productKey];
    prices.push(val);

    // Compute 20-day SMA and stddev from allRows (need enough lookback)
    var globalIdx = allRowsIndexMap.get(r);
    var slice = [];
    for (var j = Math.max(0, globalIdx - period + 1); j <= globalIdx; j++) {
      if (allRows[j][productKey] != null) slice.push(allRows[j][productKey]);
    }
    if (slice.length < 2) { mid.push(null); upper.push(null); lower.push(null); return; }
    var m = slice.reduce(function(a,b){return a+b;},0) / slice.length;
    var sd = Math.sqrt(slice.reduce(function(a,b){return a+(b-m)*(b-m);},0) / slice.length);
    mid.push(m);
    upper.push(m + 2 * sd);
    lower.push(m - 2 * sd);
  });

  var prod = PRODUCTS[productKey];
  destroyChart('bbChart');
  var canvas = document.getElementById('bbChart'); if (!canvas) return;
  chartRegistry['bbChart'] = new Chart(canvas.getContext('2d'), {
    type: 'line',
    data: { labels: labels, datasets: [
      { label: prod.label,     data: prices, borderColor: prod.color,   backgroundColor: prod.color + '22', borderWidth: 2,   pointRadius: 0, fill: false, tension: 0.1, order: 1 },
      { label: 'Upper Band',   data: upper,  borderColor: '#f85149',    backgroundColor: 'rgba(248,81,73,0.08)', borderWidth: 1, pointRadius: 0, fill: '+1',  tension: 0.1, order: 2, borderDash: [3,3] },
      { label: '20D SMA',      data: mid,    borderColor: '#e3b341',    backgroundColor: 'transparent',     borderWidth: 1.5, pointRadius: 0, fill: false, tension: 0.1, order: 3, borderDash: [5,3] },
      { label: 'Lower Band',   data: lower,  borderColor: '#3fb950',    backgroundColor: 'rgba(63,185,80,0.08)',  borderWidth: 1, pointRadius: 0, fill: false, tension: 0.1, order: 4, borderDash: [3,3] },
    ]},
    options: {
      responsive: true, maintainAspectRatio: false,
      interaction: { mode: 'index', intersect: false },
      plugins: {
        legend: { position: 'top', labels: { usePointStyle: true, font: { size: 11 } } },
        tooltip: { callbacks: {
          title: function(c){ return c[0].label; },
          label: function(c){ return ' ' + c.dataset.label + ': ' + fmt(c.parsed.y); }
        }}
      },
      scales: {
        x: { grid: { color: '#151a22' }, ticks: { maxTicksLimit: 10, font: { size: 11 }, callback: function(_, i){ return labels[i] ? labels[i].slice(0,7) : ''; } } },
        y: { grid: { color: '#151a22' }, ticks: { font: { size: 11 }, callback: function(v){ return fmt(v); } } },
      },
    },
  });
}

// -------------------------------------------------------
// 2. CAPE / PANAMAX SPREAD RATIO
// -------------------------------------------------------
function setSpreadWindow(w) {
  _spreadWindow = w;
  ['3y','5y','all'].forEach(function(x){
    var el = document.getElementById('spreadBtn' + x);
    if (el) el.classList.remove('active');
  });
  var activeEl = document.getElementById('spreadBtn' + w);
  if (activeEl) activeEl.classList.add('active');
  renderCapeSpread();
}

function renderCapeSpread() {
  // Use raw daily data ‚Äî both series must have a value on same date
  var capeRows = DATA.raw['cape'];
  var panaRows = DATA.raw['panama'];
  if (!capeRows || !panaRows || !capeRows.length || !panaRows.length) return;

  // Build lookup for panamax by date ts
  var panaMap = {};
  panaRows.forEach(function(r){ panaMap[r.date.getTime()] = r.value; });

  // Build ratio series
  var allRatio = [];
  capeRows.forEach(function(r){
    var pv = panaMap[r.date.getTime()];
    if (r.value != null && pv != null && pv > 0) {
      allRatio.push({ date: r.date, ratio: r.value / pv });
    }
  });
  if (!allRatio.length) return;

  // Filter window
  var cutoff = new Date();
  if (_spreadWindow === '3y') cutoff.setFullYear(cutoff.getFullYear() - 3);
  else if (_spreadWindow === '5y') cutoff.setFullYear(cutoff.getFullYear() - 5);
  else cutoff = new Date('2008-01-01');
  var rows = allRatio.filter(function(r){ return r.date >= cutoff; });
  if (!rows.length) return;

  var labels = rows.map(function(r){ return r.date.toISOString().split('T')[0]; });
  var ratios = rows.map(function(r){ return r.ratio; });

  // Rolling 252-day percentile rank for each point
  var allRatioVals = allRatio.map(function(r){ return r.ratio; });
  var allRatioIndexMap = new Map();
  allRatio.forEach(function(r, i) { allRatioIndexMap.set(r, i); });
  var percentiles = rows.map(function(r, i){
    var globalIdx = allRatioIndexMap.get(r);
    var start = Math.max(0, globalIdx - 251);
    var slice = allRatioVals.slice(start, globalIdx + 1);
    var below = slice.filter(function(v){ return v <= r.ratio; }).length;
    return (below / slice.length) * 100;
  });

  // Mean ratio line
  var totalMean = allRatioVals.reduce(function(a,b){return a+b;},0) / allRatioVals.length;
  var meanLine = rows.map(function(){ return totalMean; });

  destroyChart('spreadChart');
  var canvas = document.getElementById('spreadChart'); if (!canvas) return;
  chartRegistry['spreadChart'] = new Chart(canvas.getContext('2d'), {
    type: 'line',
    data: { labels: labels, datasets: [
      { label: 'Cape/Panamax Ratio', data: ratios,    yAxisID: 'yRatio', borderColor: '#58a6ff', backgroundColor: '#58a6ff22', borderWidth: 2,   pointRadius: 0, fill: true,  tension: 0.1 },
      { label: 'Historical Mean',    data: meanLine,  yAxisID: 'yRatio', borderColor: '#e3b341', backgroundColor: 'transparent', borderWidth: 1.5, pointRadius: 0, fill: false, tension: 0,   borderDash: [6,3] },
      { label: '252D Percentile',    data: percentiles, yAxisID: 'yPctl', borderColor: '#a371f7', backgroundColor: 'transparent', borderWidth: 1,   pointRadius: 0, fill: false, tension: 0.1, borderDash: [2,2] },
    ]},
    options: {
      responsive: true, maintainAspectRatio: false,
      interaction: { mode: 'index', intersect: false },
      plugins: {
        legend: { position: 'top', labels: { usePointStyle: true, font: { size: 11 } } },
        tooltip: { callbacks: {
          title: function(c){ return c[0].label; },
          label: function(c){
            if (c.dataset.label === '252D Percentile') return ' Percentile: ' + c.parsed.y.toFixed(1) + '%';
            return ' ' + c.dataset.label + ': ' + c.parsed.y.toFixed(3);
          }
        }}
      },
      scales: {
        x: { grid: { color: '#151a22' }, ticks: { maxTicksLimit: 10, font: { size: 11 }, callback: function(_, i){ return labels[i] ? labels[i].slice(0,7) : ''; } } },
        yRatio: { position: 'left',  grid: { color: '#151a22' }, ticks: { font: { size: 11 }, callback: function(v){ return v.toFixed(2); } }, title: { display: true, text: 'Ratio', color: '#8b949e', font: { size: 11 } } },
        yPctl:  { position: 'right', grid: { drawOnChartArea: false }, min: 0, max: 100, ticks: { font: { size: 11 }, callback: function(v){ return v + '%'; } }, title: { display: true, text: 'Pctl', color: '#8b949e', font: { size: 11 } } },
      },
    },
  });
}

// -------------------------------------------------------
// 3. RATE-OF-CHANGE HEATMAP
// -------------------------------------------------------
function renderROCHeatmap() {
  var container = document.getElementById('rocHeatmap');
  if (!container) return;

  var periods = [
    { label: '5D',  days: 5  },
    { label: '10D', days: 10 },
    { label: '20D', days: 20 },
    { label: '60D', days: 60 },
    { label: '90D', days: 90 },
    { label: '1Y',  days: 252 },
  ];

  // For each product, get latest value and value N days ago
  var prodLabels = { bdiy:'BDI', cape:'Capesize', panama:'Panamax', suprama:'Supramax', cleantanker:'Clean Tanker', dirtytanker:'Dirty Tanker', bdry_spot:'BDRY Spot' };

  var html = '<table class="heatmap-table" style="min-width:520px;width:100%"><thead><tr>';
  html += '<th style="text-align:left">Product</th>';
  periods.forEach(function(p){ html += '<th>' + p.label + '</th>'; });
  html += '</tr></thead><tbody>';

  PRODUCT_KEYS.forEach(function(key) {
    var rows = getRows(key);
    if (!rows.length) { html += '<tr><td>' + prodLabels[key] + '</td>' + periods.map(function(){ return '<td>‚Äî</td>'; }).join('') + '</tr>'; return; }
    var latest = rows[rows.length - 1];
    var latestVal = latest[key];

    html += '<tr><td style="text-align:left;color:var(--text);font-weight:600;padding:8px 10px;">' + prodLabels[key] + '</td>';
    periods.forEach(function(p) {
      // Find row approx p.days ago
      var target = new Date(latest.date);
      target.setDate(target.getDate() - p.days);
      // Find nearest row at or before target
      var pastRow = null;
      for (var i = rows.length - 1; i >= 0; i--) {
        if (rows[i].date <= target) { pastRow = rows[i]; break; }
      }
      if (!pastRow || pastRow[key] == null || pastRow[key] === 0) {
        html += '<td style="color:#484f58">‚Äî</td>';
        return;
      }
      var roc = ((latestVal - pastRow[key]) / pastRow[key]) * 100;
      var bg = heatmapColorPct(roc);
      var sign = roc >= 0 ? '+' : '';
      html += '<td style="background:' + bg + ';color:#e6edf3;font-weight:600;font-size:12px;">' + sign + roc.toFixed(1) + '%</td>';
    });
    html += '</tr>';
  });

  html += '</tbody></table>';

  // Add a note row
  html += '<div style="font-size:11px;color:var(--text-muted);margin-top:8px;">Color scale: <span style="color:#f85149">‚ñ†</span> &lt;‚àí15% &nbsp;|&nbsp; <span style="color:#e6edf3">‚ñ†</span> 0% &nbsp;|&nbsp; <span style="color:#3fb950">‚ñ†</span> &gt;+15%</div>';

  container.innerHTML = html;
}

// -------------------------------------------------------
// 4. SEASONAL DECOMPOSITION
// -------------------------------------------------------
var _currentSeasonalProduct = 'bdiy';

function renderSeasonalChart(productKey) {
  _currentSeasonalProduct = productKey;
  var prod = PRODUCTS[productKey];

  // Build day-of-year average and stddev across all years
  // Use trading day of year (1..252) ‚Äî already computed in DATA.byYear
  var maxTD = 0;
  var years = Object.keys(DATA.byYear).map(Number);
  years.forEach(function(y){ if (DATA.byYear[y].length > maxTD) maxTD = DATA.byYear[y].length; });

  // For each trading day slot, collect all historical values (excluding current year)
  var currentYear = new Date().getFullYear();
  var byTD = {}; // td -> [values]
  years.forEach(function(y) {
    if (y === currentYear) return; // exclude current year from seasonal baseline
    DATA.byYear[y].forEach(function(r) {
      var td = r.tradingDay;
      if (r[productKey] == null) return;
      if (!byTD[td]) byTD[td] = [];
      byTD[td].push(r[productKey]);
    });
  });

  // Build seasonal average and ¬±1œÉ bands, normalised as % of annual mean so all products are comparable
  // Actually keep absolute values ‚Äî more useful for reading entry points
  var labels = [], avgLine = [], upperBand = [], lowerBand = [], currentYearLine = [];
  var curYearRows = DATA.byYear[currentYear] || [];
  var curYearByTD = {};
  curYearRows.forEach(function(r){ curYearByTD[r.tradingDay] = r[productKey]; });

  for (var td = 1; td <= maxTD; td++) {
    labels.push('TD' + td);
    var vals = byTD[td] || [];
    if (vals.length < 2) {
      avgLine.push(null); upperBand.push(null); lowerBand.push(null);
    } else {
      var m = vals.reduce(function(a,b){return a+b;},0) / vals.length;
      var sd = Math.sqrt(vals.reduce(function(a,b){return a+(b-m)*(b-m);},0) / vals.length);
      avgLine.push(m);
      upperBand.push(m + sd);
      lowerBand.push(m - sd);
    }
    currentYearLine.push(curYearByTD[td] != null ? curYearByTD[td] : null);
  }

  destroyChart('seasonalChart');
  var canvas = document.getElementById('seasonalChart'); if (!canvas) return;
  chartRegistry['seasonalChart'] = new Chart(canvas.getContext('2d'), {
    type: 'line',
    data: { labels: labels, datasets: [
      { label: String(currentYear),  data: currentYearLine, borderColor: prod.color,   backgroundColor: 'transparent',         borderWidth: 2.5, pointRadius: 0, fill: false, tension: 0.2, spanGaps: true, order: 1 },
      { label: 'Seasonal Avg',        data: avgLine,         borderColor: '#e3b341',   backgroundColor: 'rgba(227,179,65,0.12)', borderWidth: 1.5, pointRadius: 0, fill: false, tension: 0.3, order: 2, borderDash: [5,3] },
      { label: '+1œÉ',                 data: upperBand,       borderColor: '#484f58',   backgroundColor: 'rgba(72,79,88,0.15)',  borderWidth: 1,   pointRadius: 0, fill: '+1',  tension: 0.3, order: 3, borderDash: [2,2] },
      { label: '‚àí1œÉ',                 data: lowerBand,       borderColor: '#484f58',   backgroundColor: 'transparent',         borderWidth: 1,   pointRadius: 0, fill: false, tension: 0.3, order: 4, borderDash: [2,2] },
    ]},
    options: {
      responsive: true, maintainAspectRatio: false,
      interaction: { mode: 'index', intersect: false },
      plugins: {
        legend: { position: 'top', labels: { usePointStyle: true, font: { size: 11 } } },
        tooltip: { callbacks: {
          title: function(c){ return c[0].label; },
          label: function(c){ return c.parsed.y != null ? ' ' + c.dataset.label + ': ' + fmt(c.parsed.y) : null; }
        }}
      },
      scales: {
        x: { grid: { color: '#151a22' }, ticks: { maxTicksLimit: 13, font: { size: 11 },
          callback: function(_, i) {
            // Show approximate month labels: every ~21 trading days
            var months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
            var approxMonth = Math.floor(i / 21);
            if (i % 21 === 0 && approxMonth < 12) return months[approxMonth];
            return '';
          }
        }},
        y: { grid: { color: '#151a22' }, ticks: { font: { size: 11 }, callback: function(v){ return fmt(v); } } },
      },
    },
  });
}

// -------------------------------------------------------
// 5. TERM STRUCTURE / FFA CURVE SLOPE
// -------------------------------------------------------
function renderTermStructure() {
  renderTermCurve('bdry', DATA.bdryHoldings, 'termBdryChart', 'termBdrySlope');
  renderTermCurve('bwet', DATA.bwetHoldings, 'termBwetChart', 'termBwetSlope');
}

function parseContractMonth(name, ticker) {
  // Extract month/year from names like "Cape 5TC M Feb 26" or ticker "C5TCM G26"
  // Try name first: look for 3-letter month + 2-digit year
  var monthMap = {Jan:1,Feb:2,Mar:3,Apr:4,May:5,Jun:6,Jul:7,Aug:8,Sep:9,Oct:10,Nov:11,Dec:12};
  var nameMatch = (name || '').match(/\b(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)\s+(\d{2,4})\b/i);
  if (nameMatch) {
    var mon = monthMap[nameMatch[1].charAt(0).toUpperCase() + nameMatch[1].slice(1).toLowerCase()];
    var yr = parseInt(nameMatch[2]);
    if (yr < 100) yr += 2000;
    return { sortKey: yr * 100 + mon, label: nameMatch[1].charAt(0).toUpperCase() + nameMatch[1].slice(1).toLowerCase() + ' ' + yr };
  }
  // Try ticker: e.g. G26 = Feb 2026, H26 = Mar 2026 (CME month codes)
  var cmeMap = {F:1,G:2,H:3,J:4,K:5,M:6,N:7,Q:8,U:9,V:10,X:11,Z:12};
  var tickerMatch = (ticker || '').match(/([FGHJKMNQUVXZ])(\d{2})(?:\s|$|INDEX)/i);
  if (tickerMatch) {
    var mon2 = cmeMap[tickerMatch[1].toUpperCase()];
    var yr2 = 2000 + parseInt(tickerMatch[2]);
    var monthNames = ['','Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
    return { sortKey: yr2 * 100 + mon2, label: monthNames[mon2] + ' ' + yr2 };
  }
  return null;
}

function renderTermCurve(etfKey, holdings, canvasId, slopeId) {
  if (!holdings || !holdings.length) return;

  // Filter out cash/collateral rows ‚Äî keep only futures
  var futuresTypes = etfKey === 'bdry' ? ['cape','pana','supra'] : ['td3c','td20'];

  // Group by vessel type, sort by contract month
  var groups = {};
  holdings.forEach(function(h) {
    var cls = classifyHolding(h.Name, h.Ticker, etfKey);
    if (futuresTypes.indexOf(cls) === -1) return;
    var parsed = parseContractMonth(h.Name, h.Ticker);
    if (!parsed) return;
    var price = parseFloat(h.Price);
    if (isNaN(price) || price <= 0) return;
    if (!groups[cls]) groups[cls] = [];
    groups[cls].push({ sortKey: parsed.sortKey, label: parsed.label, price: price });
  });

  // Sort each group by contract month
  Object.keys(groups).forEach(function(cls){
    groups[cls].sort(function(a,b){ return a.sortKey - b.sortKey; });
  });

  // Build datasets ‚Äî one per vessel class
  var colorMap = {
    cape: '#58a6ff', pana: '#3fb950', supra: '#d29922',
    td3c: '#f0883e', td20: '#a371f7'
  };
  var labelMap = {
    cape: 'Capesize', pana: 'Panamax', supra: 'Supramax',
    td3c: 'MEG-China (TD3C)', td20: 'WAF-Continent (TD20)'
  };

  // Collect all labels (contract months) in sorted order
  var allMonths = [];
  var seen = {};
  Object.keys(groups).forEach(function(cls){
    groups[cls].forEach(function(c){
      if (!seen[c.label]) { seen[c.label] = c.sortKey; allMonths.push({ label: c.label, sortKey: c.sortKey }); }
    });
  });
  allMonths.sort(function(a,b){ return a.sortKey - b.sortKey; });
  var xLabels = allMonths.map(function(m){ return m.label; });

  var datasets = Object.keys(groups).map(function(cls) {
    var priceByLabel = {};
    groups[cls].forEach(function(c){ priceByLabel[c.label] = c.price; });
    return {
      label: labelMap[cls],
      data: xLabels.map(function(l){ return priceByLabel[l] != null ? priceByLabel[l] : null; }),
      borderColor: colorMap[cls],
      backgroundColor: colorMap[cls] + '30',
      borderWidth: 2,
      pointRadius: 5,
      pointHoverRadius: 7,
      fill: false,
      tension: 0.1,
      spanGaps: false,
    };
  });

  if (!datasets.length) return;

  destroyChart(canvasId);
  var canvas = document.getElementById(canvasId); if (!canvas) return;
  chartRegistry[canvasId] = new Chart(canvas.getContext('2d'), {
    type: 'line',
    data: { labels: xLabels, datasets: datasets },
    options: {
      responsive: true, maintainAspectRatio: false,
      interaction: { mode: 'index', intersect: false },
      plugins: {
        legend: { position: 'top', labels: { usePointStyle: true, font: { size: 10 } } },
        tooltip: { callbacks: {
          title: function(c){ return c[0].label; },
          label: function(c){ return c.parsed.y != null ? ' ' + c.dataset.label + ': ' + fmt(c.parsed.y) : null; }
        }}
      },
      scales: {
        x: { grid: { color: '#151a22' }, ticks: { font: { size: 11 } } },
        y: { grid: { color: '#151a22' }, ticks: { font: { size: 11 }, callback: function(v){ return fmt(v); } },
          title: { display: true, text: etfKey === 'bdry' ? '$/day' : '$/MT', color: '#8b949e', font: { size: 11 } } },
      },
    },
  });

  // Compute and display slope signal for each group
  var slopeEl = document.getElementById(slopeId);
  if (!slopeEl) return;
  var slopeHtml = '';
  Object.keys(groups).forEach(function(cls) {
    var pts = groups[cls];
    if (pts.length < 2) return;
    var front = pts[0].price;
    var back  = pts[pts.length - 1].price;
    var slope = ((back - front) / front) * 100;
    var structure = slope > 1.5 ? 'Contango' : slope < -1.5 ? 'Backwardation' : 'Flat';
    var structureColor = slope < -1.5 ? '#3fb950' : slope > 1.5 ? '#f85149' : '#e3b341';
    var structureIcon  = slope < -1.5 ? 'üìâ' : slope > 1.5 ? 'üìà' : '‚û°Ô∏è';
    slopeHtml += '<span style="margin-right:16px;font-size:12px;">' +
      '<span style="color:' + colorMap[cls] + ';font-weight:700">' + labelMap[cls] + '</span>' +
      ' &nbsp;' + structureIcon +
      ' <span style="color:' + structureColor + ';font-weight:600">' + structure + '</span>' +
      ' <span style="color:var(--text-muted)">(' + (slope >= 0 ? '+' : '') + slope.toFixed(1) + '% F‚ÜíB)</span>' +
      '</span>';
  });
  slopeEl.innerHTML = slopeHtml;
}

// =====================================================================
// BDRY LIQUIDITY TRACKER
// =====================================================================
var _bdryLiqData = null; // cached full dataset
var _bdryLiqRangeS = 0;  // current slider start index
var _bdryLiqRangeE = 0;  // current slider end index (set after data loads)

function getBdryLiqTierPct(volume) {
  if (volume < 50000)  return 0.020;
  if (volume < 100000) return 0.035;
  if (volume < 500000) return 0.050;
  return 0.065;
}

function getTierLabel(volume) {
  if (volume < 50000)  return '2%  (<50K)';
  if (volume < 100000) return '3.5% (<100K)';
  if (volume < 500000) return '5%  (<500K)';
  return '6.5% (>500K)';
}

async function renderBdryLiquidityTracker() {
  var loadingEl = document.getElementById('bdryLiqLoading');
  if (!loadingEl) return;

  var allRows = [];

  try {
    var yahooUrl = 'https://query1.finance.yahoo.com/v8/finance/chart/BDRY?interval=1d&range=10y';
    var proxyFns = [
      function(u){ return 'https://corsproxy.io/?' + encodeURIComponent(u); },
      function(u){ return 'https://api.allorigins.win/get?url=' + encodeURIComponent(u); },
      function(u){ return 'https://thingproxy.freeboard.io/fetch/' + u; },
    ];
    var data = null;
    for (var pi = 0; pi < proxyFns.length; pi++) {
      try {
        var proxyUrl = proxyFns[pi](yahooUrl);
        var resp = await fetch(proxyUrl, { signal: AbortSignal.timeout(15000) });
        if (!resp.ok) continue;
        var text = await resp.text();
        var parsed;
        try {
          var wrapper = JSON.parse(text);
          parsed = (wrapper.contents && wrapper.contents[0] !== '<') ? JSON.parse(wrapper.contents) : wrapper;
        } catch(pe) { continue; }
        if (parsed && parsed.chart && parsed.chart.result && parsed.chart.result.length) { data = parsed; break; }
      } catch(fe) { continue; }
    }
    if (!data) throw new Error('All proxies failed ‚Äî try again later');
    allRows = parseYahooRows(data);

    if (!allRows.length) throw new Error('No data returned');

    allRows.sort(function(a,b){ return a.ts - b.ts; });
    var seen = {};
    allRows = allRows.filter(function(r){ if (seen[r.ts]) return false; seen[r.ts]=1; return true; });

    for (var i = 0; i < allRows.length; i++) {
      var r = allRows[i];
      var pct = getBdryLiqTierPct(r.volume);
      r.possShares = Math.floor(r.volume * pct);
      r.dollarVol  = r.close * r.volume;
      r.safeLiq    = r.possShares * r.close;
      r.tierPct    = pct;
      r.tierLabel  = getTierLabel(r.volume);
      var prev = i > 0 ? allRows[i-1] : null;
      r.chgPct = prev && prev.close ? ((r.close - prev.close) / prev.close * 100) : null;
    }

    _bdryLiqData = allRows;
    loadingEl.style.display = 'none';

    // Init range sliders now that we have data
    initBdryLiqRangeSlider(allRows);
    buildBdryAvgChart(allRows, allRows.length - 1);

  } catch(err) {
    loadingEl.textContent = '‚ö†Ô∏è Could not load BDRY market data: ' + err.message;
    console.error('[BDRY Liq]', err);
  }
}

function parseYahooRows(data) {
  var result_data = data.chart && data.chart.result && data.chart.result[0];
  if (!result_data) return [];
  var ts  = result_data.timestamp || [];
  var q   = result_data.indicators.quote[0];
  var rows = [];
  for (var i = 0; i < ts.length; i++) {
    var close = q.close[i];
    var vol   = q.volume[i];
    if (close == null || vol == null) continue;
    var d = new Date(ts[i] * 1000);
    rows.push({ ts: ts[i], date: d, dateStr: d.toISOString().split('T')[0], close: close, volume: vol });
  }
  return rows;
}

// ‚îÄ‚îÄ Range slider for Liq + Vol charts (dual-handle, synced) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function initBdryLiqRangeSlider(allRows) {
  var total   = allRows.length;
  var startEl = document.getElementById('bdryLiqRangeStart');
  var endEl   = document.getElementById('bdryLiqRangeEnd');
  var fillEl  = document.getElementById('bdryLiqRangeFill');
  var labelEl = document.getElementById('bdryLiqRangeLabel');
  if (!startEl || !endEl) return;

  // Set range and default to full dataset
  startEl.max = total - 1;  endEl.max = total - 1;
  startEl.value = 0;        endEl.value = total - 1;

  // Clone first to remove any stale listeners, THEN wire update so the
  // closure captures the live DOM nodes (ns/ne), not the detached originals
  var ns = startEl.cloneNode(true); startEl.parentNode.replaceChild(ns, startEl);
  var ne = endEl.cloneNode(true);   endEl.parentNode.replaceChild(ne, endEl);

  function update() {
    var s = parseInt(ns.value);
    var e = parseInt(ne.value);
    if (s > e) {
      if (document.activeElement === ns) { ns.value = e; s = e; }
      else { ne.value = s; e = s; }
    }
    _bdryLiqRangeS = s; _bdryLiqRangeE = e;
    var pctS = (s / (total - 1)) * 100;
    var pctE = (e / (total - 1)) * 100;
    if (fillEl) { fillEl.style.left = pctS + '%'; fillEl.style.width = (pctE - pctS) + '%'; }
    if (labelEl) { labelEl.textContent = allRows[s].dateStr.slice(0,7) + ' ‚Üí ' + allRows[e].dateStr.slice(0,7); }
    var rows = allRows.slice(s, e + 1);
    buildBdryLiqKpi(allRows);  // KPI always uses latest row
    buildBdryLiqChart(rows);
    buildBdryVolChart(rows);
    buildBdryLiqTable(rows);
    wireBdryLiqDownload(allRows, s, e);
  }

  ns.addEventListener('input', update);
  ne.addEventListener('input', update);
  update();  // initial render
}


function buildBdryLiqKpi(allRows) {
  var el = document.getElementById('bdryLiqKpi');
  if (!el) return;
  var latest = allRows[allRows.length - 1];

  var kpis = [
    { label: 'Close',              val: '$' + latest.close.toFixed(2),                                                          cls: '' },
    { label: 'Volume',             val: latest.volume.toLocaleString(),                                                          cls: '' },
    { label: 'Dollar Vol Traded',  val: '$' + (latest.dollarVol / 1000).toFixed(0) + 'K',                                      cls: '' },
    { label: 'Tier',               val: latest.tierLabel,                                                                        cls: 'val-yellow' },
    { label: 'Possible Shares',    val: latest.possShares.toLocaleString(),                                                      cls: 'val-green' },
    { label: 'Safe Liquidity',     val: '$' + latest.safeLiq.toLocaleString(undefined,{maximumFractionDigits:0}),                cls: 'val-green' },
    { label: 'Day Change',         val: latest.chgPct != null ? (latest.chgPct >= 0 ? '+' : '') + latest.chgPct.toFixed(2) + '%' : '‚Äî',
      cls: latest.chgPct == null ? '' : latest.chgPct >= 0 ? 'val-green' : 'val-red' },
    { label: 'As of',              val: latest.dateStr,                                                                          cls: '' },
  ];

  el.innerHTML = kpis.map(function(k) {
    return '<div class="stat-card" style="min-width:130px;padding:10px 14px;">' +
      '<div class="stat-label">' + k.label + '</div>' +
      '<div class="stat-value ' + k.cls + '" style="font-size:16px">' + k.val + '</div>' +
      '</div>';
  }).join('');
}

function buildBdryLiqChart(rows) {
  var labels   = rows.map(function(r){ return r.dateStr; });
  var safeLiqs = rows.map(function(r){ return r.safeLiq; });

  destroyChart('bdryLiqChart');
  var canvas = document.getElementById('bdryLiqChart'); if (!canvas) return;
  chartRegistry['bdryLiqChart'] = new Chart(canvas.getContext('2d'), {
    type: 'line',
    data: { labels: labels, datasets: [{
      label: 'Safe Liquidity ($)',
      data: safeLiqs,
      borderColor: '#3fb950',
      backgroundColor: 'rgba(63,185,80,0.12)',
      borderWidth: 1.5, pointRadius: 0, fill: true, tension: 0.1
    }]},
    options: {
      responsive: true, maintainAspectRatio: false,
      interaction: { mode: 'index', intersect: false },
      plugins: {
        legend: { display: false },
        tooltip: { callbacks: {
          title: function(c){ return c[0].label; },
          label: function(c){ return ' Safe Liq: $' + Math.round(c.parsed.y).toLocaleString(); }
        }}
      },
      scales: {
        x: { grid: { color: '#151a22' }, ticks: { maxTicksLimit: 10, font: { size: 10 }, callback: function(_, i){ return labels[i] ? labels[i].slice(0,7) : ''; } } },
        y: { grid: { color: '#151a22' }, ticks: { font: { size: 10 }, callback: function(v){ return '$' + (v>=1000?(v/1000).toFixed(0)+'K':v); } } }
      }
    }
  });
}

function buildBdryVolChart(rows) {
  var labels  = rows.map(function(r){ return r.dateStr; });
  var volumes = rows.map(function(r){ return r.volume; });
  var barColors = rows.map(function(r){
    if (r.volume < 50000)  return 'rgba(248,81,73,0.7)';
    if (r.volume < 100000) return 'rgba(227,179,65,0.7)';
    if (r.volume < 500000) return 'rgba(88,166,255,0.7)';
    return 'rgba(63,185,80,0.7)';
  });
  var t50k  = rows.map(function(){ return 50000; });
  var t100k = rows.map(function(){ return 100000; });
  var t500k = rows.map(function(){ return 500000; });

  destroyChart('bdryVolChart');
  var canvas = document.getElementById('bdryVolChart'); if (!canvas) return;
  chartRegistry['bdryVolChart'] = new Chart(canvas.getContext('2d'), {
    type: 'bar',
    data: { labels: labels, datasets: [
      { label: 'Volume', data: volumes, backgroundColor: barColors, borderWidth: 0, order: 2 },
      { label: '50K (2% tier)',    data: t50k,  type:'line', borderColor:'rgba(248,81,73,0.5)',  borderWidth:1, borderDash:[4,4], pointRadius:0, fill:false, order:1 },
      { label: '100K (3.5% tier)', data: t100k, type:'line', borderColor:'rgba(227,179,65,0.5)', borderWidth:1, borderDash:[4,4], pointRadius:0, fill:false, order:1 },
      { label: '500K (5% tier)',   data: t500k, type:'line', borderColor:'rgba(88,166,255,0.5)', borderWidth:1, borderDash:[4,4], pointRadius:0, fill:false, order:1 },
    ]},
    options: {
      responsive: true, maintainAspectRatio: false,
      interaction: { mode: 'index', intersect: false },
      plugins: {
        legend: { position:'top', labels:{ usePointStyle:true, font:{ size:10 }, boxWidth:10 } },
        tooltip: { callbacks: {
          title: function(c){ return c[0].label; },
          label: function(c){
            if (c.dataset.label === 'Volume') return ' Volume: ' + Math.round(c.parsed.y).toLocaleString() + ' (' + (c.dataIndex < rows.length ? rows[c.dataIndex].tierLabel : '') + ')';
            return ' ' + c.dataset.label;
          }
        }}
      },
      scales: {
        x: { grid:{ color:'#151a22' }, ticks:{ maxTicksLimit:10, font:{ size:10 }, callback:function(_,i){ return labels[i]?labels[i].slice(0,7):''; } } },
        y: { grid:{ color:'#151a22' }, ticks:{ font:{ size:10 }, callback:function(v){ return v>=1000?(v/1000).toFixed(0)+'K':v; } } }
      }
    }
  });
}

// ‚îÄ‚îÄ Avg Volume & Dollar Value bar chart ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function buildBdryAvgChart(allRows, endIdx) {
  // Windows: trading days (approx) ‚Äî 10D=10, 20D=20, 1M=21, 3M=63, 6M=126, 12M=252, 24M=504
  var windows = [
    { label: '10D',  days: 10  },
    { label: '20D',  days: 20  },
    { label: '1M',   days: 21  },
    { label: '3M',   days: 63  },
    { label: '6M',   days: 126 },
    { label: '12M',  days: 252 },
    { label: '24M',  days: 504 },
  ];

  // Slice data up to endIdx (inclusive)
  var pool = allRows.slice(0, endIdx + 1);

  var avgVols    = [];
  var avgDolVols = [];

  windows.forEach(function(w) {
    var slice = pool.slice(-w.days);  // last N rows up to endIdx
    if (!slice.length) { avgVols.push(null); avgDolVols.push(null); return; }
    var sumVol = 0, sumDol = 0;
    slice.forEach(function(r){ sumVol += r.volume; sumDol += r.dollarVol; });
    avgVols.push(sumVol / slice.length);
    avgDolVols.push(sumDol / slice.length);
  });

  var labels = windows.map(function(w){ return w.label; });

  destroyChart('bdryAvgChart');
  var canvas = document.getElementById('bdryAvgChart'); if (!canvas) return;
  chartRegistry['bdryAvgChart'] = new Chart(canvas.getContext('2d'), {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [
        {
          label: 'Avg Volume (shares)',
          data: avgVols,
          backgroundColor: 'rgba(88,166,255,0.75)',
          borderColor: '#58a6ff',
          borderWidth: 1,
          borderRadius: 4,
          yAxisID: 'yVol',
        },
        {
          label: 'Avg $ Value Traded',
          data: avgDolVols,
          backgroundColor: 'rgba(63,185,80,0.70)',
          borderColor: '#3fb950',
          borderWidth: 1,
          borderRadius: 4,
          yAxisID: 'yDol',
        },
      ]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      interaction: { mode: 'index', intersect: false },
      plugins: {
        legend: { position: 'top', labels: { usePointStyle: true, font: { size: 11 }, padding: 12 } },
        tooltip: { callbacks: {
          label: function(c) {
            if (c.dataset.yAxisID === 'yVol') return ' Avg Volume: ' + Math.round(c.parsed.y).toLocaleString();
            return ' Avg $ Value: $' + (c.parsed.y >= 1e6
              ? (c.parsed.y / 1e6).toFixed(2) + 'M'
              : (c.parsed.y / 1e3).toFixed(0) + 'K');
          }
        }}
      },
      scales: {
        x: {
          grid: { color: '#151a22' },
          ticks: { font: { size: 11 } }
        },
        yVol: {
          type: 'linear',
          position: 'left',
          grid: { color: '#151a22' },
          ticks: { font: { size: 10 }, callback: function(v){ return v >= 1000 ? (v/1000).toFixed(0) + 'K' : v; } },
          title: { display: true, text: 'Avg Volume', color: '#58a6ff', font: { size: 10 } }
        },
        yDol: {
          type: 'linear',
          position: 'right',
          grid: { drawOnChartArea: false },
          ticks: { font: { size: 10 }, callback: function(v){ return v >= 1e6 ? '$' + (v/1e6).toFixed(1) + 'M' : '$' + (v/1e3).toFixed(0) + 'K'; } },
          title: { display: true, text: 'Avg $ Value', color: '#3fb950', font: { size: 10 } }
        }
      }
    }
  });
}

function buildBdryLiqTable(rows) {
  var tableEl = document.getElementById('bdryLiqTable');
  if (!tableEl) return;

  var rev = rows.slice().reverse();

  var html = '<table class="yearly-table" style="min-width:720px;font-size:12px;">';
  html += '<thead><tr style="position:sticky;top:0;background:var(--card);">';
  html += '<th style="text-align:left">Date</th>';
  html += '<th>Close</th>';
  html += '<th>Volume</th>';
  html += '<th>$ Vol Traded</th>';
  html += '<th>Tier %</th>';
  html += '<th>Possible Shares</th>';
  html += '<th>Safe Liquidity</th>';
  html += '<th>Day Chg %</th>';
  html += '</tr></thead><tbody>';

  rev.forEach(function(r) {
    var chgCls = r.chgPct == null ? '' : r.chgPct >= 0 ? 'val-green' : 'val-red';
    var chgStr = r.chgPct != null ? (r.chgPct >= 0 ? '+' : '') + r.chgPct.toFixed(2) + '%' : '‚Äî';
    var tierCls = r.volume < 50000 ? 'val-red' : r.volume < 100000 ? 'val-yellow' : r.volume < 500000 ? '' : 'val-green';

    html += '<tr>';
    html += '<td style="text-align:left;color:var(--text-muted);font-weight:600">' + r.dateStr + '</td>';
    html += '<td>$' + r.close.toFixed(2) + '</td>';
    html += '<td>' + r.volume.toLocaleString() + '</td>';
    html += '<td>$' + Math.round(r.dollarVol).toLocaleString() + '</td>';
    html += '<td class="' + tierCls + '">' + (r.tierPct * 100).toFixed(1) + '%</td>';
    html += '<td>' + r.possShares.toLocaleString() + '</td>';
    html += '<td style="color:var(--green)">' + '$' + Math.round(r.safeLiq).toLocaleString() + '</td>';
    html += '<td class="' + chgCls + '">' + chgStr + '</td>';
    html += '</tr>';
  });

  html += '</tbody></table>';
  tableEl.innerHTML = html;
}

function wireBdryLiqDownload(allRows, s, e) {
  var btn = document.getElementById('bdryLiqDlBtn');
  if (!btn) return;
  btn.onclick = function() {
    var rows = allRows.slice(s, e + 1).slice().reverse();
    var headers = ['Date','Close','Volume','Dollar Vol Traded','Tier %','Possible Shares','Safe Liquidity ($)','Day Change %'];
    var csvRows = rows.map(function(r){
      return [
        r.dateStr, r.close.toFixed(2), r.volume,
        Math.round(r.dollarVol), (r.tierPct * 100).toFixed(1) + '%',
        r.possShares, Math.round(r.safeLiq),
        r.chgPct != null ? r.chgPct.toFixed(2) + '%' : ''
      ];
    });
    downloadCSV('bdry_liquidity.csv', headers, csvRows);
  };
}


</script>
</body>
</html>