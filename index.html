<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Baltic Shipping Market Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  :root {
    --bg: #080c10;
    --card: #0f1318;
    --border: #1e2530;
    --text: #e6edf3;
    --text-muted: #8b949e;
    --accent: #58a6ff;
    --green: #3fb950;
    --red: #f85149;
    --yellow: #e3b341;
    --grid: #151a22;
    --hover: #141920;
  }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
    font-size: 14px;
    line-height: 1.5;
    min-height: 100vh;
  }

  /* HEADER */
  .header {
    background: var(--card);
    border-bottom: 1px solid var(--border);
    padding: 12px 20px;
    display: flex;
    align-items: center;
    gap: 16px;
    flex-wrap: wrap;
    position: sticky;
    top: 0;
    z-index: 100;
  }
  .header h1 {
    font-size: 16px;
    font-weight: 600;
    color: var(--accent);
    white-space: nowrap;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .header h1 span.logo { font-size: 20px; }
  .product-selector {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-left: auto;
  }
  .product-selector label { color: var(--text-muted); font-size: 12px; }
  select {
    background: var(--bg);
    color: var(--text);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 6px 10px;
    font-size: 13px;
    cursor: pointer;
    outline: none;
  }
  select:hover { border-color: var(--accent); }

  /* TABS */
  .tabs-bar {
    background: var(--card);
    border-bottom: 1px solid var(--border);
    padding: 0 20px;
    display: flex;
    overflow-x: auto;
    scrollbar-width: none;
  }
  .tabs-bar::-webkit-scrollbar { display: none; }
  .tab-btn {
    background: none;
    border: none;
    color: var(--text-muted);
    padding: 12px 16px;
    cursor: pointer;
    font-size: 13px;
    font-weight: 500;
    border-bottom: 2px solid transparent;
    white-space: nowrap;
    transition: color 0.15s, border-color 0.15s;
  }
  .tab-btn:hover { color: var(--text); }
  .tab-btn.active { color: var(--accent); border-bottom-color: var(--accent); background: rgba(88, 166, 255, 0.08); border-radius: 4px 4px 0 0; }

  /* MAIN CONTENT */
  .main { padding: 20px; max-width: 1400px; margin: 0 auto; }
  .tab-panel { display: none; }
  .tab-panel.active { display: block; }

  /* LOADING */
  .loading-overlay {
    position: fixed; inset: 0;
    background: rgba(8,12,16,0.95);
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    z-index: 9999;
    gap: 16px;
  }
  .loading-overlay.hidden { display: none; }
  .spinner {
    width: 40px; height: 40px;
    border: 3px solid var(--border);
    border-top-color: var(--accent);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }
  .loading-text { color: var(--text-muted); font-size: 13px; }
  .loading-progress { color: var(--accent); font-size: 12px; }

  /* CARDS */
  .card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 16px;
    transition: border-color 0.15s;
  }
  .card:hover { border-color: #484f58; }
  .card-title {
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: var(--text-muted);
    margin-bottom: 8px;
  }

  /* DASHBOARD TAB */
  .dashboard-hero {
    display: flex;
    align-items: center;
    gap: 24px;
    margin-bottom: 20px;
    flex-wrap: wrap;
  }
  .current-price-block { display: flex; flex-direction: column; gap: 4px; }
  .current-price-label { font-size: 12px; color: var(--text-muted); }
  .current-price-value { font-size: 42px; font-weight: 700; color: var(--text); line-height: 1; }
  .current-price-change { font-size: 14px; font-weight: 500; }
  .change-pos { color: var(--green); }
  .change-neg { color: var(--red); }
  .signal-badge {
    padding: 8px 16px;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 700;
    letter-spacing: 0.3px;
  }
  .signal-sell       { background: rgba(248,81,73,0.25);   color: #f85149; border: 1px solid rgba(248,81,73,0.4); }
  .signal-golden     { background: rgba(255,215,0,0.25);   color: #ffd700; border: 1px solid rgba(255,215,0,0.4); }
  .signal-knife      { background: rgba(255,140,0,0.25);   color: #ff8c00; border: 1px solid rgba(255,140,0,0.4); }
  .signal-trap       { background: rgba(139,148,158,0.25); color: #8b949e; border: 1px solid rgba(139,148,158,0.4); }
  .signal-accumulate { background: rgba(88,166,255,0.25);  color: #58a6ff; border: 1px solid rgba(88,166,255,0.4); }
  .signal-wait       { background: rgba(230,237,243,0.1);  color: #e6edf3; border: 1px solid rgba(230,237,243,0.2); }

  .stats-row {
    display: grid;
    grid-template-columns: repeat(6, 1fr);
    gap: 12px;
    margin-bottom: 20px;
  }
  @media (max-width: 1100px) { .stats-row { grid-template-columns: repeat(3, 1fr); } }
  @media (max-width: 600px)  { .stats-row { grid-template-columns: repeat(2, 1fr); } }

  .stat-card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 14px 16px;
    border-left: 4px solid var(--accent);
  }
  .stat-card.sc-percentile  { border-left-color: #58a6ff; }
  .stat-card.sc-zscore      { border-left-color: #a371f7; }
  .stat-card.sc-drawdown    { border-left-color: #f85149; }
  .stat-card.sc-roc         { border-left-color: #3fb950; }
  .stat-label { font-size: 11px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.4px; margin-bottom: 6px; }
  .stat-value { font-size: 22px; font-weight: 700; }
  .stat-sub { font-size: 11px; color: var(--text-muted); margin-top: 2px; }
  .val-red    { color: var(--red); }
  .val-yellow { color: var(--yellow); }
  .val-green  { color: var(--green); }
  .val-white  { color: var(--text); }
  .val-accent { color: var(--accent); }

  /* CHART CONTAINERS */
  .chart-container {
    position: relative;
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 16px;
  }
  .chart-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
    flex-wrap: wrap;
    gap: 8px;
  }
  .chart-title { font-size: 13px; font-weight: 600; }
  .year-checkboxes { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
  .year-checkbox-item {
    display: flex; align-items: center; gap: 4px;
    font-size: 12px; cursor: pointer; user-select: none;
  }
  .year-checkbox-item input { cursor: pointer; accent-color: var(--accent); }
  .chart-canvas-wrap { height: 320px; position: relative; }

  /* DRAWDOWN CHART */
  .drawdown-chart-wrap { height: 320px; position: relative; }

  /* YEARLY PERFORMANCE TABLE */
  .collapsible-section { margin-top: 20px; }
  .collapsible-toggle {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 10px 16px;
    width: 100%;
    text-align: left;
    color: var(--text);
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: space-between;
    transition: border-color 0.15s;
  }
  .collapsible-toggle:hover { border-color: var(--accent); }
  .collapsible-toggle .toggle-arrow { transition: transform 0.2s; }
  .collapsible-toggle.open .toggle-arrow { transform: rotate(180deg); }
  .collapsible-content { display: none; padding-top: 12px; }
  .collapsible-content.open { display: block; }

  .yearly-table { width: 100%; border-collapse: collapse; font-size: 12px; }
  .yearly-table th {
    background: var(--bg);
    color: var(--text-muted);
    font-weight: 600;
    padding: 7px 10px;
    text-align: right;
    border: 1px solid var(--border);
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 0.3px;
  }
  .yearly-table th:first-child { text-align: left; }
  .yearly-table td {
    padding: 6px 10px;
    text-align: right;
    border: 1px solid var(--grid);
    font-size: 12px;
    font-weight: 500;
    color: var(--text);
  }
  .yearly-table td:first-child { text-align: left; color: var(--text-muted); font-weight: 600; }
  .yearly-table tr:hover td { background: var(--hover); }

  /* CORRELATION MATRIX */
  .corr-section { margin-top: 20px; }
  .corr-title { font-size: 14px; font-weight: 600; margin-bottom: 12px; color: var(--text); }
  .corr-timeframe-btns { display: flex; gap: 8px; margin-bottom: 12px; flex-wrap: wrap; }
  .corr-btn {
    background: var(--bg);
    color: var(--text-muted);
    border: 1px solid var(--border);
    border-radius: 5px;
    padding: 5px 14px;
    font-size: 12px;
    cursor: pointer;
    transition: all 0.15s;
  }
  .corr-btn:hover, .corr-btn.active { border-color: var(--accent); color: var(--accent); background: rgba(88,166,255,0.08); }
  .corr-table { border-collapse: collapse; font-size: 12px; }
  .corr-table th {
    background: var(--bg);
    color: var(--text-muted);
    font-weight: 600;
    padding: 7px 10px;
    text-align: center;
    border: 1px solid var(--border);
    font-size: 11px;
    min-width: 64px;
  }
  .corr-table td {
    padding: 6px 8px;
    text-align: center;
    border: 1px solid var(--border);
    font-size: 12px;
    font-weight: 600;
    min-width: 64px;
    width: 64px;
  }
  .corr-wrap { overflow-x: auto; }

  /* HEATMAPS */
  .heatmap-section { margin-bottom: 28px; }
  .heatmap-title { font-size: 14px; font-weight: 600; margin-bottom: 12px; color: var(--text); }
  .heatmap-wrap { overflow-x: auto; }
  .heatmap-table {
    border-collapse: collapse;
    font-size: 12px;
    min-width: 600px;
  }
  .heatmap-table th {
    background: var(--bg);
    color: var(--text-muted);
    font-weight: 600;
    padding: 7px 10px;
    text-align: center;
    border: 1px solid var(--border);
    white-space: nowrap;
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 0.3px;
  }
  .heatmap-table td {
    padding: 5px 8px;
    text-align: center;
    border: 1px solid var(--grid);
    font-size: 11px;
    font-weight: 500;
    min-width: 72px;
    white-space: nowrap;
    line-height: 1.4;
  }
  .heatmap-table .year-col {
    background: var(--bg);
    color: var(--text-muted);
    font-weight: 600;
    padding: 6px 10px;
    text-align: right;
    font-size: 12px;
  }
  .heatmap-abs-val { font-size: 12px; font-weight: 600; display: block; }
  .heatmap-pct-val { font-size: 10px; display: block; opacity: 0.85; }

  /* HEATMAP VIEW SELECTOR */
  .heatmap-view-row {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 18px;
    flex-wrap: wrap;
  }
  .heatmap-view-row label { color: var(--text-muted); font-size: 12px; font-weight: 600; }

  /* INDICES TAB */
  .indices-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 16px;
  }
  @media (max-width: 900px) { .indices-grid { grid-template-columns: 1fr; } }
  .index-chart-card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 16px;
  }
  .index-chart-header { margin-bottom: 10px; }
  .index-chart-title { font-size: 13px; font-weight: 700; margin-bottom: 2px; }
  .index-chart-subtitle { font-size: 12px; color: var(--text-muted); display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
  .index-chart-canvas-wrap { height: 200px; position: relative; }
  .toggle-btn {
    background: var(--bg);
    color: var(--text-muted);
    border: 1px solid var(--border);
    border-radius: 5px;
    padding: 3px 8px;
    font-size: 11px;
    cursor: pointer;
    transition: all 0.15s;
  }
  .toggle-btn:hover, .toggle-btn.active { border-color: var(--accent); color: var(--accent); }

  /* INDEX STATS STRIP */
  .index-stats-strip {
    display: flex;
    gap: 0;
    margin-top: 10px;
    border: 1px solid var(--border);
    border-radius: 6px;
    overflow: hidden;
  }
  .index-stat-mini {
    flex: 1;
    padding: 7px 10px;
    border-right: 1px solid var(--border);
    background: var(--bg);
    min-width: 0;
  }
  .index-stat-mini:last-child { border-right: none; }
  .index-stat-mini-label { font-size: 9px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.3px; margin-bottom: 3px; white-space: nowrap; }
  .index-stat-mini-val { font-size: 12px; font-weight: 700; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

  /* ETF TAB */
  .etf-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 20px;
  }
  @media (max-width: 900px) { .etf-grid { grid-template-columns: 1fr; } }
  .etf-card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 20px;
  }
  .etf-header { margin-bottom: 16px; }
  .etf-ticker { font-size: 24px; font-weight: 800; color: var(--accent); }
  .etf-name { font-size: 12px; color: var(--text-muted); margin-bottom: 8px; }
  .etf-price-row { display: flex; align-items: baseline; gap: 10px; }
  .etf-price { font-size: 28px; font-weight: 700; }
  .etf-change { font-size: 14px; font-weight: 600; }
  .etf-section-title-row {
    display: flex; align-items: center; justify-content: space-between;
    margin: 16px 0 8px;
  }
  .etf-section-title { font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-muted); }
  .holdings-table { width: 100%; border-collapse: collapse; font-size: 12px; }
  .holdings-table th {
    color: var(--text-muted); font-size: 10px; text-transform: uppercase; letter-spacing: 0.3px;
    padding: 6px 8px; text-align: right; border-bottom: 1px solid var(--border);
    font-weight: 600;
  }
  .holdings-table th:first-child { text-align: left; }
  .holdings-table td {
    padding: 6px 8px; border-bottom: 1px solid var(--grid); text-align: right; color: var(--text);
  }
  .holdings-table td:first-child { text-align: left; color: var(--text-muted); }
  .holdings-table tr:last-child td { border-bottom: none; }
  .holdings-table tr:hover td { background: var(--hover); }
  .row-cape { color: #58a6ff !important; }
  .row-pana { color: #3fb950 !important; }
  .row-supra { color: #d29922 !important; }
  .row-td3c { color: #f0883e !important; }
  .row-td20 { color: #a371f7 !important; }
  .row-cash { color: var(--text-muted) !important; }
  .donut-wrap { height: 200px; position: relative; margin-top: 8px; }
  .etf-metrics { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 16px; }
  .etf-metric { background: var(--bg); border-radius: 6px; padding: 10px 12px; border: 1px solid var(--border); }
  .etf-metric-label { font-size: 10px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.3px; margin-bottom: 4px; }
  .etf-metric-value { font-size: 15px; font-weight: 700; color: var(--text); }

  /* QUARTERLY TAB */
  .win-rate-row {
    display: flex;
    gap: 12px;
    margin-bottom: 20px;
    flex-wrap: wrap;
  }
  .win-rate-card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 12px 18px;
    flex: 1;
    min-width: 110px;
    border-left: 4px solid var(--accent);
  }
  .win-rate-card.wr-green  { border-left-color: var(--green); }
  .win-rate-card.wr-yellow { border-left-color: var(--yellow); }
  .win-rate-card.wr-red    { border-left-color: var(--red); }
  .win-rate-label { font-size: 11px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.4px; margin-bottom: 4px; }
  .win-rate-value { font-size: 22px; font-weight: 700; }
  .win-rate-bar-wrap { height: 4px; background: var(--border); border-radius: 2px; margin-top: 6px; overflow: hidden; }
  .win-rate-bar { height: 100%; border-radius: 2px; }
  .spaghetti-wrap { height: 280px; position: relative; }

  /* DOWNLOAD BUTTON */
  .dl-btn {
    background: var(--bg);
    color: var(--text-muted);
    border: 1px solid var(--border);
    border-radius: 5px;
    padding: 4px 10px;
    font-size: 11px;
    cursor: pointer;
    transition: all 0.15s;
    white-space: nowrap;
  }
  .dl-btn:hover { border-color: var(--accent); color: var(--accent); }

  /* SECTION ERRORS */
  .error-msg {
    background: rgba(248,81,73,0.1);
    border: 1px solid rgba(248,81,73,0.3);
    border-radius: 6px;
    padding: 12px 16px;
    color: var(--red);
    font-size: 13px;
    margin: 8px 0;
  }

  /* SCROLLBAR */
  ::-webkit-scrollbar { width: 6px; height: 6px; }
  ::-webkit-scrollbar-track { background: var(--bg); }
  ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
  ::-webkit-scrollbar-thumb:hover { background: #484f58; }

  /* UTILITY */
  .mb-12 { margin-bottom: 12px; }
  .mb-20 { margin-bottom: 20px; }
  .flex-row { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
  .text-muted { color: var(--text-muted); }
  .text-accent { color: var(--accent); }
  .updated-at { font-size: 11px; color: var(--text-muted); margin-left: auto; }

  /* SECTION TITLE (unified) */
  .section-title {
    font-size: 1.1rem;
    font-weight: 600;
    color: var(--accent);
    border-bottom: 1px solid var(--border);
    padding-bottom: 6px;
    margin-bottom: 16px;
    margin-top: 0;
    letter-spacing: 0.3px;
  }

  /* CHART SECTION */
  .chart-section {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 24px;
  }
  .chart-header-title {
    font-size: 13px;
    font-weight: 600;
    color: var(--text);
  }

  /* ALERTS BANNER */
  .alerts-container {
    padding: 0 20px;
    margin-top: 10px;
    display: flex;
    flex-direction: column;
    gap: 8px;
  }
  .alert-box {
    padding: 12px 16px;
    border-radius: 6px;
    font-size: 13px;
    font-weight: 600;
    display: none;
  }
  .alert-bullish {
    background: rgba(63, 185, 80, 0.1);
    border: 1px solid rgba(63, 185, 80, 0.4);
    color: var(--green);
  }
  .alert-bearish {
    background: rgba(248, 81, 73, 0.1);
    border: 1px solid rgba(248, 81, 73, 0.4);
    color: var(--red);
  }

  /* LIVE DOT */
  .live-dot {
    color: var(--text-muted);
    font-size: 10px;
    margin-right: 5px;
    animation: none;
  }
  .live-dot.active {
    color: var(--green);
    animation: pulse-dot 2s infinite;
  }
  @keyframes pulse-dot {
    0%, 100% { opacity: 1; }
    50%       { opacity: 0.3; }
  }

  /* CONTEXT STRIP */
  .context-strip {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 12px;
    margin-bottom: 24px;
  }
  .context-card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 14px 16px;
    text-align: center;
  }
  .context-label {
    font-size: 11px;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.4px;
    margin-bottom: 6px;
  }
  .context-value {
    font-size: 20px;
    font-weight: 700;
    color: var(--text);
  }

  /* CARD HEADER BAR */
  .card-header-bar {
    background: rgba(88, 166, 255, 0.07);
    border-bottom: 1px solid var(--border);
    padding: 10px 14px;
    margin: -16px -16px 14px -16px;
    border-radius: 8px 8px 0 0;
    font-size: 13px;
    font-weight: 700;
    color: var(--accent);
  }

  /* INDEX DATE RANGE SLIDER */
  .index-range-wrap {
    margin-top: 10px;
    padding: 4px 0 2px;
  }
  .index-range-label {
    font-size: 11px;
    color: var(--text-muted);
    margin-bottom: 6px;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .index-range-label span { color: var(--accent); font-weight: 600; }
  .dual-range-track {
    position: relative;
    height: 4px;
    background: var(--border);
    border-radius: 2px;
    margin: 8px 0 4px;
  }
  .dual-range-track input[type=range] {
    position: absolute;
    width: 100%;
    height: 4px;
    background: transparent;
    appearance: none;
    -webkit-appearance: none;
    pointer-events: none;
    top: 0; left: 0;
    margin: 0; padding: 0;
    outline: none;
    border: none;
  }
  .dual-range-track input[type=range]::-webkit-slider-thumb {
    appearance: none;
    -webkit-appearance: none;
    width: 14px; height: 14px;
    border-radius: 50%;
    background: var(--accent);
    border: 2px solid var(--bg);
    cursor: pointer;
    pointer-events: all;
    position: relative;
    z-index: 2;
  }
  .dual-range-track input[type=range]::-moz-range-thumb {
    width: 14px; height: 14px;
    border-radius: 50%;
    background: var(--accent);
    border: 2px solid var(--bg);
    cursor: pointer;
    pointer-events: all;
  }
  .dual-range-fill {
    position: absolute;
    height: 4px;
    background: var(--accent);
    border-radius: 2px;
    top: 0;
    pointer-events: none;
  }
</style>
</head>
<body>

<!-- LOADING OVERLAY -->
<div class="loading-overlay" id="loadingOverlay">
  <div class="spinner"></div>
  <div class="loading-text">Loading shipping market data‚Ä¶</div>
  <div class="loading-progress" id="loadingProgress">Fetching CSVs (0/8)</div>
</div>

<!-- HEADER -->
<div class="header">
  <h1><span class="logo">‚öì</span> Baltic Shipping Dashboard</h1>
  <div class="product-selector">
    <label for="globalProduct">Index:</label>
    <select id="globalProduct">
      <option value="bdiy">Baltic Dry Index (BDI)</option>
      <option value="cape">Capesize</option>
      <option value="panama">Panamax</option>
      <option value="suprama">Supramax</option>
      <option value="cleantanker">Clean Tanker (BCTI)</option>
      <option value="dirtytanker">Dirty Tanker (BDTI)</option>
    </select>
  </div>
  <div class="updated-at" id="updatedAt"><span class="live-dot" id="liveDot">‚óè</span><span id="updatedAtText"></span></div>
</div>

<!-- TABS BAR -->
<div class="tabs-bar">
  <button class="tab-btn active" data-tab="dashboard">üìä Dashboard</button>
  <button class="tab-btn" data-tab="yearly-dash">üìÖ Yearly</button>
  <button class="tab-btn" data-tab="monthly-dash">üìÜ Monthly</button>
  <button class="tab-btn" data-tab="quarterly">üìä Quarterly</button>
  <button class="tab-btn" data-tab="heatmaps">üå°Ô∏è Heatmaps</button>
  <button class="tab-btn" data-tab="indices">üìà Indices</button>
  <button class="tab-btn" data-tab="etfs">üè¶ ETFs</button>
</div>

<div class="alerts-container" id="alertsContainer">
  <div id="alertBullish" class="alert-box alert-bullish">
    üöÄ BULLISH SIGNAL: <span id="alertBullishText"></span>
  </div>
  <div id="alertBearish" class="alert-box alert-bearish">
    üö® BEARISH SIGNAL: <span id="alertBearishText"></span>
  </div>
</div>

<!-- MAIN CONTENT -->
<div class="main">

  <!-- ===== TAB: DASHBOARD ===== -->
  <div class="tab-panel active" id="tab-dashboard">
    <div class="dashboard-hero mb-20">
      <div class="current-price-block">
        <div class="current-price-label" id="dashProductLabel">Baltic Dry Index (BDI)</div>
        <div class="current-price-value" id="dashCurrentPrice">‚Äî</div>
        <div class="current-price-change" id="dashPriceChange">‚Äî</div>
      </div>
      <div id="dashSignal" class="signal-badge signal-wait">‚è≥ WAIT</div>
    </div>

    <div class="stats-row mb-20">
      <div class="stat-card sc-percentile">
        <div class="stat-label">All-Time Pctl</div>
        <div class="stat-value" id="statAlltime">‚Äî</div>
        <div class="stat-sub">vs full history</div>
      </div>
      <div class="stat-card sc-percentile">
        <div class="stat-label">10Y Percentile</div>
        <div class="stat-value" id="stat10y">‚Äî</div>
        <div class="stat-sub">last 10 years</div>
      </div>
      <div class="stat-card sc-percentile">
        <div class="stat-label">5Y Percentile</div>
        <div class="stat-value" id="stat5y">‚Äî</div>
        <div class="stat-sub">last 5 years</div>
      </div>
      <div class="stat-card sc-zscore">
        <div class="stat-label">Z-Score</div>
        <div class="stat-value" id="statZscore">‚Äî</div>
        <div class="stat-sub">vs same trading day</div>
      </div>
      <div class="stat-card sc-drawdown">
        <div class="stat-label">52-Week Drawdown</div>
        <div class="stat-value" id="statDrawdown">‚Äî</div>
        <div class="stat-sub">from 52-week high</div>
      </div>
      <div class="stat-card sc-roc">
        <div class="stat-label">Rate of Change (20d)</div>
        <div class="stat-value" id="statRoc20">‚Äî</div>
        <div class="stat-sub">20-day % change</div>
      </div>
    </div>

    <!-- Historical Context Strip -->
    <div class="context-strip" id="contextStrip">
      <div class="context-card">
        <div class="context-label">5Y Average</div>
        <div class="context-value" id="ctx5yAvg">‚Äî</div>
      </div>
      <div class="context-card">
        <div class="context-label">vs 5Y Avg</div>
        <div class="context-value" id="ctx5yDev">‚Äî</div>
      </div>
      <div class="context-card">
        <div class="context-label">vs 10Y Avg</div>
        <div class="context-value" id="ctx10yDev">‚Äî</div>
      </div>
    </div>

    <!-- Overlay Chart -->
    <div class="chart-container mb-20">
      <div class="chart-header">
        <div class="chart-title">Current Year vs Historical Years</div>
        <div class="year-checkboxes" id="yearCheckboxes"></div>
      </div>
      <div class="chart-canvas-wrap">
        <canvas id="overlayChart"></canvas>
      </div>
    </div>

    <!-- Drawdown Chart -->
    <div class="chart-container mb-20">
      <div class="chart-header">
        <div class="chart-title">Drawdown from 52-Week High</div>
      </div>
      <div class="drawdown-chart-wrap">
        <canvas id="drawdownChart"></canvas>
      </div>
    </div>

    <!-- Recent Daily Changes -->
    <div class="chart-section">
      <div class="chart-header">
        <div class="chart-header-title">Recent Daily Changes</div>
        <button class="dl-btn" id="recentDlBtn">‚¨á CSV</button>
      </div>
      <div style="overflow-x:auto">
        <div id="recentChangesTable"></div>
      </div>
    </div>

    <!-- Yearly Performance Table -->
    <div class="collapsible-section mb-20">
      <button class="collapsible-toggle" id="yearlyPerfToggle" onclick="toggleYearlyPerf()">
        <span>Yearly Performance Table</span>
        <span class="toggle-arrow">‚ñº</span>
      </button>
      <div class="collapsible-content" id="yearlyPerfContent">
        <div class="flex-row mb-12" style="padding-top:4px">
          <button class="dl-btn" id="yearlyDlBtn">‚¨á Download CSV</button>
        </div>
        <div style="overflow-x:auto">
          <div id="yearlyPerfTable"></div>
        </div>
      </div>
    </div>

    <!-- Correlation Matrix -->
    <div class="corr-section mb-20">
      <div class="section-title">Index Correlation Matrix</div>
      <div class="corr-timeframe-btns">
        <button class="corr-btn active" data-corr="all" onclick="setCorrTimeframe(this,'all')">All Time</button>
        <button class="corr-btn" data-corr="5y" onclick="setCorrTimeframe(this,'5y')">Last 5Y</button>
        <button class="corr-btn" data-corr="1y" onclick="setCorrTimeframe(this,'1y')">Last 1Y</button>
      </div>
      <div class="corr-wrap">
        <div id="corrMatrix"></div>
      </div>
    </div>

    <!-- Signal Methodology -->
    <div class="collapsible-section">
      <button class="collapsible-toggle" id="methodologyToggle" onclick="toggleMethodology()">
        <span>‚ÑπÔ∏è How Signals &amp; Statistics Are Calculated</span>
        <span class="toggle-arrow">‚ñº</span>
      </button>
      <div class="collapsible-content" id="methodologyContent">
        <div style="padding: 16px 4px; font-size: 13px; line-height: 1.8; color: var(--text-muted);">
          <p style="margin-bottom:12px"><strong style="color:var(--text)">Percentile Ranks (All-Time, 10Y, 5Y):</strong> The current index value is ranked against all historical daily values within the respective lookback window. A percentile of 80 means the index is currently higher than 80% of all daily readings in that period.</p>
          <p style="margin-bottom:12px"><strong style="color:var(--text)">Z-Score:</strong> Computed as <code style="background:var(--bg);padding:2px 5px;border-radius:3px;color:var(--accent)">(current value ‚àí mean of same calendar trading day across all years) / standard deviation</code>. Values above +2 or below ‚àí2 indicate statistically unusual levels relative to seasonal norms.</p>
          <p style="margin-bottom:12px"><strong style="color:var(--text)">Rate of Change (ROC):</strong> The percentage change in the index over a rolling 20-trading-day window, indicating short-term momentum.</p>
          <p style="margin-bottom:12px"><strong style="color:var(--text)">Max Drawdown:</strong> The maximum percentage decline from any peak to subsequent trough within the selected lookback window.</p>
          <p style="margin-bottom:0"><strong style="color:var(--text)">Algorithmic Signal:</strong> The signal badge is derived from a combination of Z-score level, percentile rank, and recent rate of change. <em>GOLDEN DIP</em> and <em>ACCUMULATE</em> indicate statistically low or improving conditions; <em>SELL</em> and <em>CATCHING KNIFE</em> indicate elevated or rapidly deteriorating conditions; <em>WAIT</em> and <em>VALUE TRAP</em> indicate ambiguous or transitioning conditions.</p>
        </div>
      </div>
    </div>
  </div>

  <!-- ===== TAB: HEATMAPS ===== -->
  <div class="tab-panel" id="tab-heatmaps">
    <div class="heatmap-view-row">
      <label for="heatmapViewSelect">Heatmap View:</label>
      <select id="heatmapViewSelect" onchange="onHeatmapViewChange()">
        <option value="absolute">Absolute Values</option>
        <option value="pct">% Change (MoM/QoQ)</option>
      </select>
    </div>

    <div class="heatmap-section mb-20">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;flex-wrap:wrap;gap:8px;">
        <div class="section-title" style="margin-bottom:0">Monthly Heatmap</div>
        <button class="dl-btn" id="monthlyHeatmapDlBtn">‚¨á Download CSV</button>
      </div>
      <div class="heatmap-wrap">
        <div id="monthlyHeatmap"></div>
      </div>
    </div>

    <div class="heatmap-section mb-20">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;flex-wrap:wrap;gap:8px;">
        <div class="section-title" style="margin-bottom:0">Monthly Absolute Values</div>
      </div>
      <div class="heatmap-wrap">
        <div id="monthlyAbsHeatmap"></div>
      </div>
    </div>
  </div>

  <!-- ===== TAB: QUARTERLY ===== -->
  <div class="tab-panel" id="tab-quarterly">
    <!-- Win-Rate KPI Cards -->
    <div class="win-rate-row mb-20" id="winRateRow"></div>

    <!-- Download CSV -->
    <div class="flex-row mb-12">
      <button class="dl-btn" id="quarterlyDlBtn">‚¨á Download CSV</button>
    </div>

    <!-- Quarterly Heatmap -->
    <div class="heatmap-section mb-20">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;flex-wrap:wrap;gap:8px;">
        <div class="section-title" style="margin-bottom:0">Quarterly Heatmap</div>
        <button class="dl-btn" id="quarterlyHeatmapDlBtn">‚¨á Download CSV</button>
      </div>
      <div class="heatmap-wrap">
        <div id="quarterlyHeatmap"></div>
      </div>
    </div>

    <!-- Spaghetti Chart -->
    <div class="chart-container mb-20">
      <div class="chart-header">
        <div class="chart-title">Quarterly Performance by Year (Spaghetti)</div>
      </div>
      <div class="spaghetti-wrap">
        <canvas id="spaghettiChart"></canvas>
      </div>
    </div>

    <!-- Quarterly Area Comparison 1 -->
    <div class="chart-container mb-20">
      <div class="chart-header"><div class="chart-title">Quarterly Area Comparison &mdash; Current vs Prior Year</div></div>
      <div class="chart-canvas-wrap" style="height:300px"><canvas id="quarterlyAreaComp1Chart"></canvas></div>
    </div>

    <!-- Quarterly Trend -->
    <div class="chart-container mb-20">
      <div class="chart-header"><div class="chart-title">Quarterly Trend (Last 5 Years)</div></div>
      <div class="chart-canvas-wrap" style="height:300px"><canvas id="quarterlyTrendChart"></canvas></div>
    </div>

    <!-- Quarterly Bar Chart -->
    <div class="chart-container mb-20">
      <div class="chart-header"><div class="chart-title">Quarterly Bar Chart (Last 4 Quarters, QoQ Color)</div></div>
      <div class="chart-canvas-wrap" style="height:300px"><canvas id="quarterlyBarChart"></canvas></div>
    </div>

    <!-- Quarterly Area Comparison 2 -->
    <div class="chart-container mb-20">
      <div class="chart-header"><div class="chart-title">Quarterly Area Comparison &mdash; Current Year vs 5Y Seasonal Avg</div></div>
      <div class="chart-canvas-wrap" style="height:300px"><canvas id="quarterlyAreaComp2Chart"></canvas></div>
    </div>

    <!-- Quarterly Data Grid -->
    <div class="chart-section">
      <div class="chart-header">
        <div class="chart-header-title">Quarterly Data Grid (Last 8 Years)</div>
        <button class="dl-btn" id="quarterlyDashGridDlBtn">&#x2B07; CSV</button>
      </div>
      <div style="overflow-x:auto"><div id="quarterlyDashDataGrid"></div></div>
    </div>
  </div>

  <!-- ===== TAB: INDICES ===== -->
  <div class="tab-panel" id="tab-indices">
    <div class="indices-grid" id="indicesGrid"></div>
  </div>

  <!-- ===== TAB: ETFs ===== -->
  <div class="tab-panel" id="tab-etfs">
    <div class="etf-grid" id="etfGrid"></div>
  </div>


  <!-- ===== TAB: YEARLY DASHBOARD ===== -->
  <div class="tab-panel" id="tab-yearly-dash">
    <div id="yd-kpi-row" class="dashboard-hero mb-20"></div>
    <div class="chart-container mb-20">
      <div class="chart-header"><div class="chart-title">Five-Year Historical</div><button class="dl-btn" id="yd5yDlBtn">&#x2B07; CSV</button></div>
      <div class="chart-canvas-wrap" style="height:300px"><canvas id="yearlyHist5yChart"></canvas></div>
    </div>
    <div class="chart-container mb-20">
      <div class="chart-header"><div class="chart-title">Ten-Year Historical</div><button class="dl-btn" id="yd10yDlBtn">&#x2B07; CSV</button></div>
      <div class="chart-canvas-wrap" style="height:300px"><canvas id="yearlyHist10yChart"></canvas></div>
    </div>
    <div class="chart-container mb-20">
      <div class="chart-header"><div class="chart-title">All-Time Historical (from 2008)</div><button class="dl-btn" id="ydAllDlBtn">&#x2B07; CSV</button></div>
      <div class="chart-canvas-wrap" style="height:300px"><canvas id="yearlyAlltimeChart"></canvas></div>
    </div>
    <div class="chart-container mb-20">
      <div class="chart-header"><div class="chart-title">Z-Score (Rolling 252-Day, Last 3 Years)</div></div>
      <div class="chart-canvas-wrap" style="height:300px"><canvas id="yearlyZscoreChart"></canvas></div>
    </div>
    <div class="chart-container mb-20">
      <div class="chart-header"><div class="chart-title">Historical Z-Score (All Time from 2008)</div></div>
      <div class="chart-canvas-wrap" style="height:300px"><canvas id="yearlyHistZscoreChart"></canvas></div>
    </div>
    <div class="chart-container mb-20">
      <div class="chart-header"><div class="chart-title">Multi-Year Rates (Annual Averages by Product)</div></div>
      <div class="chart-canvas-wrap" style="height:300px"><canvas id="yearlyMultiRatesChart"></canvas></div>
    </div>
    <div class="chart-container mb-20">
      <div class="chart-header"><div class="chart-title">Shipping Rates &mdash; Current Year Monthly Bar</div></div>
      <div class="chart-canvas-wrap" style="height:300px"><canvas id="yearlyShippingRatesChart"></canvas></div>
    </div>
    <div class="chart-container mb-20">
      <div class="chart-header"><div class="chart-title">Rates &mdash; All Products Multi-Year Overlay</div></div>
      <div class="chart-canvas-wrap" style="height:320px"><canvas id="yearlyRatesChart"></canvas></div>
    </div>
    <div class="chart-container mb-20">
      <div class="chart-header"><div class="chart-title">Drawdown % (52-Week Rolling, Last 5 Years)</div></div>
      <div class="chart-canvas-wrap" style="height:300px"><canvas id="yearlyDrawdownChart"></canvas></div>
    </div>
  </div>

  <!-- ===== TAB: MONTHLY DASHBOARD ===== -->
  <div class="tab-panel" id="tab-monthly-dash">
    <div class="chart-container mb-20">
      <div class="chart-header"><div class="chart-title">Monthly Bar Chart (Last 12 Months)</div></div>
      <div class="chart-canvas-wrap" style="height:300px"><canvas id="monthlyBarChart"></canvas></div>
    </div>
    <div class="chart-container mb-20">
      <div class="chart-header"><div class="chart-title">Monthly Trend (Last 3 Years)</div></div>
      <div class="chart-canvas-wrap" style="height:300px"><canvas id="monthlyTrendChart"></canvas></div>
    </div>
    <div class="chart-container mb-20">
      <div class="chart-header"><div class="chart-title">Monthly Area Comparison &mdash; Current vs Prior Year</div></div>
      <div class="chart-canvas-wrap" style="height:300px"><canvas id="monthlyAreaCompChart"></canvas></div>
    </div>
    <div class="chart-section">
      <div class="chart-header">
        <div class="chart-header-title">Monthly Data Grid</div>
        <button class="dl-btn" id="monthlyGridDlBtn">&#x2B07; CSV</button>
      </div>
      <div style="overflow-x:auto"><div id="monthlyDataGrid"></div></div>
    </div>
  </div>

</div><!-- /main -->

<script>
// =====================================================================
// GLOBAL DATA STORE
// =====================================================================
const DATA = {
  raw: {},
  master: [],
  masterByDate: {},
  loaded: false,
};

// Per-product filtered row cache (populated after load)
const _rowCache = {};
function getRows(productKey) {
  if (!_rowCache[productKey]) {
    _rowCache[productKey] = DATA.master.filter(r => r[productKey] != null);
  }
  return _rowCache[productKey];
}
function invalidateRowCache() { for (const k in _rowCache) delete _rowCache[k]; }

// computeStats memoized per product (reset on product switch)
const _statsCache = {};
function getStats(productKey) {
  if (!_statsCache[productKey]) _statsCache[productKey] = computeStats(productKey);
  return _statsCache[productKey];
}
function invalidateStatsCache() { for (const k in _statsCache) delete _statsCache[k]; }

// Correlation cache { key: value } keyed by "A:B:tf"
const _corrCache = {};
function getCorrCached(keyA, keyB, tf) {
  const cacheKey = keyA + ':' + keyB + ':' + tf;
  if (cacheKey in _corrCache) return _corrCache[cacheKey];
  const now = new Date();
  let cutoff = null;
  if (tf === '5y') { cutoff = new Date(now); cutoff.setFullYear(now.getFullYear() - 5); }
  if (tf === '1y') { cutoff = new Date(now); cutoff.setDate(now.getDate() - 365); }
  const r = pearsonCorr(keyA, keyB, cutoff);
  _corrCache[cacheKey] = r;
  return r;
}

// qAvg cache keyed by "productKey:year:quarter"
const _qAvgCache = {};
function getQAvgCached(productKey, year, quarter) {
  const k = productKey + ':' + year + ':' + quarter;
  if (k in _qAvgCache) return _qAvgCache[k];
  const vals = DATA.master.filter(r => r.year === year && r.quarter === quarter && r[productKey] != null).map(r => r[productKey]);
  const v = vals.length ? mean(vals) : null;
  _qAvgCache[k] = v;
  return v;
}

// Product config
const PRODUCTS = {
  bdiy:        { label: 'Baltic Dry Index (BDI)',  file: 'bdiy_historical.csv',       color: '#58a6ff' },
  cape:        { label: 'Capesize',                file: 'cape_historical.csv',        color: '#3fb950' },
  panama:      { label: 'Panamax',                 file: 'panama_historical.csv',      color: '#d29922' },
  suprama:     { label: 'Supramax',                file: 'suprama_historical.csv',     color: '#f0883e' },
  cleantanker: { label: 'Clean Tanker (BCTI)',     file: 'cleantanker_historical.csv', color: '#a371f7' },
  dirtytanker: { label: 'Dirty Tanker (BDTI)',     file: 'dirtytanker_historical.csv', color: '#e3b341' },
};

const PRODUCT_KEYS = Object.keys(PRODUCTS);

const YEAR_COLORS = [
  '#58a6ff', '#3fb950', '#d29922', '#f0883e', '#a371f7',
  '#e3b341', '#79c0ff', '#56d364', '#ffa657', '#bc8cff',
  '#ff7b72', '#39d353', '#b392f0', '#f78166', '#7ee787',
  '#ffa198', '#6cb6ff', '#dbb68f', '#c9d1d9', '#8b949e',
];

// =====================================================================
// CHANGE 10 ‚Äî Global CSV download utility
// =====================================================================
function downloadCSV(filename, headers, rows) {
  const escape = v => {
    const s = String(v == null ? '' : v);
    if (s.includes(',') || s.includes('"') || s.includes('\n')) {
      return '"' + s.replace(/"/g, '""') + '"';
    }
    return s;
  };
  const lines = [headers.map(escape).join(',')];
  for (const row of rows) {
    lines.push(row.map(escape).join(','));
  }
  const blob = new Blob([lines.join('\n')], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  setTimeout(() => URL.revokeObjectURL(url), 5000);
}

// =====================================================================
// UTILITY FUNCTIONS
// =====================================================================
function parseDate(str) {
  if (!str) return null;
  const [d, m, y] = str.split('-');
  if (!d || !m || !y) return null;
  return new Date(parseInt(y), parseInt(m) - 1, parseInt(d));
}

function parseVal(str) {
  if (!str || str === '' || str === 'N/A') return null;
  return parseFloat(String(str).replace(/,/g, '').replace(/%/, ''));
}

function fmt(n, decimals = 0) {
  if (n == null || isNaN(n)) return '‚Äî';
  return n.toLocaleString('en-US', { minimumFractionDigits: decimals, maximumFractionDigits: decimals });
}

function fmtPct(n) {
  if (n == null || isNaN(n)) return '‚Äî';
  const s = (n >= 0 ? '+' : '') + (n * 100).toFixed(1) + '%';
  return s;
}

function fmtPctRaw(n) {
  if (n == null || isNaN(n)) return '‚Äî';
  const s = (n >= 0 ? '+' : '') + n.toFixed(2) + '%';
  return s;
}

function fmtPctDirect(n) {
  // n is already a percentage value (not fractional)
  if (n == null || isNaN(n)) return '‚Äî';
  return (n >= 0 ? '+' : '') + n.toFixed(1) + '%';
}

function getQuarter(month) {
  if (month <= 2) return 'Q1';
  if (month <= 5) return 'Q2';
  if (month <= 8) return 'Q3';
  return 'Q4';
}

const MONTH_NAMES = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];

function percentileRank(arr, value) {
  const sorted = [...arr].filter(x => x != null).sort((a, b) => a - b);
  if (sorted.length === 0) return 0;
  let count = 0;
  for (const v of sorted) { if (v <= value) count++; }
  return count / sorted.length;
}

function mean(arr) {
  const vals = arr.filter(x => x != null);
  if (!vals.length) return null;
  return vals.reduce((s, v) => s + v, 0) / vals.length;
}

function stddev(arr) {
  const vals = arr.filter(x => x != null);
  if (vals.length < 2) return null;
  const m = mean(vals);
  const variance = vals.reduce((s, v) => s + (v - m) ** 2, 0) / vals.length;
  return Math.sqrt(variance);
}

// =====================================================================
// CHANGE 3 ‚Äî Pearson correlation
// =====================================================================
function pearsonCorr(keyA, keyB, cutoffDate) {
  const pairsA = [], pairsB = [];
  for (const row of DATA.master) {
    if (cutoffDate && row.date < cutoffDate) continue;
    if (row[keyA] != null && row[keyB] != null) {
      pairsA.push(row[keyA]);
      pairsB.push(row[keyB]);
    }
  }
  const n = pairsA.length;
  if (n < 5) return null;
  const mA = pairsA.reduce((s, v) => s + v, 0) / n;
  const mB = pairsB.reduce((s, v) => s + v, 0) / n;
  let num = 0, dA = 0, dB = 0;
  for (let i = 0; i < n; i++) {
    const da = pairsA[i] - mA;
    const db = pairsB[i] - mB;
    num += da * db;
    dA  += da * da;
    dB  += db * db;
  }
  const denom = Math.sqrt(dA * dB);
  return denom === 0 ? 0 : num / denom;
}

// =====================================================================
// CHART DEFAULTS (CHANGE 9)
// =====================================================================
Chart.defaults.color = '#8b949e';
Chart.defaults.borderColor = '#151a22';
Chart.defaults.plugins.legend.labels.boxWidth = 12;
Chart.defaults.plugins.legend.labels.padding = 10;
Chart.defaults.plugins.tooltip.backgroundColor = '#0f1318';
Chart.defaults.plugins.tooltip.borderColor = '#1e2530';
Chart.defaults.plugins.tooltip.borderWidth = 1;
Chart.defaults.plugins.tooltip.titleColor = '#e6edf3';
Chart.defaults.plugins.tooltip.bodyColor = '#8b949e';
Chart.defaults.plugins.tooltip.padding = 10;

const chartRegistry = {};
function destroyChart(id) {
  if (chartRegistry[id]) {
    chartRegistry[id].destroy();
    delete chartRegistry[id];
  }
}

// =====================================================================
// DATA LOADING
// =====================================================================
async function fetchCSV(path) {
  const resp = await fetch(path);
  if (!resp.ok) throw new Error(`HTTP ${resp.status} for ${path}`);
  const text = await resp.text();
  return new Promise((resolve, reject) => {
    Papa.parse(text, {
      header: true,
      skipEmptyLines: true,
      complete: r => resolve(r.data),
      error: e => reject(e),
    });
  });
}

async function loadAllData() {
  const overlay = document.getElementById('loadingOverlay');
  const progress = document.getElementById('loadingProgress');
  let loaded = 0;
  const total = PRODUCT_KEYS.length + 2;

  function tick(label) {
    loaded++;
    progress.textContent = `${label} (${loaded}/${total})`;
  }

  const indexPromises = PRODUCT_KEYS.map(async key => {
    const rows = await fetchCSV(PRODUCTS[key].file);
    const parsed = [];
    for (const row of rows) {
      const d = parseDate(row['Date']);
      const v = parseVal(row['Index']);
      const c = parseVal(row['% Change']);
      if (d && v != null) {
        parsed.push({ date: d, dateStr: row['Date'], value: v, change: c });
      }
    }
    parsed.sort((a, b) => a.date - b.date);
    DATA.raw[key] = parsed;
    tick(PRODUCTS[key].label);
    return key;
  });

  const bdryPromise = fetchCSV('bdry_holdings.csv').then(r => { DATA.bdryHoldings = r; tick('BDRY Holdings'); });
  const bwetPromise = fetchCSV('bwet_holdings.csv').then(r => { DATA.bwetHoldings = r; tick('BWET Holdings'); });

  await Promise.all([...indexPromises, bdryPromise, bwetPromise]);

  buildMaster();

  DATA.loaded = true;
  overlay.classList.add('hidden');

  const now = new Date();
  document.getElementById('updatedAtText').textContent =
    `Data as of ${now.toLocaleDateString('en-US', { month:'short', day:'numeric', year:'numeric' })}`;
  document.getElementById('liveDot').classList.add('active');
}

function buildMaster() {
  const allDatesSet = new Set();
  for (const key of PRODUCT_KEYS) {
    for (const row of DATA.raw[key]) allDatesSet.add(row.date.getTime());
  }
  const allDates = Array.from(allDatesSet).sort((a, b) => a - b);

  const maps = {};
  for (const key of PRODUCT_KEYS) {
    maps[key] = {};
    for (const row of DATA.raw[key]) {
      maps[key][row.date.getTime()] = row;
    }
  }

  DATA.master = allDates.map(ts => {
    const d = new Date(ts);
    const month = d.getMonth();
    const quarter = getQuarter(month);
    const year = d.getFullYear();
    const row = { date: d, ts, year, month, quarter };
    for (const key of PRODUCT_KEYS) {
      const r = maps[key][ts];
      row[key] = r ? r.value : null;
      row[`${key}_change`] = r ? r.change : null;
    }
    return row;
  });

  const byYear = {};
  for (const row of DATA.master) {
    if (!byYear[row.year]) byYear[row.year] = [];
    byYear[row.year].push(row);
  }
  for (const year in byYear) {
    byYear[year].forEach((row, i) => { row.tradingDay = i + 1; });
  }
  DATA.byYear = byYear;

  for (const row of DATA.master) {
    DATA.masterByDate[row.ts] = row;
  }
  invalidateRowCache();
  invalidateStatsCache();
}

// =====================================================================
// ANALYTICS
// =====================================================================
function computeStats(productKey) {
  const rows = getRows(productKey);
  if (!rows.length) return null;

  const latest = rows[rows.length - 1];
  const currentPrice = latest[productKey];
  const prevRow = rows[rows.length - 2];
  const prevPrice = prevRow ? prevRow[productKey] : null;
  const pctChange = prevPrice ? ((currentPrice - prevPrice) / prevPrice) * 100 : null;

  const now = latest.date;
  const cutoff10y = new Date(now); cutoff10y.setFullYear(now.getFullYear() - 10);
  const cutoff5y  = new Date(now); cutoff5y.setFullYear(now.getFullYear() - 5);
  const cutoff1y  = new Date(now); cutoff1y.setDate(now.getDate() - 365);
  const cutoff20d = new Date(now); cutoff20d.setDate(now.getDate() - 20);

  const allVals   = rows.map(r => r[productKey]);
  const vals10y   = rows.filter(r => r.date >= cutoff10y).map(r => r[productKey]);
  const vals5y    = rows.filter(r => r.date >= cutoff5y).map(r => r[productKey]);
  const vals1y    = rows.filter(r => r.date >= cutoff1y).map(r => r[productKey]);

  const alltimePctl = percentileRank(allVals, currentPrice);
  const pctl10y     = percentileRank(vals10y, currentPrice);
  const pctl5y      = percentileRank(vals5y, currentPrice);

  const currentTradingDay = latest.tradingDay;
  const sameDayVals = DATA.master
    .filter(r => r.tradingDay === currentTradingDay && r.year < now.getFullYear() && r[productKey] != null)
    .map(r => r[productKey]);
  const allMean   = mean(sameDayVals.length >= 3 ? sameDayVals : allVals);
  const allStdDev = stddev(sameDayVals.length >= 3 ? sameDayVals : allVals);
  const zScore    = allStdDev ? (currentPrice - allMean) / allStdDev : 0;

  const max1y = vals1y.length ? vals1y.reduce((a, b) => a > b ? a : b, -Infinity) : currentPrice;
  const drawdown = (currentPrice - max1y) / max1y;

  const row20d = rows.filter(r => r.date <= cutoff20d);
  const price20d = row20d.length ? row20d[row20d.length - 1][productKey] : null;
  const roc20 = price20d ? ((currentPrice - price20d) / price20d) * 100 : null;

  return {
    currentPrice, pctChange, alltimePctl, pctl10y, pctl5y, zScore, drawdown, roc20,
  };
}

function tradingSignal(stats) {
  if (!stats) return { text: '‚è≥ WAIT', cls: 'signal-wait' };
  const { pctl5y, zScore, alltimePctl } = stats;
  if (pctl5y > 0.8)                                              return { text: '‚õî SELL (Overheated)',  cls: 'signal-sell' };
  if (pctl5y < 0.2 && zScore < -0.5 && alltimePctl > 0.4)       return { text: 'üíé GOLDEN DIP',         cls: 'signal-golden' };
  if (pctl5y < 0.1 && zScore < -0.6)                            return { text: 'üî• CATCHING KNIFE',     cls: 'signal-knife' };
  if (pctl5y < 0.3 && alltimePctl < 0.3)                        return { text: '‚ö†Ô∏è VALUE TRAP',         cls: 'signal-trap' };
  if (pctl5y < 0.4)                                              return { text: 'üîπ ACCUMULATE',         cls: 'signal-accumulate' };
  return { text: '‚è≥ WAIT', cls: 'signal-wait' };
}

function pctColor(pct) {
  if (pct < 0.3) return 'val-red';
  if (pct < 0.7) return 'val-yellow';
  return 'val-green';
}

// =====================================================================
// DASHBOARD TAB
// =====================================================================
let currentCorrTimeframe = 'all';

function renderDashboard(productKey) {
  const prod = PRODUCTS[productKey];
  document.getElementById('dashProductLabel').textContent = prod.label;

  const stats = getStats(productKey);
  if (!stats) return;

  const rows   = getRows(productKey);
  const latest = rows[rows.length - 1];

  document.getElementById('dashCurrentPrice').textContent = fmt(stats.currentPrice);

  const changeEl = document.getElementById('dashPriceChange');
  if (stats.pctChange != null) {
    const sign = stats.pctChange >= 0 ? '+' : '';
    changeEl.textContent = `${sign}${stats.pctChange.toFixed(2)}% vs prior day`;
    changeEl.className = 'current-price-change ' + (stats.pctChange >= 0 ? 'change-pos' : 'change-neg');
  } else {
    changeEl.textContent = '‚Äî';
    changeEl.className = 'current-price-change';
  }

  const sig = tradingSignal(stats);
  const sigEl = document.getElementById('dashSignal');
  sigEl.textContent = sig.text;
  sigEl.className = 'signal-badge ' + sig.cls;

  // Alerts banner
  const bullishEl  = document.getElementById('alertBullish');
  const bearishEl  = document.getElementById('alertBearish');
  const bullishTxt = document.getElementById('alertBullishText');
  const bearishTxt = document.getElementById('alertBearishText');
  if (sig.text.includes('ACCUMULATE') || sig.text.includes('GOLDEN')) {
    bullishTxt.textContent = sig.text;
    bullishEl.style.display  = 'block';
    bearishEl.style.display  = 'none';
  } else if (sig.text.includes('SELL') || sig.text.includes('KNIFE')) {
    bearishTxt.textContent = sig.text;
    bearishEl.style.display  = 'block';
    bullishEl.style.display  = 'none';
  } else {
    bullishEl.style.display = 'none';
    bearishEl.style.display = 'none';
  }

  // Stats cards
  const atEl = document.getElementById('statAlltime');
  atEl.textContent = (stats.alltimePctl * 100).toFixed(1) + '%';
  atEl.className = 'stat-value ' + pctColor(stats.alltimePctl);

  const t10El = document.getElementById('stat10y');
  t10El.textContent = (stats.pctl10y * 100).toFixed(1) + '%';
  t10El.className = 'stat-value ' + pctColor(stats.pctl10y);

  const t5El = document.getElementById('stat5y');
  t5El.textContent = (stats.pctl5y * 100).toFixed(1) + '%';
  t5El.className = 'stat-value ' + pctColor(stats.pctl5y);

  const zsEl = document.getElementById('statZscore');
  zsEl.textContent = stats.zScore.toFixed(2);
  zsEl.className = 'stat-value ' + (stats.zScore < -1 ? 'val-red' : stats.zScore > 1 ? 'val-green' : 'val-yellow');

  const ddEl = document.getElementById('statDrawdown');
  ddEl.textContent = (stats.drawdown * 100).toFixed(1) + '%';
  ddEl.className = 'stat-value ' + (stats.drawdown < -0.3 ? 'val-red' : stats.drawdown < -0.1 ? 'val-yellow' : 'val-green');

  // CHANGE 11 ‚Äî ROC20 stat card
  const rocEl = document.getElementById('statRoc20');
  if (stats.roc20 != null) {
    rocEl.textContent = (stats.roc20 >= 0 ? '+' : '') + stats.roc20.toFixed(1) + '%';
    rocEl.className = 'stat-value ' + (stats.roc20 >= 0 ? 'val-green' : 'val-red');
  } else {
    rocEl.textContent = '‚Äî';
    rocEl.className = 'stat-value val-white';
  }

  // Historical Context Strip
  const cut5y2  = new Date(latest.date); cut5y2.setFullYear(latest.date.getFullYear() - 5);
  const cut10y2 = new Date(latest.date); cut10y2.setFullYear(latest.date.getFullYear() - 10);
  const avg5y  = mean(rows.filter(r => r.date >= cut5y2).map(r => r[productKey]));
  const avg10y = mean(rows.filter(r => r.date >= cut10y2).map(r => r[productKey]));
  // rows already from getRows() cache above
  const ctx5yAvgEl  = document.getElementById('ctx5yAvg');
  const ctx5yDevEl  = document.getElementById('ctx5yDev');
  const ctx10yDevEl = document.getElementById('ctx10yDev');
  if (ctx5yAvgEl) {
    ctx5yAvgEl.textContent = avg5y != null ? fmt(avg5y, 0) : '‚Äî';
    if (avg5y != null) {
      const dev5y  = ((stats.currentPrice - avg5y)  / avg5y  * 100);
      const dev10y = avg10y != null ? ((stats.currentPrice - avg10y) / avg10y * 100) : null;
      ctx5yDevEl.textContent  = (dev5y  >= 0 ? '+' : '') + dev5y.toFixed(1)  + '%';
      ctx5yDevEl.className    = 'context-value ' + (dev5y  >= 0 ? 'val-green' : 'val-red');
      if (dev10y != null) {
        ctx10yDevEl.textContent = (dev10y >= 0 ? '+' : '') + dev10y.toFixed(1) + '%';
        ctx10yDevEl.className   = 'context-value ' + (dev10y >= 0 ? 'val-green' : 'val-red');
      } else {
        ctx10yDevEl.textContent = '‚Äî';
        ctx10yDevEl.className   = 'context-value';
      }
    }
  }

  renderOverlayChart(productKey);
  renderDrawdownChart(productKey);
  renderYearlyPerfTable(productKey);
  renderCorrMatrix(currentCorrTimeframe);
  renderRecentChanges(productKey);
}

// =====================================================================
// OVERLAY CHART
// =====================================================================
function renderOverlayChart(productKey) {
  const years = Object.keys(DATA.byYear).map(Number).sort((a, b) => a - b);
  const currentYear = new Date().getFullYear();

  const defaultCompare = years
    .filter(y => y < currentYear)
    .slice(-3)
    .reverse()
    .slice(0, 3);

  const checkboxContainer = document.getElementById('yearCheckboxes');
  checkboxContainer.innerHTML = '';

  const priorYears = years.filter(y => y < currentYear);

  for (const y of priorYears) {
    const checked = defaultCompare.includes(y) ? 'checked' : '';
    const color = YEAR_COLORS[priorYears.indexOf(y) % YEAR_COLORS.length];
    const item = document.createElement('label');
    item.className = 'year-checkbox-item';
    item.innerHTML = `<input type="checkbox" value="${y}" ${checked} style="accent-color:${color}"> <span style="color:${color}">${y}</span>`;
    item.querySelector('input').addEventListener('change', () => buildOverlayChart(productKey));
    checkboxContainer.appendChild(item);
  }

  buildOverlayChart(productKey);
}

function buildOverlayChart(productKey) {
  const currentYear = new Date().getFullYear();
  const years = Object.keys(DATA.byYear).map(Number).sort((a, b) => a - b);

  const checkboxes = document.querySelectorAll('#yearCheckboxes input[type=checkbox]:checked');
  const selectedYears = Array.from(checkboxes).map(cb => parseInt(cb.value));

  const datasets = [];
  const prod = PRODUCTS[productKey];

  let maxDays = 0;
  for (const y of [...selectedYears, currentYear]) {
    const yr = DATA.byYear[y];
    if (yr) maxDays = Math.max(maxDays, yr.length);
  }
  const labels = Array.from({ length: maxDays }, (_, i) => i + 1);

  const curYearRows = DATA.byYear[currentYear] || [];
  datasets.push({
    label: String(currentYear),
    data: curYearRows.map(r => r[productKey] ?? null),
    borderColor: prod.color,
    backgroundColor: 'transparent',
    borderWidth: 3,
    pointRadius: 0,
    tension: 0.2,
    order: 0,
  });

  const checkboxEls = document.querySelectorAll('#yearCheckboxes input[type=checkbox]');

  selectedYears.sort((a, b) => b - a).forEach((y, idx) => {
    const rows = DATA.byYear[y] || [];
    const checkEl = Array.from(checkboxEls).find(cb => parseInt(cb.value) === y);
    const colorIdx = checkEl ? Array.from(checkboxEls).indexOf(checkEl) : idx;
    const color = YEAR_COLORS[colorIdx % YEAR_COLORS.length];
    datasets.push({
      label: String(y),
      data: rows.map(r => r[productKey] ?? null),
      borderColor: color,
      backgroundColor: 'transparent',
      borderWidth: 1.5,
      pointRadius: 0,
      tension: 0.2,
      borderDash: [],
      order: idx + 1,
    });
  });

  destroyChart('overlayChart');
  const ctx = document.getElementById('overlayChart').getContext('2d');
  chartRegistry['overlayChart'] = new Chart(ctx, {
    type: 'line',
    data: { labels, datasets },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: { mode: 'index', intersect: false },
      plugins: {
        legend: { position: 'top', labels: { usePointStyle: true } },
        tooltip: {
          callbacks: {
            title: ctx => `Trading Day ${ctx[0].label}`,
            label: ctx => ` ${ctx.dataset.label}: ${fmt(ctx.parsed.y)}`,
          },
        },
      },
      scales: {
        x: {
          grid: { color: '#151a22' },
          ticks: { maxTicksLimit: 13, font: { size: 11 } },
          title: { display: true, text: 'Trading Day of Year', color: '#8b949e', font: { size: 11 } },
        },
        y: {
          grid: { color: '#151a22' },
          ticks: { font: { size: 11 }, callback: v => fmt(v) },
          title: { display: true, text: PRODUCTS[productKey].label, color: '#8b949e', font: { size: 11 } },
        },
      },
    },
  });
}

// =====================================================================
// CHANGE 1 ‚Äî Drawdown Chart
// =====================================================================
function renderDrawdownChart(productKey) {
  const rows = getRows(productKey);
  if (!rows.length) return;

  // Last 3 years
  const cutoff3y = new Date();
  cutoff3y.setFullYear(cutoff3y.getFullYear() - 3);
  const filtered = rows.filter(r => r.date >= cutoff3y);

  // Rolling 365-day max for each point
  const ddData = [];
  const labels = [];

  for (let i = 0; i < filtered.length; i++) {
    const current = filtered[i];
    const cutoff365 = new Date(current.date);
    cutoff365.setDate(cutoff365.getDate() - 365);
    // find max in last 365 days from the full rows array
    let maxVal = current[productKey];
    for (let j = rows.length - 1; j >= 0; j--) {
      if (rows[j].date > current.date) continue;
      if (rows[j].date < cutoff365) break;
      if (rows[j][productKey] > maxVal) maxVal = rows[j][productKey];
    }
    const dd = maxVal > 0 ? ((current[productKey] - maxVal) / maxVal) * 100 : 0;
    ddData.push(dd);
    labels.push(current.date.toISOString().split('T')[0]);
  }

  destroyChart('drawdownChart');
  const ctx = document.getElementById('drawdownChart').getContext('2d');

  chartRegistry['drawdownChart'] = new Chart(ctx, {
    type: 'line',
    data: {
      labels,
      datasets: [{
        label: 'Drawdown %',
        data: ddData,
        borderColor: '#f85149',
        backgroundColor: 'rgba(248,81,73,0.3)',
        borderWidth: 1.5,
        pointRadius: 0,
        fill: true,
        tension: 0.1,
      }],
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: { mode: 'index', intersect: false },
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            title: ctx => ctx[0].label,
            label: ctx => ` Drawdown: ${ctx.parsed.y.toFixed(2)}%`,
          },
        },
      },
      scales: {
        x: {
          grid: { color: '#151a22' },
          ticks: {
            maxTicksLimit: 8,
            font: { size: 11 },
            callback: function(val, idx) {
              return labels[idx] ? labels[idx].slice(0, 7) : '';
            },
          },
        },
        y: {
          grid: { color: '#151a22' },
          min: undefined,
          max: 0,
          ticks: {
            font: { size: 11 },
            callback: v => v.toFixed(1) + '%',
          },
          title: { display: true, text: 'Drawdown %', color: '#8b949e', font: { size: 11 } },
        },
      },
    },
  });
}

// =====================================================================
// CHANGE 2 ‚Äî Yearly Performance Table
// =====================================================================
let _yearlyPerfProductKey = null;
let _yearlyPerfData = null;

function renderYearlyPerfTable(productKey) {
  _yearlyPerfProductKey = productKey;
  const years = [...new Set(DATA.master.map(r => r.year))].sort((a, b) => b - a);

  // Compute yearly averages
  const yearlyAvgs = {};
  const yearlyMins = {};
  const yearlyMaxs = {};
  for (const y of years) {
    const vals = getRows(productKey).filter(r => r.year === y).map(r => r[productKey]);
    yearlyAvgs[y] = vals.length ? mean(vals) : null;
    yearlyMins[y] = vals.length ? Math.min(...vals) : null;
    yearlyMaxs[y] = vals.length ? Math.max(...vals) : null;
  }

  _yearlyPerfData = { years, yearlyAvgs, yearlyMins, yearlyMaxs };

  let html = `<table class="yearly-table">
    <thead><tr>
      <th>Year</th>
      <th>Avg Value</th>
      <th>YoY %</th>
      <th>Min</th>
      <th>Max</th>
      <th>Range %</th>
    </tr></thead><tbody>`;

  for (let i = 0; i < years.length; i++) {
    const y = years[i];
    const avg = yearlyAvgs[y];
    const mn  = yearlyMins[y];
    const mx  = yearlyMaxs[y];
    if (avg == null) continue;

    // Prior year avg (years are descending, so prior = years[i+1])
    const priorYear = years[i + 1];
    const priorAvg  = priorYear != null ? yearlyAvgs[priorYear] : null;
    let yoyPct = null;
    let yoyCls = '';
    let yoyStr = '‚Äî';
    if (priorAvg != null && priorAvg !== 0) {
      yoyPct = ((avg - priorAvg) / priorAvg) * 100;
      yoyStr = (yoyPct >= 0 ? '+' : '') + yoyPct.toFixed(1) + '%';
      yoyCls = yoyPct >= 0 ? 'val-green' : 'val-red';
    }

    const rangePct = mn != null && mn !== 0 ? ((mx - mn) / mn * 100).toFixed(1) + '%' : '‚Äî';

    html += `<tr>
      <td>${y}</td>
      <td>${fmt(avg, 0)}</td>
      <td class="${yoyCls}">${yoyStr}</td>
      <td>${fmt(mn, 0)}</td>
      <td>${fmt(mx, 0)}</td>
      <td>${rangePct}</td>
    </tr>`;
  }

  html += '</tbody></table>';
  document.getElementById('yearlyPerfTable').innerHTML = html;

  // Wire download button
  document.getElementById('yearlyDlBtn').onclick = () => downloadYearlyPerf(productKey);
}

function downloadYearlyPerf(productKey) {
  if (!_yearlyPerfData) return;
  const { years, yearlyAvgs, yearlyMins, yearlyMaxs } = _yearlyPerfData;
  const headers = ['Year','Avg Value','YoY %','Min','Max','Range %'];
  const rows = [];
  for (let i = 0; i < years.length; i++) {
    const y = years[i];
    const avg = yearlyAvgs[y];
    const mn  = yearlyMins[y];
    const mx  = yearlyMaxs[y];
    if (avg == null) continue;
    const priorYear = years[i + 1];
    const priorAvg  = priorYear != null ? yearlyAvgs[priorYear] : null;
    let yoyStr = '';
    if (priorAvg != null && priorAvg !== 0) {
      const yoy = ((avg - priorAvg) / priorAvg) * 100;
      yoyStr = yoy.toFixed(2) + '%';
    }
    const rangePct = mn != null && mn !== 0 ? ((mx - mn) / mn * 100).toFixed(2) + '%' : '';
    rows.push([y, avg != null ? avg.toFixed(2) : '', yoyStr, mn != null ? mn.toFixed(2) : '', mx != null ? mx.toFixed(2) : '', rangePct]);
  }
  downloadCSV(`yearly_perf_${productKey}.csv`, headers, rows);
}

function toggleYearlyPerf() {
  const btn = document.getElementById('yearlyPerfToggle');
  const content = document.getElementById('yearlyPerfContent');
  btn.classList.toggle('open');
  content.classList.toggle('open');
}

// =====================================================================
// CHANGE 3 ‚Äî Correlation Matrix
// =====================================================================
const CORR_LABELS = ['BDI','Cape','Panama','Supra','CleanT','DirtyT'];

function setCorrTimeframe(el, tf) {
  currentCorrTimeframe = tf;
  document.querySelectorAll('.corr-btn').forEach(b => b.classList.remove('active'));
  el.classList.add('active');
  renderCorrMatrix(tf);
}

function corrColor(r) {
  // -1 = deep red, 0 = dark gray #21262d, +1 = bright green
  if (r == null) return '#21262d';
  const clamped = Math.max(-1, Math.min(1, r));
  if (clamped < 0) {
    // 0 ‚Üí #21262d, -1 ‚Üí #8b0000
    const t = -clamped; // 0..1
    const r_ = Math.round(0x21 + t * (0x8b - 0x21));
    const g_ = Math.round(0x26 + t * (0x00 - 0x26));
    const b_ = Math.round(0x2d + t * (0x00 - 0x2d));
    return `rgb(${r_},${g_},${b_})`;
  } else {
    // 0 ‚Üí #21262d, +1 ‚Üí #00c853
    const t = clamped;
    const r_ = Math.round(0x21 + t * (0x00 - 0x21));
    const g_ = Math.round(0x26 + t * (0xc8 - 0x26));
    const b_ = Math.round(0x2d + t * (0x53 - 0x2d));
    return `rgb(${r_},${g_},${b_})`;
  }
}

function renderCorrMatrix(tf) {
  const container = document.getElementById('corrMatrix');
  let html = `<table class="corr-table"><thead><tr><th></th>`;
  for (const lbl of CORR_LABELS) html += `<th>${lbl}</th>`;
  html += '</tr></thead><tbody>';

  for (let i = 0; i < PRODUCT_KEYS.length; i++) {
    html += `<tr><th style="text-align:left;background:var(--bg);color:var(--text-muted);font-size:11px">${CORR_LABELS[i]}</th>`;
    for (let j = 0; j < PRODUCT_KEYS.length; j++) {
      if (i === j) {
        html += `<td style="background:#1c3150;color:#58a6ff;font-weight:700">1.00</td>`;
      } else {
        const r = getCorrCached(PRODUCT_KEYS[i], PRODUCT_KEYS[j], tf);
        const bg = corrColor(r);
        const textCol = r != null && Math.abs(r) > 0.4 ? '#fff' : '#e6edf3';
        html += `<td style="background:${bg};color:${textCol}">${r != null ? r.toFixed(2) : '‚Äî'}</td>`;
      }
    }
    html += '</tr>';
  }
  html += '</tbody></table>';
  container.innerHTML = html;
}

// =====================================================================
// HEATMAPS TAB
// =====================================================================
let currentHeatmapView = 'absolute';

function onHeatmapViewChange() {
  currentHeatmapView = document.getElementById('heatmapViewSelect').value;
  renderHeatmaps(currentProduct);
}

function renderHeatmaps(productKey) {
  if (currentHeatmapView === 'pct') {
    renderMonthlyHeatmapPct(productKey);
  } else {
    renderMonthlyHeatmap(productKey);
  }
  renderMonthlyAbsHeatmap(productKey);

  // Wire download buttons
  document.getElementById('monthlyHeatmapDlBtn').onclick = () => downloadMonthlyHeatmap(productKey);
}

// ---- Original absolute-value heatmap color (for Monthly Abs section) ----
function heatmapColorAbs(ratio) {
  // dark low: #5c1a1a, dark high: #1a2e1a, mid: #21262d
  if (ratio <= 0.5) {
    const t = ratio * 2;
    const r = Math.round(0x5c + t * (0x21 - 0x5c));
    const g = Math.round(0x1a + t * (0x26 - 0x1a));
    const b = Math.round(0x1a + t * (0x2d - 0x1a));
    return `rgb(${r},${g},${b})`;
  } else {
    const t = (ratio - 0.5) * 2;
    const r = Math.round(0x21 + t * (0x1a - 0x21));
    const g = Math.round(0x26 + t * (0x2e - 0x26));
    const b = Math.round(0x2d + t * (0x1a - 0x2d));
    return `rgb(${r},${g},${b})`;
  }
}

// ---- % Change divergent color ----
function heatmapColorPct(pctVal) {
  // ‚â§ -15% ‚Üí #8b0000, 0% ‚Üí #1a1a2e, ‚â• +15% ‚Üí #00c853
  const clamped = Math.max(-15, Math.min(15, pctVal));
  if (clamped < 0) {
    const t = -clamped / 15; // 0..1
    const r = Math.round(0x1a + t * (0x8b - 0x1a));
    const g = Math.round(0x1a + t * (0x00 - 0x1a));
    const b = Math.round(0x2e + t * (0x00 - 0x2e));
    return `rgb(${r},${g},${b})`;
  } else {
    const t = clamped / 15;
    const r = Math.round(0x1a + t * (0x00 - 0x1a));
    const g = Math.round(0x1a + t * (0xc8 - 0x1a));
    const b = Math.round(0x2e + t * (0x53 - 0x2e));
    return `rgb(${r},${g},${b})`;
  }
}

function heatmapTextColor(bgHex) {
  return '#e6edf3';
}

function renderMonthlyHeatmap(productKey) {
  const container = document.getElementById('monthlyHeatmap');
  const years = [...new Set(DATA.master.map(r => r.year))].sort();

  const matrix = {};
  for (const y of years) {
    matrix[y] = {};
    for (let m = 0; m < 12; m++) {
      const vals = DATA.master.filter(r => r.year === y && r.month === m && r[productKey] != null).map(r => r[productKey]);
      matrix[y][m] = vals.length ? mean(vals) : null;
    }
  }

  const colStats = {};
  for (let m = 0; m < 12; m++) {
    const vals = years.map(y => matrix[y][m]).filter(v => v != null);
    colStats[m] = { min: Math.min(...vals), max: Math.max(...vals) };
  }

  let html = `<table class="heatmap-table"><thead><tr>
    <th>Year</th>${MONTH_NAMES.map(mn => `<th>${mn}</th>`).join('')}
  </tr></thead><tbody>`;

  for (const y of [...years].reverse()) {
    html += `<tr><td class="year-col">${y}</td>`;
    for (let m = 0; m < 12; m++) {
      const v = matrix[y][m];
      if (v == null) {
        html += `<td style="color:#484f58">‚Äî</td>`;
      } else {
        const { min, max } = colStats[m];
        const ratio = max > min ? (v - min) / (max - min) : 0.5;
        const bg = heatmapColorAbs(ratio);
        html += `<td style="background:${bg};color:#e6edf3">${fmt(v, 0)}</td>`;
      }
    }
    html += '</tr>';
  }
  html += '</tbody></table>';
  container.innerHTML = html;
}

function renderMonthlyHeatmapPct(productKey) {
  const container = document.getElementById('monthlyHeatmap');
  const years = [...new Set(DATA.master.map(r => r.year))].sort();

  // Build avg matrix
  const matrix = {};
  for (const y of years) {
    matrix[y] = {};
    for (let m = 0; m < 12; m++) {
      const vals = DATA.master.filter(r => r.year === y && r.month === m && r[productKey] != null).map(r => r[productKey]);
      matrix[y][m] = vals.length ? mean(vals) : null;
    }
  }

  let html = `<table class="heatmap-table"><thead><tr>
    <th>Year</th>${MONTH_NAMES.map(mn => `<th>${mn}</th>`).join('')}
  </tr></thead><tbody>`;

  for (const y of [...years].reverse()) {
    html += `<tr><td class="year-col">${y}</td>`;
    for (let m = 0; m < 12; m++) {
      const v = matrix[y][m];
      if (v == null) {
        html += `<td style="color:#484f58">‚Äî</td>`;
      } else {
        // MoM %: compare to previous month (could be prior year month 11)
        let prevV = null;
        if (m > 0) {
          prevV = matrix[y][m - 1];
        } else {
          // January: compare to prior year December
          const priorYear = y - 1;
          if (matrix[priorYear]) prevV = matrix[priorYear][11];
        }
        let pctStr = '';
        let bg = heatmapColorPct(0);
        if (prevV != null && prevV !== 0) {
          const pct = ((v - prevV) / prevV) * 100;
          pctStr = (pct >= 0 ? '+' : '') + pct.toFixed(1) + '%';
          bg = heatmapColorPct(pct);
        } else {
          pctStr = '‚Äî';
        }
        html += `<td style="background:${bg};color:#e6edf3">
          <span class="heatmap-abs-val">${fmt(v, 0)}</span>
          <span class="heatmap-pct-val">${pctStr}</span>
        </td>`;
      }
    }
    html += '</tr>';
  }
  html += '</tbody></table>';
  container.innerHTML = html;
}

function renderMonthlyAbsHeatmap(productKey) {
  const container = document.getElementById('monthlyAbsHeatmap');
  const years = [...new Set(DATA.master.map(r => r.year))].sort();

  const matrix = {};
  for (const y of years) {
    matrix[y] = {};
    for (let m = 0; m < 12; m++) {
      const vals = DATA.master.filter(r => r.year === y && r.month === m && r[productKey] != null).map(r => r[productKey]);
      matrix[y][m] = vals.length ? mean(vals) : null;
    }
  }

  const colStats = {};
  for (let m = 0; m < 12; m++) {
    const vals = years.map(y => matrix[y][m]).filter(v => v != null);
    colStats[m] = { min: Math.min(...vals), max: Math.max(...vals) };
  }

  let html = `<table class="heatmap-table"><thead><tr>
    <th>Year</th>${MONTH_NAMES.map(mn => `<th>${mn}</th>`).join('')}
  </tr></thead><tbody>`;

  for (const y of [...years].reverse()) {
    html += `<tr><td class="year-col">${y}</td>`;
    for (let m = 0; m < 12; m++) {
      const v = matrix[y][m];
      if (v == null) {
        html += `<td style="color:#484f58">‚Äî</td>`;
      } else {
        const { min, max } = colStats[m];
        const ratio = max > min ? (v - min) / (max - min) : 0.5;
        const bg = heatmapColorAbs(ratio);
        html += `<td style="background:${bg};color:#e6edf3">${fmt(v, 0)}</td>`;
      }
    }
    html += '</tr>';
  }
  html += '</tbody></table>';
  container.innerHTML = html;
}

function downloadMonthlyHeatmap(productKey) {
  const years = [...new Set(DATA.master.map(r => r.year))].sort((a, b) => b - a);
  const matrix = {};
  for (const y of years) {
    matrix[y] = {};
    for (let m = 0; m < 12; m++) {
      const vals = DATA.master.filter(r => r.year === y && r.month === m && r[productKey] != null).map(r => r[productKey]);
      matrix[y][m] = vals.length ? mean(vals) : null;
    }
  }
  const headers = ['Year', ...MONTH_NAMES];
  const rows = years.map(y => [y, ...Array.from({length:12},(_,m) => matrix[y][m] != null ? matrix[y][m].toFixed(2) : '')]);
  downloadCSV(`monthly_heatmap_${productKey}.csv`, headers, rows);
}

// =====================================================================
// QUARTERLY TAB
// =====================================================================
function renderQuarterlyTab(productKey) {
  renderWinRateCards(productKey);
  renderQuarterlyHeatmap(productKey);
  renderSpaghettiChart(productKey);
  renderQDAreaComp1(productKey);
  renderQDTrend(productKey);
  renderQDBarChart(productKey);
  renderQDAreaComp2(productKey);
  renderQDDataGrid(productKey);

  document.getElementById('quarterlyDlBtn').onclick = () => downloadQuarterlyHeatmapCSV(productKey);
  document.getElementById('quarterlyHeatmapDlBtn').onclick = () => downloadQuarterlyHeatmapCSV(productKey);
}

// ---- CHANGE 6: Win-Rate KPI Cards ----
function renderWinRateCards(productKey) {
  const quarters = ['Q1','Q2','Q3','Q4'];
  const years = [...new Set(DATA.master.map(r => r.year))].sort();

  // Build quarter avgs per year ‚Äî use cache
  const qAvg = {};
  for (const y of years) {
    qAvg[y] = {};
    for (const q of quarters) {
      qAvg[y][q] = getQAvgCached(productKey, y, q);
    }
  }

  const winRates = {};
  for (const q of quarters) {
    let wins = 0, total = 0;
    for (let i = 0; i < years.length; i++) {
      const y = years[i];
      const thisQAvg = qAvg[y][q];
      if (thisQAvg == null) continue;
      let prevAvg = null;
      if (q === 'Q1') {
        // Compare Q1 to prior year Q4
        const priorYear = y - 1;
        prevAvg = qAvg[priorYear] ? qAvg[priorYear]['Q4'] : null;
      } else {
        const prevQ = q === 'Q2' ? 'Q1' : q === 'Q3' ? 'Q2' : 'Q3';
        prevAvg = qAvg[y][prevQ];
      }
      if (prevAvg == null) continue;
      total++;
      if (thisQAvg > prevAvg) wins++;
    }
    winRates[q] = total > 0 ? (wins / total) * 100 : null;
  }

  const row = document.getElementById('winRateRow');
  row.innerHTML = '';
  for (const q of quarters) {
    const wr = winRates[q];
    let cls = 'wr-yellow', valColor = 'var(--yellow)';
    if (wr != null) {
      if (wr > 60)  { cls = 'wr-green';  valColor = 'var(--green)'; }
      else if (wr < 50) { cls = 'wr-red'; valColor = 'var(--red)'; }
    }
    const pct = wr != null ? wr.toFixed(0) + '%' : '‚Äî';
    const barW = wr != null ? wr : 0;
    const card = document.createElement('div');
    card.className = `win-rate-card ${cls}`;
    card.innerHTML = `
      <div class="win-rate-label">${q} Win Rate</div>
      <div class="win-rate-value" style="color:${valColor}">${pct}</div>
      <div class="win-rate-bar-wrap"><div class="win-rate-bar" style="width:${barW}%;background:${valColor}"></div></div>
    `;
    row.appendChild(card);
  }
}

// ---- Quarterly Heatmap with QoQ % divergent color ----
function renderQuarterlyHeatmap(productKey) {
  const container = document.getElementById('quarterlyHeatmap');
  const quarters = ['Q1','Q2','Q3','Q4'];
  const years = [...new Set(DATA.master.map(r => r.year))].sort();

  const matrix = {};
  for (const y of years) {
    matrix[y] = {};
    for (const q of quarters) {
      const vals = DATA.master.filter(r => r.year === y && r.quarter === q && r[productKey] != null).map(r => r[productKey]);
      matrix[y][q] = vals.length ? mean(vals) : null;
    }
  }

  const colStats = {};
  for (const q of quarters) {
    const vals = years.map(y => matrix[y][q]).filter(v => v != null);
    colStats[q] = { min: Math.min(...vals), max: Math.max(...vals) };
  }

  const viewMode = document.getElementById('heatmapViewSelect') ? document.getElementById('heatmapViewSelect').value : 'absolute';

  let html = `<table class="heatmap-table"><thead><tr>
    <th>Year</th>${quarters.map(q => `<th>${q}</th>`).join('')}
  </tr></thead><tbody>`;

  for (const y of [...years].reverse()) {
    html += `<tr><td class="year-col">${y}</td>`;
    for (const q of quarters) {
      const v = matrix[y][q];
      if (v == null) {
        html += `<td style="color:#484f58">‚Äî</td>`;
      } else {
        // QoQ %: compare to prior quarter
        let prevV = null;
        if (q === 'Q1') {
          prevV = matrix[y - 1] ? matrix[y - 1]['Q4'] : null;
        } else {
          const prevQ = q === 'Q2' ? 'Q1' : q === 'Q3' ? 'Q2' : 'Q3';
          prevV = matrix[y][prevQ];
        }
        let pctStr = '';
        let bg;
        if (currentHeatmapView === 'pct' && prevV != null && prevV !== 0) {
          const pct = ((v - prevV) / prevV) * 100;
          pctStr = (pct >= 0 ? '+' : '') + pct.toFixed(1) + '%';
          bg = heatmapColorPct(pct);
        } else {
          const { min, max } = colStats[q];
          const ratio = max > min ? (v - min) / (max - min) : 0.5;
          bg = heatmapColorAbs(ratio);
        }
        const cellContent = (currentHeatmapView === 'pct' && pctStr)
          ? `<span class="heatmap-abs-val">${fmt(v, 0)}</span><span class="heatmap-pct-val">${pctStr}</span>`
          : fmt(v, 0);
        html += `<td style="background:${bg};color:#e6edf3">${cellContent}</td>`;
      }
    }
    html += '</tr>';
  }
  html += '</tbody></table>';
  container.innerHTML = html;
}

function downloadQuarterlyHeatmapCSV(productKey) {
  const quarters = ['Q1','Q2','Q3','Q4'];
  const years = [...new Set(DATA.master.map(r => r.year))].sort((a, b) => b - a);
  const matrix = {};
  for (const y of years) {
    matrix[y] = {};
    for (const q of quarters) {
      const vals = DATA.master.filter(r => r.year === y && r.quarter === q && r[productKey] != null).map(r => r[productKey]);
      matrix[y][q] = vals.length ? mean(vals) : null;
    }
  }
  const headers = ['Year', ...quarters];
  const rows = years.map(y => [y, ...quarters.map(q => matrix[y][q] != null ? matrix[y][q].toFixed(2) : '')]);
  downloadCSV(`quarterly_heatmap_${productKey}.csv`, headers, rows);
}

// ---- CHANGE 6: Spaghetti Chart ----
function renderSpaghettiChart(productKey) {
  const quarters = ['Q1','Q2','Q3','Q4'];
  const qColors  = { Q1: '#58a6ff', Q2: '#3fb950', Q3: '#f0883e', Q4: '#a371f7' };
  const years = [...new Set(DATA.master.map(r => r.year))].sort((a, b) => a - b);

  // Build qAvg per year per quarter
  const qData = { Q1: [], Q2: [], Q3: [], Q4: [] };
  const xLabels = years.map(String);

  for (const q of quarters) {
    for (const y of years) {
      qData[q].push(getQAvgCached(productKey, y, q));
    }
  }

  const datasets = quarters.map(q => ({
    label: q,
    data: qData[q],
    borderColor: qColors[q],
    backgroundColor: 'transparent',
    borderWidth: 2,
    pointRadius: 3,
    tension: 0.2,
    spanGaps: true,
  }));

  destroyChart('spaghettiChart');
  const canvas = document.getElementById('spaghettiChart');
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  chartRegistry['spaghettiChart'] = new Chart(ctx, {
    type: 'line',
    data: { labels: xLabels, datasets },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: { mode: 'index', intersect: false },
      plugins: {
        legend: { position: 'top', labels: { usePointStyle: true } },
        tooltip: {
          callbacks: {
            title: ctx => `Year ${ctx[0].label}`,
            label: ctx => ` ${ctx.dataset.label}: ${fmt(ctx.parsed.y)}`,
          },
        },
      },
      scales: {
        x: {
          grid: { color: '#151a22' },
          ticks: { font: { size: 11 }, maxTicksLimit: 16 },
          title: { display: true, text: 'Year', color: '#8b949e', font: { size: 11 } },
        },
        y: {
          grid: { color: '#151a22' },
          ticks: { font: { size: 11 }, callback: v => fmt(v) },
          title: { display: true, text: PRODUCTS[productKey].label, color: '#8b949e', font: { size: 11 } },
        },
      },
    },
  });
}

// =====================================================================
// INDICES TAB (CHANGE 7)
// =====================================================================
function renderIndicesTab() {
  const grid = document.getElementById('indicesGrid');
  grid.innerHTML = '';

  PRODUCT_KEYS.forEach(key => {
    const prod = PRODUCTS[key];
    const rows = DATA.raw[key];
    if (!rows || !rows.length) return;

    const latest = rows[rows.length - 1];
    const prev   = rows[rows.length - 2];
    const chg    = prev ? ((latest.value - prev.value) / prev.value * 100) : null;
    const chgStr = chg != null ? `${chg >= 0 ? '+' : ''}${chg.toFixed(2)}%` : '‚Äî';
    const chgCls = chg == null ? '' : (chg >= 0 ? 'change-pos' : 'change-neg');

    // Stats strip values
    const allVals = rows.map(r => r.value);
    const ath = Math.max(...allVals);
    const atl = Math.min(...allVals);
    const vsAth = ((latest.value - ath) / ath * 100).toFixed(1) + '%';

    // YTD %: compare to last value of prior year
    const currentYear = latest.date.getFullYear();
    const jan1 = new Date(currentYear, 0, 1);
    const priorYearRows = rows.filter(r => r.date < jan1);
    const ytdBase = priorYearRows.length ? priorYearRows[priorYearRows.length - 1].value : null;
    let ytdStr = '‚Äî', ytdCls = '';
    if (ytdBase) {
      const ytd = ((latest.value - ytdBase) / ytdBase * 100);
      ytdStr = (ytd >= 0 ? '+' : '') + ytd.toFixed(1) + '%';
      ytdCls = ytd >= 0 ? 'val-green' : 'val-red';
    }
    const vsCls = parseFloat(vsAth) >= 0 ? 'val-green' : (parseFloat(vsAth) < -30 ? 'val-red' : 'val-yellow');

    const cardId  = `idxCard_${key}`;
    const canvasId = `idxChart_${key}`;

    const card = document.createElement('div');
    card.className = 'index-chart-card';
    card.id = cardId;

    // Compute total rows and default 5Y range
    const totalRows = DATA.raw[key].length;
    const cutoff5y = new Date(); cutoff5y.setFullYear(cutoff5y.getFullYear() - 5);
    const defaultStartIdx = DATA.raw[key].findIndex(r => r.date >= cutoff5y);
    const startIdx5y = defaultStartIdx < 0 ? 0 : defaultStartIdx;

    card.innerHTML = `
      <div class="card-header-bar">${prod.label}</div>
      <div class="index-chart-header">
        <div class="index-chart-subtitle">
          <span>${fmt(latest.value)}</span>
          <span class="${chgCls}">${chgStr}</span>
        </div>
      </div>
      <div class="index-chart-canvas-wrap">
        <canvas id="${canvasId}"></canvas>
      </div>
      <div class="index-range-wrap">
        <div class="index-range-label">
          <span>Range:</span>
          <span id="rangeLabel_${key}">Loading‚Ä¶</span>
        </div>
        <div class="dual-range-track" id="rangeTrack_${key}">
          <div class="dual-range-fill" id="rangeFill_${key}"></div>
          <input type="range" id="rangeStart_${key}" min="0" max="${totalRows - 1}" value="${startIdx5y}" step="1">
          <input type="range" id="rangeEnd_${key}"   min="0" max="${totalRows - 1}" value="${totalRows - 1}" step="1">
        </div>
      </div>
      <div class="index-stats-strip">
        <div class="index-stat-mini">
          <div class="index-stat-mini-label">All-Time High</div>
          <div class="index-stat-mini-val val-white">${fmt(ath)}</div>
        </div>
        <div class="index-stat-mini">
          <div class="index-stat-mini-label">All-Time Low</div>
          <div class="index-stat-mini-val val-white">${fmt(atl)}</div>
        </div>
        <div class="index-stat-mini">
          <div class="index-stat-mini-label">Current vs ATH</div>
          <div class="index-stat-mini-val ${vsCls}">${vsAth}</div>
        </div>
        <div class="index-stat-mini">
          <div class="index-stat-mini-label">YTD %</div>
          <div class="index-stat-mini-val ${ytdCls}">${ytdStr}</div>
        </div>
      </div>`;
    grid.appendChild(card);

    // Wire up dual range slider
    initIndexRangeSlider(key, totalRows);
    buildIndexChartByRange(key, startIdx5y, totalRows - 1);
  });
}

function initIndexRangeSlider(key, totalRows) {
  const startEl = document.getElementById('rangeStart_' + key);
  const endEl   = document.getElementById('rangeEnd_'   + key);
  const fillEl  = document.getElementById('rangeFill_'  + key);
  const labelEl = document.getElementById('rangeLabel_' + key);
  if (!startEl || !endEl) return;

  function updateSlider() {
    let s = parseInt(startEl.value);
    let e = parseInt(endEl.value);
    if (s > e) {
      // Swap if crossed
      if (this === startEl) { startEl.value = e; s = e; }
      else { endEl.value = s; e = s; }
    }
    // Update fill bar
    const pctStart = (s / (totalRows - 1)) * 100;
    const pctEnd   = (e / (totalRows - 1)) * 100;
    fillEl.style.left  = pctStart + '%';
    fillEl.style.width = (pctEnd - pctStart) + '%';
    // Update label
    const rows = DATA.raw[key];
    const startDate = rows[s] ? rows[s].date.toISOString().split('T')[0].slice(0,7) : '';
    const endDate   = rows[e] ? rows[e].date.toISOString().split('T')[0].slice(0,7) : '';
    labelEl.textContent = startDate + ' ‚Üí ' + endDate;
    // Rebuild chart
    buildIndexChartByRange(key, s, e);
  }

  startEl.addEventListener('input', updateSlider);
  endEl.addEventListener('input', updateSlider);
  // Trigger initial render
  updateSlider.call(startEl);
}

function buildIndexChartByRange(key, startIdx, endIdx) {
  const prod = PRODUCTS[key];
  const allRows = DATA.raw[key];
  if (!allRows || !allRows.length) return;

  const rows = allRows.slice(startIdx, endIdx + 1);
  const labels = rows.map(r => r.date.toISOString().split('T')[0]);
  const values = rows.map(r => r.value);

  destroyChart('idxChart_' + key);
  const canvas = document.getElementById('idxChart_' + key);
  if (!canvas) return;
  const ctx = canvas.getContext('2d');

  chartRegistry['idxChart_' + key] = new Chart(ctx, {
    type: 'line',
    data: {
      labels,
      datasets: [{
        label: prod.label,
        data: values,
        borderColor: prod.color,
        backgroundColor: prod.color + '18',
        borderWidth: 1.5,
        pointRadius: 0,
        fill: true,
        tension: 0.1,
      }],
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            label: ctx => ` ${fmt(ctx.parsed.y)}`,
            title: ctx => ctx[0].label,
          },
        },
      },
      scales: {
        x: {
          grid: { color: '#151a22' },
          ticks: {
            maxTicksLimit: 8,
            font: { size: 10 },
            callback: function(val, idx) {
              return labels[idx] ? labels[idx].slice(0, 7) : '';
            },
          },
        },
        y: {
          grid: { color: '#151a22' },
          ticks: { font: { size: 10 }, callback: v => fmt(v) },
        },
      },
    },
  });
}

// =====================================================================
// ETF TAB (CHANGE 8)
// =====================================================================
async function renderETFTab() {
  const grid = document.getElementById('etfGrid');
  if (grid.dataset.rendered) return;
  grid.dataset.rendered = '1';
  grid.innerHTML = '';

  await Promise.all([
    renderETFCard('BDRY', 'Breakwave Dry Bulk Shipping ETF', DATA.bdryHoldings, 'bdry', grid),
    renderETFCard('BWET', 'Breakwave Tanker Shipping ETF',   DATA.bwetHoldings, 'bwet', grid),
  ]);
}

function classifyHolding(name, ticker, etf) {
  const n = (name || '').toLowerCase();
  const t = (ticker || '').toLowerCase();
  if (etf === 'bdry') {
    if (n.includes('capesize') || t.includes('c5tcm')) return 'cape';
    if (n.includes('panamax')  || t.includes('p5tcm')) return 'pana';
    if (n.includes('supramax') || t.includes('s58fm')) return 'supra';
    return 'cash';
  } else {
    if (n.includes('td3c') || t.includes('dd3cm')) return 'td3c';
    if (n.includes('td20') || t.includes('dd20m')) return 'td20';
    return 'cash';
  }
}

function shortenName(name) {
  return name
    .replace(/Capesize 5TC FFA 180kt Timecharter Average /i, 'Cape 5TC ')
    .replace(/Panamax 5TC FFA 82kt Timecharter Average /i, 'Panamax 5TC ')
    .replace(/Supramax 58 TC FFA 58kt Timecharter Average /i, 'Supra 58 ')
    .replace(/TD20 FFA 130kt West Africa to Continent USD\/MT /i, 'TD20 ')
    .replace(/TD3C FFA 270kt Middle East Gulf to China USD\/MT /i, 'TD3C ')
    .replace(/Invesco Government & Agency Portfolio .*/i, 'Invesco Govt Portfolio')
    .replace(/M (Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec) (\d+)/, '$1 $2');
}

async function renderETFCard(ticker, name, holdings, etfKey, grid) {
  const card = document.createElement('div');
  card.className = 'etf-card';
  card.id = `etfCard_${etfKey}`;
  grid.appendChild(card);

  let priceHTML = '<span style="color:var(--text-muted)">Fetching‚Ä¶</span>';
  card.innerHTML = buildETFCardHTML(ticker, name, holdings, etfKey, priceHTML);
  buildETFDonut(etfKey, holdings);

  // Wire CSV download buttons (CHANGE 8)
  const dlBtn = card.querySelector(`.etf-dl-btn`);
  if (dlBtn) {
    dlBtn.addEventListener('click', () => downloadETFHoldings(ticker, etfKey, holdings));
  }

  try {
    const yahooUrl = `https://query1.finance.yahoo.com/v8/finance/chart/${ticker}?interval=1d&range=1d`;
    const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(yahooUrl)}`;
    const resp = await fetch(proxyUrl, { signal: AbortSignal.timeout(10000) });
    const json = await resp.json();
    const data = JSON.parse(json.contents);
    const meta = data.chart.result[0].meta;
    const price = meta.regularMarketPrice;
    const chgPct = meta.regularMarketChangePercent;
    const sign = chgPct >= 0 ? '+' : '';
    const chgCls = chgPct >= 0 ? 'change-pos' : 'change-neg';
    priceHTML = `
      <span class="etf-price">${price != null ? '$' + price.toFixed(2) : '‚Äî'}</span>
      <span class="etf-change ${chgCls}">${chgPct != null ? sign + chgPct.toFixed(2) + '%' : ''}</span>`;
  } catch (e) {
    priceHTML = '<span style="color:var(--text-muted);font-size:13px">Price unavailable</span>';
  }

  const priceEl = card.querySelector('.etf-price-row');
  if (priceEl) priceEl.innerHTML = priceHTML;
}

function downloadETFHoldings(ticker, etfKey, holdings) {
  const sorted = sortHoldings([...holdings], etfKey);
  const headers = ['Name','Ticker','Lots','Price','Market Value','Weighting'];
  const rows = sorted.map(h => [
    h.Name || '',
    h.Ticker || '',
    h.Lots || '',
    h.Price || '',
    h.Market_Value || '',
    h.Weightings || '',
  ]);
  const filename = ticker === 'BDRY' ? 'bdry_holdings_export.csv' : 'bwet_holdings_export.csv';
  downloadCSV(filename, headers, rows);
}

function buildETFCardHTML(ticker, name, holdings, etfKey, priceHTML) {
  const sorted = sortHoldings([...holdings], etfKey);

  let tableRows = '';
  for (const h of sorted) {
    const cls = classifyHolding(h.Name, h.Ticker, etfKey);
    const rowCls = `row-${cls}`;
    const shortName = shortenName(h.Name || '');
    const lots = parseFloat(h.Lots) || 0;
    const price = parseFloat(h.Price) || 0;
    const mv = parseFloat(h.Market_Value) || 0;
    const wt = h.Weightings || '‚Äî';
    tableRows += `<tr>
      <td class="${rowCls}">${shortName}</td>
      <td>${lots % 1 === 0 ? fmt(lots) : lots.toLocaleString()}</td>
      <td>${price < 200 ? price.toFixed(3) : fmt(price)}</td>
      <td>$${(mv / 1e6).toFixed(2)}M</td>
      <td>${wt}</td>
    </tr>`;
  }

  const futuresRows = holdings.filter(h => classifyHolding(h.Name, h.Ticker, etfKey) !== 'cash');
  const cashRows    = holdings.filter(h => classifyHolding(h.Name, h.Ticker, etfKey) === 'cash');
  const totalFutures = futuresRows.reduce((s, h) => s + (parseFloat(h.Market_Value) || 0), 0);
  const totalCash    = cashRows.reduce((s, h) => s + (parseFloat(h.Market_Value) || 0), 0);
  const totalAUM     = totalFutures + totalCash;

  return `
    <div class="etf-header">
      <div class="etf-ticker">${ticker}</div>
      <div class="etf-name">${name}</div>
      <div class="etf-price-row">${priceHTML}</div>
    </div>

    <div class="etf-section-title-row">
      <div class="etf-section-title">Holdings</div>
      <button class="dl-btn etf-dl-btn">‚¨á CSV</button>
    </div>
    <table class="holdings-table">
      <thead><tr>
        <th>Name</th>
        <th>Lots</th>
        <th>Price</th>
        <th>Mkt Value</th>
        <th>Weight</th>
      </tr></thead>
      <tbody>${tableRows}</tbody>
    </table>

    <div class="etf-section-title" style="margin:16px 0 8px">Futures Allocation (excl. collateral cash)</div>
    <div class="donut-wrap">
      <canvas id="donut_${etfKey}"></canvas>
    </div>

    <div class="etf-metrics">
      <div class="etf-metric">
        <div class="etf-metric-label">Total Futures</div>
        <div class="etf-metric-value">$${(totalFutures / 1e6).toFixed(1)}M</div>
      </div>
      <div class="etf-metric">
        <div class="etf-metric-label">Collateral Cash</div>
        <div class="etf-metric-value" style="color:var(--text-muted)">${(totalCash / 1e6).toFixed(1)}M</div>
      </div>
      <div class="etf-metric">
        <div class="etf-metric-label">Futures / AUM</div>
        <div class="etf-metric-value" style="color:var(--green)">${(totalFutures / totalAUM * 100).toFixed(1)}%</div>
      </div>
    </div>`;
}

function sortHoldings(holdings, etfKey) {
  const order = etfKey === 'bdry'
    ? ['cape', 'pana', 'supra', 'cash']
    : ['td3c', 'td20', 'cash'];
  holdings.sort((a, b) => {
    const ca = classifyHolding(a.Name, a.Ticker, etfKey);
    const cb = classifyHolding(b.Name, b.Ticker, etfKey);
    const ia = order.indexOf(ca); const ib = order.indexOf(cb);
    if (ia !== ib) return ia - ib;
    return (a.Name || '').localeCompare(b.Name || '');
  });
  return holdings;
}

function buildETFDonut(etfKey, holdings) {
  const groups = {};
  for (const h of holdings) {
    const cls = classifyHolding(h.Name, h.Ticker, etfKey);
    groups[cls] = (groups[cls] || 0) + (parseFloat(h.Market_Value) || 0);
  }

  // Cash is structural margin collateral (pledged for futures per SEC filings) ‚Äî excluded.
  // Chart shows only futures notional, normalised to 100%.
  let labels, values, colors;
  if (etfKey === 'bdry') {
    labels = ['Capesize', 'Panamax', 'Supramax'];
    values = [groups.cape||0, groups.pana||0, groups.supra||0];
    colors = ['#58a6ff', '#3fb950', '#d29922'];
  } else {
    labels = ['MEG-China (TD3C)', 'WAF-Continent (TD20)'];
    values = [groups.td3c||0, groups.td20||0];
    colors = ['#f0883e', '#a371f7'];
  }

  // Normalise to 100% of futures notional
  const totalFuturesNotional = values.reduce((s, v) => s + v, 0);
  values = totalFuturesNotional > 0 ? values.map(v => (v / totalFuturesNotional) * 100) : values;

  setTimeout(() => {
    const canvas = document.getElementById(`donut_${etfKey}`);
    if (!canvas) return;
    destroyChart(`donut_${etfKey}`);
    const ctx = canvas.getContext('2d');
    chartRegistry[`donut_${etfKey}`] = new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels,
        datasets: [{
          data: values,
          backgroundColor: colors,
          borderColor: '#0f1318',
          borderWidth: 2,
        }],
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: 'right',
            labels: { font: { size: 11 }, padding: 8, usePointStyle: true },
          },
          tooltip: {
            callbacks: {
              label: ctx => ` ${ctx.label}: ${ctx.parsed.toFixed(1)}% of futures`,
            },
          },
        },
      },
    });
  }, 50);
}

// =====================================================================
// FEATURE B ‚Äî Recent Daily Changes Table
// =====================================================================
let _recentChangesKey = null;
let _recentChangesRows = null;

function renderRecentChanges(productKey) {
  _recentChangesKey = productKey;
  const allRows = DATA.master.filter(r => r[productKey] != null);
  const totalLen = allRows.length;
  const startIdx = Math.max(0, totalLen - 10);
  const displayRows = allRows.slice(startIdx);
  _recentChangesRows = displayRows;

  let html = `<table class="yearly-table">
    <thead><tr>
      <th style="text-align:left">Date</th>
      <th>Index Value</th>
      <th>Day Œî</th>
      <th>Day Œî%</th>
      <th>5D Chg%</th>
    </tr></thead><tbody>`;

  for (let i = 0; i < displayRows.length; i++) {
    const row = displayRows[i];
    const allIdx = startIdx + i;
    const prevRow = allIdx > 0 ? allRows[allIdx - 1] : null;
    const dayDelta   = prevRow ? (row[productKey] - prevRow[productKey]) : null;
    const dayDeltaPct = prevRow && prevRow[productKey] ? ((row[productKey] - prevRow[productKey]) / prevRow[productKey] * 100) : null;

    const row5back = allIdx >= 5 ? allRows[allIdx - 5] : null;
    const chg5d = row5back && row5back[productKey] ? ((row[productKey] - row5back[productKey]) / row5back[productKey] * 100) : null;

    const dateStr = row.date.toISOString().split('T')[0];

    const ddStr   = dayDelta    != null ? (dayDelta    >= 0 ? '+' : '') + dayDelta.toFixed(0)      : '‚Äî';
    const ddPStr  = dayDeltaPct != null ? (dayDeltaPct >= 0 ? '+' : '') + dayDeltaPct.toFixed(2) + '%' : '‚Äî';
    const c5dStr  = chg5d       != null ? (chg5d       >= 0 ? '+' : '') + chg5d.toFixed(2)       + '%' : '‚Äî';

    const ddCls   = dayDelta    == null ? '' : (dayDelta    >= 0 ? 'val-green' : 'val-red');
    const ddPCls  = dayDeltaPct == null ? '' : (dayDeltaPct >= 0 ? 'val-green' : 'val-red');
    const c5dCls  = chg5d       == null ? '' : (chg5d       >= 0 ? 'val-green' : 'val-red');

    html += `<tr>
      <td style="text-align:left;color:var(--text-muted);font-weight:600">${dateStr}</td>
      <td>${fmt(row[productKey], 0)}</td>
      <td class="${ddCls}">${ddStr}</td>
      <td class="${ddPCls}">${ddPStr}</td>
      <td class="${c5dCls}">${c5dStr}</td>
    </tr>`;
  }

  html += '</tbody></table>';
  const container = document.getElementById('recentChangesTable');
  if (container) container.innerHTML = html;

  // Wire download button
  const dlBtn = document.getElementById('recentDlBtn');
  if (dlBtn) dlBtn.onclick = () => downloadRecentChanges(productKey);
}

function downloadRecentChanges(productKey) {
  if (!_recentChangesRows) return;
  const allRows = getRows(productKey);
  const totalLen = allRows.length;
  const startIdx = Math.max(0, totalLen - 10);
  const headers = ['Date','Value','Day Change','Day Change %','5D Change %'];
  const rows = _recentChangesRows.map((row, i) => {
    const allIdx = startIdx + i;
    const prevRow = allIdx > 0 ? allRows[allIdx - 1] : null;
    const row5back = allIdx >= 5 ? allRows[allIdx - 5] : null;
    const dayDelta    = prevRow ? (row[productKey] - prevRow[productKey]) : null;
    const dayDeltaPct = prevRow && prevRow[productKey] ? ((row[productKey] - prevRow[productKey]) / prevRow[productKey] * 100) : null;
    const chg5d       = row5back && row5back[productKey] ? ((row[productKey] - row5back[productKey]) / row5back[productKey] * 100) : null;
    return [
      row.date.toISOString().split('T')[0],
      row[productKey] != null ? row[productKey].toFixed(2) : '',
      dayDelta    != null ? dayDelta.toFixed(2) : '',
      dayDeltaPct != null ? dayDeltaPct.toFixed(2) + '%' : '',
      chg5d       != null ? chg5d.toFixed(2) + '%' : '',
    ];
  });
  downloadCSV(`recent_changes_${productKey}.csv`, headers, rows);
}

function toggleMethodology() {
  const btn     = document.getElementById('methodologyToggle');
  const content = document.getElementById('methodologyContent');
  btn.classList.toggle('open');
  content.classList.toggle('open');
}

// =====================================================================
// TAB NAVIGATION
// =====================================================================
let currentTab = 'dashboard';
let currentProduct = 'bdiy';
let indicesRendered = false;

function switchTab(tabId) {
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.toggle('active', b.dataset.tab === tabId));
  document.querySelectorAll('.tab-panel').forEach(p => p.classList.toggle('active', p.id === `tab-${tabId}`));
  currentTab = tabId;

  if (!DATA.loaded) return;

  if (tabId === 'dashboard') renderDashboard(currentProduct);
  if (tabId === 'heatmaps')  renderHeatmaps(currentProduct);
  if (tabId === 'quarterly') renderQuarterlyTab(currentProduct);
  if (tabId === 'indices' && !indicesRendered) { renderIndicesTab(); indicesRendered = true; }
  if (tabId === 'etfs')     renderETFTab();
  if (tabId === 'yearly-dash')    renderYearlyDash(currentProduct);
  if (tabId === 'monthly-dash')   renderMonthlyDash(currentProduct);
}

document.querySelectorAll('.tab-btn').forEach(btn => {
  btn.addEventListener('click', () => switchTab(btn.dataset.tab));
});

document.getElementById('globalProduct').addEventListener('change', function() {
  currentProduct = this.value;
  if (!DATA.loaded) return;
  if (currentTab === 'dashboard') renderDashboard(currentProduct);
  if (currentTab === 'heatmaps')  renderHeatmaps(currentProduct);
  if (currentTab === 'quarterly') renderQuarterlyTab(currentProduct);
  if (currentTab === 'yearly-dash')    renderYearlyDash(currentProduct);
  if (currentTab === 'monthly-dash')   renderMonthlyDash(currentProduct);
});

// =====================================================================
// BOOTSTRAP
// =====================================================================
(async function init() {
  try {
    await loadAllData();
    renderDashboard(currentProduct);
  } catch (err) {
    document.getElementById('loadingOverlay').classList.add('hidden');
    document.getElementById('tab-dashboard').innerHTML =
      `<div class="error-msg">‚ùå Failed to load data: ${err.message}. Make sure CSV files are accessible.</div>`;
    console.error(err);
  }
})();

// =====================================================================
// YEARLY DASHBOARD TAB
// =====================================================================
function renderYearlyDash(productKey) {
  var fns = [
    function(){ renderYDKpi(productKey); },
    function(){ renderYDHistArea(productKey, 5,  'yearlyHist5yChart',  'yd5yDlBtn'); },
    function(){ renderYDHistArea(productKey, 10, 'yearlyHist10yChart', 'yd10yDlBtn'); },
    function(){ renderYDHistArea(productKey, 0,  'yearlyAlltimeChart', 'ydAllDlBtn'); },
    function(){ renderYDZscore(productKey, false, 'yearlyZscoreChart'); },
    function(){ renderYDZscore(productKey, true,  'yearlyHistZscoreChart'); },
    function(){ renderYDMultiRates('yearlyMultiRatesChart'); },
    function(){ renderYDShippingRates(productKey, 'yearlyShippingRatesChart'); },
    function(){ renderYDRatesOverlay('yearlyRatesChart'); },
    function(){ renderYDDrawdown(productKey, 'yearlyDrawdownChart'); },
  ];
  fns.forEach(function(fn){
    try { fn(); } catch(e) { console.error('[YearlyDash]', e); }
  });
}

function renderYDKpi(productKey) {
  var stats = getStats(productKey);
  var sig   = tradingSignal(stats);
  var prod  = PRODUCTS[productKey];
  var el    = document.getElementById('yd-kpi-row');
  if (!el) return;
  el.innerHTML =
    '<div class="current-price-block">' +
      '<div class="current-price-label">' + prod.label + '</div>' +
      '<div class="current-price-value" style="font-size:36px">' + (stats ? fmt(stats.currentPrice) : '&mdash;') + '</div>' +
      (stats && stats.pctChange != null
        ? '<div class="current-price-change ' + (stats.pctChange >= 0 ? 'change-pos' : 'change-neg') + '">' +
          (stats.pctChange >= 0 ? '+' : '') + stats.pctChange.toFixed(2) + '% vs prior day</div>'
        : '') +
    '</div>' +
    '<div class="signal-badge ' + sig.cls + '">' + sig.text + '</div>' +
    (stats ? (
      '<div class="stat-card sc-percentile" style="min-width:110px">' +
        '<div class="stat-label">5Y Pctl</div>' +
        '<div class="stat-value ' + pctColor(stats.pctl5y) + '">' + (stats.pctl5y * 100).toFixed(1) + '%</div>' +
      '</div>' +
      '<div class="stat-card sc-zscore" style="min-width:110px">' +
        '<div class="stat-label">Z-Score</div>' +
        '<div class="stat-value ' + (stats.zScore < -1 ? 'val-red' : stats.zScore > 1 ? 'val-green' : 'val-yellow') + '">' + stats.zScore.toFixed(2) + '</div>' +
      '</div>' +
      '<div class="stat-card sc-drawdown" style="min-width:110px">' +
        '<div class="stat-label">Drawdown</div>' +
        '<div class="stat-value ' + (stats.drawdown < -0.3 ? 'val-red' : stats.drawdown < -0.1 ? 'val-yellow' : 'val-green') + '">' + (stats.drawdown * 100).toFixed(1) + '%</div>' +
      '</div>'
    ) : '');
}

function renderYDHistArea(productKey, years, canvasId, dlBtnId) {
  var allRows = getRows(productKey);
  var rows;
  if (years > 0) {
    var cutoff = new Date(); cutoff.setFullYear(cutoff.getFullYear() - years);
    rows = allRows.filter(function(r) { return r.date >= cutoff; });
  } else {
    var c2008 = new Date('2008-01-01');
    rows = allRows.filter(function(r) { return r.date >= c2008; });
  }
  if (!rows.length) return;
  var labels = rows.map(function(r) { return r.date.toISOString().split('T')[0]; });
  var values = rows.map(function(r) { return r[productKey]; });
  var windowSize = years > 0 ? years * 252 : rows.length;
  var rollingAvg = values.map(function(_, i) {
    var start = Math.max(0, i - windowSize + 1);
    var slice = values.slice(start, i + 1).filter(function(v) { return v != null; });
    return slice.length ? slice.reduce(function(a, b) { return a + b; }, 0) / slice.length : null;
  });
  var prod = PRODUCTS[productKey];
  destroyChart(canvasId);
  var canvas = document.getElementById(canvasId);
  if (!canvas) return;
  chartRegistry[canvasId] = new Chart(canvas.getContext('2d'), {
    type: 'line',
    data: { labels: labels, datasets: [
      { label: prod.label, data: values, borderColor: prod.color, backgroundColor: prod.color + '33', borderWidth: 1.5, pointRadius: 0, fill: true, tension: 0.1 },
      { label: (years > 0 ? years + 'Y' : 'All-Time') + ' Avg', data: rollingAvg, borderColor: '#e3b341', backgroundColor: 'transparent', borderWidth: 1.5, borderDash: [5,3], pointRadius: 0, fill: false, tension: 0.1 },
    ]},
    options: {
      responsive: true, maintainAspectRatio: false,
      interaction: { mode: 'index', intersect: false },
      plugins: { legend: { position: 'top', labels: { usePointStyle: true } }, tooltip: { callbacks: { label: function(c) { return ' ' + c.dataset.label + ': ' + fmt(c.parsed.y); } } } },
      scales: {
        x: { grid: { color: '#151a22' }, ticks: { maxTicksLimit: 10, font: { size: 11 }, callback: function(_, i) { return labels[i] ? labels[i].slice(0,7) : ''; } } },
        y: { grid: { color: '#151a22' }, ticks: { font: { size: 11 }, callback: function(v) { return fmt(v); } } },
      },
    },
  });
  var btn = document.getElementById(dlBtnId);
  if (btn) btn.onclick = function() {
    downloadCSV('hist_' + (years||'all') + '_' + productKey + '.csv', ['Date', prod.label, 'Rolling Avg'],
      rows.map(function(r, i) { return [labels[i], values[i]!=null?values[i].toFixed(2):'', rollingAvg[i]!=null?rollingAvg[i].toFixed(2):'']; }));
  };
}

function computeRollingZscoreArr(values, windowSize) {
  return values.map(function(v, i) {
    if (v == null) return null;
    var start = Math.max(0, i - windowSize + 1);
    var slice = values.slice(start, i+1).filter(function(x) { return x != null; });
    if (slice.length < 20) return null;
    var m = slice.reduce(function(a,b){return a+b;},0) / slice.length;
    var sd = Math.sqrt(slice.reduce(function(a,b){return a+(b-m)*(b-m);},0) / slice.length);
    return sd > 0 ? (v - m) / sd : 0;
  });
}

function renderYDZscore(productKey, allTime, canvasId) {
  var cutoff3y = new Date(); cutoff3y.setFullYear(cutoff3y.getFullYear() - 3);
  var cutoff2008 = new Date('2008-01-01');

  // Build a shared label array from the selected product's rows (for x-axis alignment)
  var refKey = productKey;
  var allRefRows = DATA.master.filter(function(r){ return r[refKey] != null && r.date >= cutoff2008; });
  var refRows = allTime ? allRefRows : allRefRows.filter(function(r){ return r.date >= cutoff3y; });
  var sharedLabels = refRows.map(function(r){ return r.date.toISOString().split('T')[0]; });

  var datasets = PRODUCT_KEYS.map(function(key) {
    var allRows = DATA.master.filter(function(r) { return r[key] != null && r.date >= cutoff2008; });
    var zAll = computeRollingZscoreArr(allRows.map(function(r){return r[key];}), 252);
    var rows, zScores;
    if (allTime) { rows = allRows; zScores = zAll; }
    else {
      var startIdx = 0;
      for (var ii=0; ii<allRows.length; ii++) { if (allRows[ii].date >= cutoff3y) { startIdx=ii; break; } }
      rows = allRows.slice(startIdx); zScores = zAll.slice(startIdx);
    }
    // Map z-scores by date string for alignment with sharedLabels
    var zByDate = {};
    rows.forEach(function(r,i){ zByDate[r.date.toISOString().split('T')[0]] = zScores[i]; });
    var aligned = sharedLabels.map(function(lbl){ var v = zByDate[lbl]; return (v != null) ? v : null; });
    return {
      label: PRODUCTS[key].label,
      data: aligned,
      borderColor: PRODUCTS[key].color, backgroundColor:'transparent',
      borderWidth: key===productKey?2.5:1, pointRadius:0, tension:0.1, spanGaps:true
    };
  });

  destroyChart(canvasId);
  var canvas = document.getElementById(canvasId); if (!canvas) return;
  chartRegistry[canvasId] = new Chart(canvas.getContext('2d'), {
    type: 'line',
    data: { labels: sharedLabels, datasets: datasets },
    options: {
      responsive:true, maintainAspectRatio:false,
      interaction:{mode:'index',intersect:false},
      plugins:{
        legend:{position:'top',labels:{usePointStyle:true,font:{size:10}}},
        tooltip:{callbacks:{
          title: function(c){ return c[0].label; },
          label: function(c){ return ' '+c.dataset.label+': '+(c.parsed.y!=null?c.parsed.y.toFixed(2):'‚Äî'); }
        }}
      },
      scales:{
        x:{
          type:'category',
          grid:{color:'#151a22'},
          ticks:{font:{size:11}, maxTicksLimit:12, callback: function(val, idx){
            return sharedLabels[idx] ? sharedLabels[idx].slice(0,7) : '';
          }}
        },
        y:{
          grid:{color:'#151a22'},
          ticks:{font:{size:11},callback:function(v){return v.toFixed(1);}},
          title:{display:true,text:'Z-Score',color:'#8b949e',font:{size:11}}
        },
      },
    },
  });
}

function renderYDMultiRates(canvasId) {
  var seen={}, years=[];
  DATA.master.forEach(function(r){if(!seen[r.year]){seen[r.year]=1;years.push(r.year);}});
  years.sort(function(a,b){return a-b;});
  var datasets = PRODUCT_KEYS.map(function(key) {
    return { label:PRODUCTS[key].label,
      data: years.map(function(y){var v=DATA.master.filter(function(r){return r.year===y&&r[key]!=null;}).map(function(r){return r[key];});return v.length?mean(v):null;}),
      borderColor:PRODUCTS[key].color, backgroundColor:'transparent', borderWidth:2, pointRadius:3, tension:0.2, spanGaps:true };
  });
  destroyChart(canvasId);
  var canvas=document.getElementById(canvasId); if(!canvas)return;
  chartRegistry[canvasId]=new Chart(canvas.getContext('2d'),{
    type:'line', data:{labels:years.map(String),datasets:datasets},
    options:{responsive:true,maintainAspectRatio:false,interaction:{mode:'index',intersect:false},
      plugins:{legend:{position:'top',labels:{usePointStyle:true,font:{size:10}}},tooltip:{callbacks:{label:function(c){return ' '+c.dataset.label+': '+fmt(c.parsed.y);}}}},
      scales:{x:{grid:{color:'#151a22'},ticks:{font:{size:11}},title:{display:true,text:'Year',color:'#8b949e',font:{size:11}}},
        y:{grid:{color:'#151a22'},ticks:{font:{size:11},callback:function(v){return fmt(v);}}}},
    },
  });
}

function renderYDShippingRates(productKey, canvasId) {
  var cy=new Date().getFullYear(), avgs=[], colors=[];
  for(var m=0;m<12;m++){var v=DATA.master.filter(function(r){return r.year===cy&&r.month===m&&r[productKey]!=null;}).map(function(r){return r[productKey];});avgs.push(v.length?mean(v):null);}
  for(var m=0;m<12;m++){var prev=m===0?null:avgs[m-1],curr=avgs[m];if(curr==null)colors.push('#484f58');else if(prev==null)colors.push(PRODUCTS[productKey].color);else colors.push(curr>=prev?'#3fb950':'#f85149');}
  destroyChart(canvasId);
  var canvas=document.getElementById(canvasId); if(!canvas)return;
  chartRegistry[canvasId]=new Chart(canvas.getContext('2d'),{
    type:'bar', data:{labels:MONTH_NAMES,datasets:[{label:PRODUCTS[productKey].label+' '+cy,data:avgs,backgroundColor:colors,borderRadius:4}]},
    options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false},tooltip:{callbacks:{label:function(c){return ' '+fmt(c.parsed.y);}}}},
      scales:{x:{grid:{color:'#151a22'},ticks:{font:{size:11}}},y:{grid:{color:'#151a22'},ticks:{font:{size:11},callback:function(v){return fmt(v);}}}}},
  });
}

function renderYDRatesOverlay(canvasId) {
  var cy=new Date().getFullYear(), yrs=4, ops=['ff','bb','77','44'], datasets=[], maxDays=0;
  PRODUCT_KEYS.forEach(function(key){
    for(var yo=0;yo<yrs;yo++){
      var y=cy-yo, rows=DATA.byYear[y]||[];
      if(rows.length>maxDays)maxDays=rows.length;
      datasets.push({label:PRODUCTS[key].label.split(' ')[0]+' '+y,
        data:rows.map(function(r){return r[key]!=null?r[key]:null;}),
        borderColor:PRODUCTS[key].color+ops[yo],backgroundColor:'transparent',
        borderWidth:yo===0?2:1,pointRadius:0,tension:0.1,spanGaps:true});
    }
  });
  var labels=[]; for(var i=1;i<=maxDays;i++)labels.push(i);
  destroyChart(canvasId);
  var canvas=document.getElementById(canvasId); if(!canvas)return;
  chartRegistry[canvasId]=new Chart(canvas.getContext('2d'),{
    type:'line', data:{labels:labels,datasets:datasets},
    options:{responsive:true,maintainAspectRatio:false,interaction:{mode:'index',intersect:false},
      plugins:{legend:{position:'top',labels:{usePointStyle:true,font:{size:9},boxWidth:10,padding:6}},
        tooltip:{callbacks:{title:function(c){return 'Day '+c[0].label;},label:function(c){return ' '+c.dataset.label+': '+fmt(c.parsed.y);}}}},
      scales:{x:{grid:{color:'#151a22'},ticks:{maxTicksLimit:13,font:{size:10}},title:{display:true,text:'Trading Day',color:'#8b949e',font:{size:11}}},
        y:{grid:{color:'#151a22'},ticks:{font:{size:10},callback:function(v){return fmt(v);}}}},
    },
  });
}

function renderYDDrawdown(productKey, canvasId) {
  var rows=getRows(productKey);
  if(!rows.length)return;
  var cut5=new Date(); cut5.setFullYear(cut5.getFullYear()-5);
  var filtered=rows.filter(function(r){return r.date>=cut5;}), labels=[], ddData=[];
  for(var i=0;i<filtered.length;i++){
    var cur=filtered[i], c365=new Date(cur.date); c365.setDate(c365.getDate()-365);
    var maxVal=cur[productKey];
    for(var j=rows.length-1;j>=0;j--){if(rows[j].date>cur.date)continue;if(rows[j].date<c365)break;if(rows[j][productKey]>maxVal)maxVal=rows[j][productKey];}
    ddData.push(maxVal>0?((cur[productKey]-maxVal)/maxVal)*100:0);
    labels.push(cur.date.toISOString().split('T')[0]);
  }
  destroyChart(canvasId);
  var canvas=document.getElementById(canvasId); if(!canvas)return;
  chartRegistry[canvasId]=new Chart(canvas.getContext('2d'),{
    type:'line',
    data:{labels:labels,datasets:[{label:'Drawdown %',data:ddData,borderColor:'#f85149',backgroundColor:'rgba(248,81,73,0.3)',borderWidth:1.5,pointRadius:0,fill:true,tension:0.1}]},
    options:{responsive:true,maintainAspectRatio:false,interaction:{mode:'index',intersect:false},
      plugins:{legend:{display:false},tooltip:{callbacks:{label:function(c){return ' Drawdown: '+c.parsed.y.toFixed(2)+'%';}}}},
      scales:{x:{grid:{color:'#151a22'},ticks:{maxTicksLimit:8,font:{size:11},callback:function(_,i){return labels[i]?labels[i].slice(0,7):'';}  }},
        y:{grid:{color:'#151a22'},max:0,ticks:{font:{size:11},callback:function(v){return v.toFixed(1)+'%';}},title:{display:true,text:'Drawdown %',color:'#8b949e',font:{size:11}}}},
    },
  });
}

// =====================================================================
// MONTHLY DASHBOARD TAB
// =====================================================================
function renderMonthlyDash(productKey) {
  renderMDBarChart(productKey);
  renderMDTrendChart(productKey);
  renderMDAreaComp(productKey);
  renderMDDataGrid(productKey);
}

function renderMDBarChart(productKey) {
  var now=new Date(), labels=[], data=[], colors=[], prevAvg=null;
  for(var i=11;i>=0;i--){
    var d=new Date(now.getFullYear(),now.getMonth()-i,1), y=d.getFullYear(), m=d.getMonth();
    var vals=DATA.master.filter(function(r){return r.year===y&&r.month===m&&r[productKey]!=null;}).map(function(r){return r[productKey];});
    var avg=vals.length?mean(vals):null;
    labels.push(MONTH_NAMES[m]+' '+y); data.push(avg);
    if(avg==null)colors.push('#484f58'); else if(prevAvg==null)colors.push(PRODUCTS[productKey].color); else colors.push(avg>=prevAvg?'#3fb950':'#f85149');
    if(avg!=null)prevAvg=avg;
  }
  destroyChart('monthlyBarChart');
  var canvas=document.getElementById('monthlyBarChart'); if(!canvas)return;
  chartRegistry['monthlyBarChart']=new Chart(canvas.getContext('2d'),{
    type:'bar', data:{labels:labels,datasets:[{label:PRODUCTS[productKey].label,data:data,backgroundColor:colors,borderRadius:4}]},
    options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false},tooltip:{callbacks:{label:function(c){return ' '+fmt(c.parsed.y);}}}},
      scales:{x:{grid:{color:'#151a22'},ticks:{font:{size:10},maxRotation:45}},y:{grid:{color:'#151a22'},ticks:{font:{size:11},callback:function(v){return fmt(v);}}}}},
  });
}

function renderMDTrendChart(productKey) {
  var cut3=new Date(); cut3.setFullYear(cut3.getFullYear()-3);
  var seen={}, syears=[];
  DATA.master.forEach(function(r){if(r.date>=cut3&&r[productKey]!=null&&!seen[r.year]){seen[r.year]=1;syears.push(r.year);}});
  syears.sort(function(a,b){return a-b;});
  var labels=[], data=[];
  syears.forEach(function(y){for(var m=0;m<12;m++){var vals=DATA.master.filter(function(r){return r.year===y&&r.month===m&&r[productKey]!=null&&r.date>=cut3;}).map(function(r){return r[productKey];});if(vals.length){labels.push(MONTH_NAMES[m]+' '+y);data.push(mean(vals));}}});
  var prod=PRODUCTS[productKey];
  destroyChart('monthlyTrendChart');
  var canvas=document.getElementById('monthlyTrendChart'); if(!canvas)return;
  chartRegistry['monthlyTrendChart']=new Chart(canvas.getContext('2d'),{
    type:'line', data:{labels:labels,datasets:[{label:prod.label,data:data,borderColor:prod.color,backgroundColor:prod.color+'33',borderWidth:2,pointRadius:2,fill:true,tension:0.2,spanGaps:true}]},
    options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false},tooltip:{callbacks:{label:function(c){return ' '+fmt(c.parsed.y);}}}},
      scales:{x:{grid:{color:'#151a22'},ticks:{font:{size:10},maxRotation:45,maxTicksLimit:18}},y:{grid:{color:'#151a22'},ticks:{font:{size:11},callback:function(v){return fmt(v);}}}}},
  });
}

function renderMDAreaComp(productKey) {
  var cy=new Date().getFullYear(), py=cy-1, prod=PRODUCTS[productKey];
  var curData=MONTH_NAMES.map(function(_,m){var v=DATA.master.filter(function(r){return r.year===cy&&r.month===m&&r[productKey]!=null;}).map(function(r){return r[productKey];});return v.length?mean(v):null;});
  var prevData=MONTH_NAMES.map(function(_,m){var v=DATA.master.filter(function(r){return r.year===py&&r.month===m&&r[productKey]!=null;}).map(function(r){return r[productKey];});return v.length?mean(v):null;});
  destroyChart('monthlyAreaCompChart');
  var canvas=document.getElementById('monthlyAreaCompChart'); if(!canvas)return;
  chartRegistry['monthlyAreaCompChart']=new Chart(canvas.getContext('2d'),{
    type:'line', data:{labels:MONTH_NAMES,datasets:[
      {label:String(cy), data:curData, borderColor:prod.color,backgroundColor:prod.color+'33',borderWidth:2.5,pointRadius:3,fill:true,tension:0.2,spanGaps:true},
      {label:String(py), data:prevData,borderColor:'#8b949e',backgroundColor:'rgba(139,148,158,0.15)',borderWidth:1.5,pointRadius:2,fill:true,tension:0.2,spanGaps:true},
    ]},
    options:{responsive:true,maintainAspectRatio:false,interaction:{mode:'index',intersect:false},
      plugins:{legend:{position:'top',labels:{usePointStyle:true}},tooltip:{callbacks:{label:function(c){return ' '+c.dataset.label+': '+fmt(c.parsed.y);}}}},
      scales:{x:{grid:{color:'#151a22'},ticks:{font:{size:11}}},y:{grid:{color:'#151a22'},ticks:{font:{size:11},callback:function(v){return fmt(v);}}}}},
  });
}

function renderMDDataGrid(productKey) {
  var cy=new Date().getFullYear(), years5=[cy,cy-1,cy-2,cy-3,cy-4];
  var seen={}, allYears=[];
  DATA.master.forEach(function(r){if(!seen[r.year]){seen[r.year]=1;allYears.push(r.year);}});
  allYears.sort(function(a,b){return a-b;});
  var matrix={};
  allYears.forEach(function(y){matrix[y]={};for(var m=0;m<12;m++){var v=DATA.master.filter(function(r){return r.year===y&&r.month===m&&r[productKey]!=null;}).map(function(r){return r[productKey];});matrix[y][m]=v.length?mean(v):null;}});
  var colStats={};
  for(var m=0;m<12;m++){var v=allYears.map(function(y){return matrix[y][m];}).filter(function(v){return v!=null;});colStats[m]={min:Math.min.apply(null,v),max:Math.max.apply(null,v)};}
  var avg5y={};
  for(var m=0;m<12;m++){var v=years5.map(function(y){return matrix[y]?matrix[y][m]:null;}).filter(function(v){return v!=null;});avg5y[m]=v.length?mean(v):null;}
  var ly=years5[0];
  var html='<table class="heatmap-table"><thead><tr><th>Year</th>'+MONTH_NAMES.map(function(mn){return '<th>'+mn+'</th>';}).join('')+'<th>YTD Avg</th></tr></thead><tbody>';
  years5.forEach(function(y){
    var rv=[]; for(var m=0;m<12;m++)rv.push(matrix[y]?matrix[y][m]:null);
    var nn=rv.filter(function(v){return v!=null;}), ytd=nn.length?mean(nn):null;
    html+='<tr><td class="year-col">'+y+'</td>';
    for(var m=0;m<12;m++){var v=rv[m];if(v==null){html+='<td style="color:#484f58">&mdash;</td>';continue;}var cs=colStats[m],r2=cs.max>cs.min?(v-cs.min)/(cs.max-cs.min):0.5;html+='<td style="background:'+heatmapColorAbs(r2)+';color:#e6edf3">'+fmt(v,0)+'</td>';}
    html+='<td style="color:var(--text-muted)">'+(ytd!=null?fmt(ytd,0):'&mdash;')+'</td></tr>';
  });
  // 5Y avg row
  html+='<tr><td class="year-col" style="color:var(--accent);font-weight:700">5Y Avg</td>';
  var a5all=[];
  for(var m=0;m<12;m++){var v=avg5y[m];a5all.push(v);if(v==null){html+='<td style="color:#484f58">&mdash;</td>';continue;}var cs=colStats[m],r2=cs.max>cs.min?(v-cs.min)/(cs.max-cs.min):0.5;html+='<td style="background:'+heatmapColorAbs(r2)+';color:#e6edf3;font-weight:600">'+fmt(v,0)+'</td>';}
  var a5avg=mean(a5all.filter(function(v){return v!=null;}));
  html+='<td style="color:var(--accent);font-weight:600">'+(a5avg!=null?fmt(a5avg,0):'&mdash;')+'</td></tr>';
  // MoM % row
  html+='<tr><td class="year-col" style="color:var(--text-muted)">MoM %</td>';
  for(var m=0;m<12;m++){
    var curr=matrix[ly]?matrix[ly][m]:null, prev=m>0?(matrix[ly]?matrix[ly][m-1]:null):(matrix[ly-1]?matrix[ly-1][11]:null);
    if(curr==null||prev==null){html+='<td style="color:#484f58">&mdash;</td>';continue;}
    var pct=((curr-prev)/prev)*100;
    html+='<td style="background:'+heatmapColorPct(pct)+';color:#e6edf3;font-size:11px">'+(pct>=0?'+':'')+pct.toFixed(1)+'%</td>';
  }
  html+='<td>&mdash;</td></tr></tbody></table>';
  document.getElementById('monthlyDataGrid').innerHTML=html;
  document.getElementById('monthlyGridDlBtn').onclick=function(){
    var headers=['Year'].concat(MONTH_NAMES).concat(['YTD Avg']);
    var rows=years5.map(function(y){var rv=[];for(var m=0;m<12;m++)rv.push(matrix[y]?matrix[y][m]:null);var nn=rv.filter(function(v){return v!=null;});var ytd=nn.length?mean(nn):null;return [y].concat(rv.map(function(v){return v!=null?v.toFixed(2):''})).concat([ytd!=null?ytd.toFixed(2):'']);});
    downloadCSV('monthly_grid_'+productKey+'.csv',headers,rows);
  };
}

// =====================================================================
// QUARTERLY DASHBOARD TAB
// =====================================================================
function renderQuarterlyDash(productKey) {
  renderQDAreaComp1(productKey);
  renderQDTrend(productKey);
  renderQDBarChart(productKey);
  renderQDAreaComp2(productKey);
  renderQDDataGrid(productKey);
}

function getQAvgPD(productKey, year, quarter) {
  return getQAvgCached(productKey, year, quarter);
}

function renderQDAreaComp1(productKey) {
  var cy=new Date().getFullYear(), py=cy-1, prod=PRODUCTS[productKey], qs=['Q1','Q2','Q3','Q4'];
  var curData=qs.map(function(q){return getQAvgPD(productKey,cy,q);}), prevData=qs.map(function(q){return getQAvgPD(productKey,py,q);});
  destroyChart('quarterlyAreaComp1Chart');
  var canvas=document.getElementById('quarterlyAreaComp1Chart'); if(!canvas)return;
  chartRegistry['quarterlyAreaComp1Chart']=new Chart(canvas.getContext('2d'),{
    type:'line', data:{labels:qs,datasets:[
      {label:String(cy), data:curData, borderColor:prod.color,backgroundColor:prod.color+'33',borderWidth:2.5,pointRadius:5,fill:true,tension:0.2,spanGaps:true},
      {label:String(py), data:prevData,borderColor:'#8b949e',backgroundColor:'rgba(139,148,158,0.15)',borderWidth:1.5,pointRadius:4,fill:true,tension:0.2,spanGaps:true},
    ]},
    options:{responsive:true,maintainAspectRatio:false,interaction:{mode:'index',intersect:false},
      plugins:{legend:{position:'top',labels:{usePointStyle:true}},tooltip:{callbacks:{label:function(c){return ' '+c.dataset.label+': '+fmt(c.parsed.y);}}}},
      scales:{x:{grid:{color:'#151a22'},ticks:{font:{size:12}}},y:{grid:{color:'#151a22'},ticks:{font:{size:11},callback:function(v){return fmt(v);}}}}},
  });
}

function renderQDTrend(productKey) {
  var cy=new Date().getFullYear(), years5=[cy-4,cy-3,cy-2,cy-1,cy], qs=['Q1','Q2','Q3','Q4'], labels=[], data=[];
  years5.forEach(function(y){qs.forEach(function(q){labels.push(q+' '+y);data.push(getQAvgPD(productKey,y,q));});});
  var prod=PRODUCTS[productKey];
  destroyChart('quarterlyTrendChart');
  var canvas=document.getElementById('quarterlyTrendChart'); if(!canvas)return;
  chartRegistry['quarterlyTrendChart']=new Chart(canvas.getContext('2d'),{
    type:'line', data:{labels:labels,datasets:[{label:prod.label,data:data,borderColor:prod.color,backgroundColor:prod.color+'33',borderWidth:2,pointRadius:3,fill:true,tension:0.2,spanGaps:true}]},
    options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false},tooltip:{callbacks:{label:function(c){return ' '+fmt(c.parsed.y);}}}},
      scales:{x:{grid:{color:'#151a22'},ticks:{font:{size:10},maxRotation:45}},y:{grid:{color:'#151a22'},ticks:{font:{size:11},callback:function(v){return fmt(v);}}}}},
  });
}

function renderQDBarChart(productKey) {
  var now=new Date(), qs=['Q1','Q2','Q3','Q4'], qIdx=qs.indexOf(getQuarter(now.getMonth())), y=now.getFullYear(), quarters=[];
  for(var i=0;i<4;i++){qIdx--;if(qIdx<0){qIdx=3;y--;}quarters.unshift({year:y,q:qs[qIdx]});}
  var labels=quarters.map(function(x){return x.q+' '+x.year;}), data=quarters.map(function(x){return getQAvgPD(productKey,x.year,x.q);});
  var colors=data.map(function(v,i){if(v==null||i===0)return PRODUCTS[productKey].color;var p=data[i-1];return p==null?PRODUCTS[productKey].color:(v>=p?'#3fb950':'#f85149');});
  destroyChart('quarterlyBarChart');
  var canvas=document.getElementById('quarterlyBarChart'); if(!canvas)return;
  chartRegistry['quarterlyBarChart']=new Chart(canvas.getContext('2d'),{
    type:'bar', data:{labels:labels,datasets:[{label:PRODUCTS[productKey].label,data:data,backgroundColor:colors,borderRadius:4}]},
    options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false},tooltip:{callbacks:{label:function(c){return ' '+fmt(c.parsed.y);}}}},
      scales:{x:{grid:{color:'#151a22'},ticks:{font:{size:12}}},y:{grid:{color:'#151a22'},ticks:{font:{size:11},callback:function(v){return fmt(v);}}}}},
  });
}

function renderQDAreaComp2(productKey) {
  var cy=new Date().getFullYear(), qs=['Q1','Q2','Q3','Q4'], years5=[cy,cy-1,cy-2,cy-3,cy-4], prod=PRODUCTS[productKey];
  var seasonal=qs.map(function(q){var v=years5.map(function(y){return getQAvgPD(productKey,y,q);}).filter(function(v){return v!=null;});return v.length?mean(v):null;});
  var curData=qs.map(function(q){return getQAvgPD(productKey,cy,q);});
  destroyChart('quarterlyAreaComp2Chart');
  var canvas=document.getElementById('quarterlyAreaComp2Chart'); if(!canvas)return;
  chartRegistry['quarterlyAreaComp2Chart']=new Chart(canvas.getContext('2d'),{
    type:'line', data:{labels:qs,datasets:[
      {label:String(cy),          data:curData, borderColor:prod.color,backgroundColor:prod.color+'33',borderWidth:2.5,pointRadius:5,fill:true,tension:0.2,spanGaps:true},
      {label:'5Y Seasonal Avg',   data:seasonal,borderColor:'#e3b341',backgroundColor:'rgba(227,179,65,0.15)',borderWidth:1.5,borderDash:[5,3],pointRadius:4,fill:true,tension:0.2,spanGaps:true},
    ]},
    options:{responsive:true,maintainAspectRatio:false,interaction:{mode:'index',intersect:false},
      plugins:{legend:{position:'top',labels:{usePointStyle:true}},tooltip:{callbacks:{label:function(c){return ' '+c.dataset.label+': '+fmt(c.parsed.y);}}}},
      scales:{x:{grid:{color:'#151a22'},ticks:{font:{size:12}}},y:{grid:{color:'#151a22'},ticks:{font:{size:11},callback:function(v){return fmt(v);}}}}},
  });
}

function renderQDDataGrid(productKey) {
  var cy=new Date().getFullYear(), years8=[cy,cy-1,cy-2,cy-3,cy-4,cy-5,cy-6,cy-7], qs=['Q1','Q2','Q3','Q4'];
  var seen={}, allYears=[];
  DATA.master.forEach(function(r){if(!seen[r.year]){seen[r.year]=1;allYears.push(r.year);}});
  allYears.sort(function(a,b){return a-b;});
  var matrix={};
  allYears.forEach(function(y){matrix[y]={};qs.forEach(function(q){matrix[y][q]=getQAvgPD(productKey,y,q);});});
  var colStats={};
  qs.forEach(function(q){var v=allYears.map(function(y){return matrix[y][q];}).filter(function(v){return v!=null;});colStats[q]={min:Math.min.apply(null,v),max:Math.max.apply(null,v)};});
  var html='<table class="heatmap-table"><thead><tr><th>Year</th>'+qs.map(function(q){return '<th>'+q+'</th>';}).join('')+'<th>Full Year Avg</th><th>YoY %</th></tr></thead><tbody>';
  years8.forEach(function(y,i){
    var qv=qs.map(function(q){return matrix[y]?matrix[y][q]:null;}), nn=qv.filter(function(v){return v!=null;}), fy=nn.length?mean(nn):null;
    var py2=years8[i+1], pv=py2!=null?qs.map(function(q){return matrix[py2]?matrix[py2][q]:null;}).filter(function(v){return v!=null;}):[], pfy=pv.length?mean(pv):null;
    var yoy=fy!=null&&pfy!=null&&pfy!==0?((fy-pfy)/pfy)*100:null;
    html+='<tr><td class="year-col">'+y+'</td>';
    qs.forEach(function(q){var v=matrix[y]?matrix[y][q]:null;if(v==null){html+='<td style="color:#484f58">&mdash;</td>';return;}var cs=colStats[q],r2=cs.max>cs.min?(v-cs.min)/(cs.max-cs.min):0.5;html+='<td style="background:'+heatmapColorAbs(r2)+';color:#e6edf3">'+fmt(v,0)+'</td>';});
    html+='<td style="color:var(--text-muted)">'+(fy!=null?fmt(fy,0):'&mdash;')+'</td>';
    html+='<td class="'+(yoy==null?'':yoy>=0?'val-green':'val-red')+'" style="font-weight:600">'+(yoy!=null?(yoy>=0?'+':'')+yoy.toFixed(1)+'%':'&mdash;')+'</td></tr>';
  });
  html+='</tbody></table>';
  document.getElementById('quarterlyDashDataGrid').innerHTML=html;
  document.getElementById('quarterlyDashGridDlBtn').onclick=function(){
    var headers=['Year'].concat(qs).concat(['Full Year Avg','YoY %']);
    var rows=years8.map(function(y,i){
      var qv=qs.map(function(q){return matrix[y]?matrix[y][q]:null;}), nn=qv.filter(function(v){return v!=null;}), fy=nn.length?mean(nn):null;
      var py2=years8[i+1], pv=py2!=null?qs.map(function(q){return matrix[py2]?matrix[py2][q]:null;}).filter(function(v){return v!=null;}):[], pfy=pv.length?mean(pv):null;
      var yoy=fy!=null&&pfy!=null&&pfy!==0?((fy-pfy)/pfy*100).toFixed(1)+'%':'';
      return [y].concat(qv.map(function(v){return v!=null?v.toFixed(2):''})).concat([fy!=null?fy.toFixed(2):'',yoy]);
    });
    downloadCSV('quarterly_dash_'+productKey+'.csv',headers,rows);
  };
}

</script>
</body>
</html>
